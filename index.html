<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Vibe OS 30.0 - Final</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- SYSTEM VARIABLES --- */
        :root { 
            --primary: #00e676; 
            --danger: #ff3d00; 
            --gold: #ffd600; 
            --bg: #000000; 
            --surface: #111111; 
            --surface-light: #1c1c1e; 
            --text: #ffffff; 
            --radius: 20px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding-bottom: 140px; user-select: none; }
        
        /* HEADER */
        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; backdrop-filter: blur(10px); }
        .brand { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
        .nav-icons { display: flex; gap: 15px; }
        .icon-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--surface-light); display: flex; align-items: center; justify-content: center; border: 1px solid #333; cursor: pointer; position: relative; font-size: 18px; }
        .badge { position: absolute; top: -2px; right: -2px; background: var(--primary); color: black; font-size: 10px; font-weight: 900; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* DASHBOARD */
        .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 20px; }
        .bento-card { background: var(--surface); padding: 15px; border-radius: var(--radius); border: 1px solid #222; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; }
        .bento-card.wide { grid-column: span 2; background: linear-gradient(135deg, #1a1a1a, #0a0a0a); }
        .bento-val { font-size: 28px; font-weight: 800; margin-top: 5px; }
        .bento-lbl { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 700; }

        /* FILTERS (FULL STACK) */
        .filter-sec { padding: 0 20px 40px 20px; }
        .sec-head { font-size: 11px; color: #666; font-weight: 800; text-transform: uppercase; margin: 20px 0 10px 0; }
        .acc { margin-bottom: 8px; background: var(--surface); border-radius: 14px; overflow: hidden; border: 1px solid #222; }
        .acc-head { padding: 15px; font-size: 13px; font-weight: 700; display: flex; justify-content: space-between; border-right: 4px solid transparent; cursor: pointer; }
        .acc-body { display: none; padding: 15px; background: #080808; flex-wrap: wrap; gap: 8px; border-top: 1px solid #222; }
        .acc-body.open { display: flex; }
        
        .c-red .acc-head { border-color: var(--danger); }
        .c-blue .acc-head { border-color: var(--primary); }
        .c-gold .acc-head { border-color: var(--gold); }
        .c-purple .acc-head { border-color: #d500f9; }

        .chip { display: none; }
        .lbl { padding: 6px 14px; background: #1a1a1a; border: 1px solid #333; border-radius: 50px; font-size: 12px; color: #888; transition: 0.2s; cursor: pointer; }
        .chip:checked + .lbl { background: #eee; color: #000; font-weight: 800; border-color: #fff; }
        .danger .chip:checked + .lbl { background: var(--danger); color: white; border-color: var(--danger); }
        .safe .chip:checked + .lbl { background: var(--primary); color: black; border-color: var(--primary); }

        /* TOAST NOTIFICATION (NEW) */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(30,30,30,0.95); color: white; padding: 12px 25px; border-radius: 50px; font-size: 14px; font-weight: bold; z-index: 1000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid #444; backdrop-filter: blur(10px); display: flex; align-items: center; gap: 10px; width: max-content; }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* SCANNER OVERLAY */
        #scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .scan-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 40px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .scan-frame { width: 260px; height: 260px; border: 2px solid rgba(255,255,255,0.3); border-radius: 24px; margin: auto; box-shadow: 0 0 0 1000px rgba(0,0,0,0.85); position: relative; }
        .scan-frame::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--primary); animation: scan 2s infinite; box-shadow: 0 0 15px var(--primary); }
        @keyframes scan { 0% {top:0;opacity:0} 50% {opacity:1} 100% {top:100%;opacity:0} }
        .close-cam { pointer-events: auto; background: rgba(50,50,50,0.8); color: white; padding: 12px 30px; border-radius: 50px; border: none; margin: 0 auto; font-weight: bold; backdrop-filter: blur(10px); cursor: pointer; }

        /* MODALS (Settings, Cart, History) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 600; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .modal.open { transform: translateY(0); }
        .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; background: #111; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; }
        .clean-inp { width: 100%; background: var(--surface-light); border: 1px solid #333; color: white; padding: 15px; border-radius: 12px; font-size: 16px; margin-bottom: 10px; text-align: center; }
        .sec-title { color: var(--primary); font-size: 11px; font-weight: 800; margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; text-transform: uppercase; }

        /* ACTION BAR */
        .action-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(20,20,20,0.95); padding: 8px; border-radius: 100px; display: flex; justify-content: space-between; border: 1px solid #333; z-index: 300; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .bar-btn { width: 50px; height: 50px; border: none; background: transparent; font-size: 20px; cursor: pointer; color: #888; display: flex; align-items: center; justify-content: center; }
        .scan-btn { width: 65px; height: 65px; background: white; border-radius: 22px; margin-top: -20px; border: none; box-shadow: 0 5px 20px rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; color: black; }
        .svg-icon { width: 24px; height: 24px; fill: currentColor; }

        /* RESULTS SHEET */
        #sheet-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; pointer-events: none; opacity: 0; transition: 0.3s; }
        .active-sheet { opacity: 1 !important; pointer-events: auto !important; }
        #bottom-sheet { position: absolute; bottom: 0; width: 100%; background: #161616; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-top: 1px solid #333; max-height: 85vh; overflow-y: auto; }
        .active-sheet #bottom-sheet { transform: translateY(0); }

        .editable-name { background: transparent; border: none; border-bottom: 1px dashed #555; color: white; font-size: 18px; font-weight: 800; width: 100%; font-family: inherit; margin-bottom: 5px; padding: 0; border-radius: 0; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .sheet-btn { padding: 15px; border-radius: 12px; border: 1px solid #333; font-weight: 700; cursor: pointer; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 5px; background: #222; color: white; }
        .sheet-btn.primary { background: rgba(0,230,118,0.15); border-color: var(--primary); color: var(--primary); grid-column: span 2; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="header">
        <div class="brand">Vibe OS <span style="font-size:10px; opacity:0.5;">30.0</span></div>
        <div class="nav-icons">
            <div class="icon-btn" onclick="openModal('history-modal')">ğŸ•’</div>
            <div class="icon-btn" onclick="openModal('settings-modal')">âš™ï¸</div>
            <div class="icon-btn" onclick="openModal('cart-modal')">ğŸ›’ <div class="badge" id="badge">0</div></div>
        </div>
    </div>

    <div class="bento-grid">
        <div class="bento-card wide"><div class="bento-lbl">×ª×§×¦×™×‘ ×§×œ×•×¨×™ ×™×•××™</div><div class="bento-val" id="d-cals">...</div></div>
        <div class="bento-card"><div class="bento-lbl">××˜×¨×”</div><div class="bento-val" id="d-goal">...</div></div>
        <div class="bento-card"><div class="bento-lbl">×‘×¡×œ ×”×§× ×™×•×ª</div><div class="bento-val" id="d-cart">0</div></div>
    </div>

    <div class="filter-sec">
        <div class="sec-head">×”×’×“×¨×•×ª ×¡×™× ×•×Ÿ ××œ××•×ª</div>
        
        <div class="acc c-red">
            <div class="acc-head" onclick="tog(this)">âš ï¸ ××œ×¨×’×™×•×ª (×¦×™×•×Ÿ 0) <span>â–¾</span></div>
            <div class="acc-body danger">
                <input type="checkbox" id="a-milk" class="chip save"><label for="a-milk" class="lbl">ğŸ¥› ×—×œ×‘</label>
                <input type="checkbox" id="a-gluten" class="chip save"><label for="a-gluten" class="lbl">ğŸ ×’×œ×•×˜×Ÿ</label>
                <input type="checkbox" id="a-nuts" class="chip save"><label for="a-nuts" class="lbl">ğŸŒ° ××’×•×–×™×</label>
                <input type="checkbox" id="a-peanuts" class="chip save"><label for="a-peanuts" class="lbl">ğŸ¥œ ×‘×•×˜× ×™×</label>
                <input type="checkbox" id="a-soy" class="chip save"><label for="a-soy" class="lbl">ğŸ¥¢ ×¡×•×™×”</label>
                <input type="checkbox" id="a-sesame" class="chip save"><label for="a-sesame" class="lbl">ğŸ¥¯ ×©×•××©×•×</label>
                <input type="checkbox" id="a-eggs" class="chip save"><label for="a-eggs" class="lbl">ğŸ¥š ×‘×™×¦×™×</label>
                <input type="checkbox" id="a-fish" class="chip save"><label for="a-fish" class="lbl">ğŸŸ ×“×’×™×</label>
                <input type="checkbox" id="a-sulfites" class="chip save"><label for="a-sulfites" class="lbl">ğŸ· ×¡×•×œ×¤×™×˜×™×</label>
            </div>
        </div>

        <div class="acc c-red">
            <div class="acc-head" onclick="tog(this)">ğŸ¥ ×¨×¤×•××™ ×•××—×œ×•×ª <span>â–¾</span></div>
            <div class="acc-body danger">
                <input type="checkbox" id="d-diabetic" class="chip save"><label for="d-diabetic" class="lbl">ğŸ’‰ ×¡×•×›×¨×ª</label>
                <input type="checkbox" id="d-heart" class="chip save"><label for="d-heart" class="lbl">ğŸ«€ ×œ×‘/×œ×—×¥ ×“×</label>
                <input type="checkbox" id="d-celiac" class="chip save"><label for="d-celiac" class="lbl">ğŸŒ¾ ×¦×œ×™××§</label>
                <input type="checkbox" id="d-gout" class="chip save"><label for="d-gout" class="lbl">ğŸ¦¶ ×’××•×˜</label>
                <input type="checkbox" id="d-kidney" class="chip save"><label for="d-kidney" class="lbl">ğŸ©º ×›×œ×™×•×ª</label>
                <input type="checkbox" id="d-reflux" class="chip save"><label for="d-reflux" class="lbl">ğŸ”¥ ×¦×¨×‘×ª</label>
                <input type="checkbox" id="d-anemia" class="chip save"><label for="d-anemia" class="lbl">ğŸ©¸ ×× ××™×”</label>
            </div>
        </div>

        <div class="acc c-purple">
            <div class="acc-head" onclick="tog(this)">ğŸ‘¶ ×¨×’×™×©×•×™×•×ª ××™×•×—×“×•×ª <span>â–¾</span></div>
            <div class="acc-body danger">
                <input type="checkbox" id="x-preg" class="chip save"><label for="x-preg" class="lbl">ğŸ¤° ×”×¨×™×•×Ÿ</label>
                <input type="checkbox" id="x-baby" class="chip save"><label for="x-baby" class="lbl">ğŸ¼ ×ª×™× ×•×§×•×ª</label>
                <input type="checkbox" id="x-elderly" class="chip save"><label for="x-elderly" class="lbl">ğŸ‘´ ×’×™×œ ×©×œ×™×©×™</label>
            </div>
        </div>

        <div class="acc c-blue">
            <div class="acc-head" onclick="tog(this)">âš¡ ×¡×¤×•×¨×˜ ×•×‘×™×¦×•×¢×™× <span>â–¾</span></div>
            <div class="acc-body safe">
                <input type="checkbox" id="p-protein" class="chip save"><label for="p-protein" class="lbl">ğŸ’ª ×—×œ×‘×•×Ÿ ×’×‘×•×”</label>
                <input type="checkbox" id="p-bulk" class="chip save"><label for="p-bulk" class="lbl">ğŸ¦ ××¡×”</label>
                <input type="checkbox" id="p-cut" class="chip save"><label for="p-cut" class="lbl">âœ‚ï¸ ×—×™×˜×•×‘</label>
                <input type="checkbox" id="p-energy" class="chip save"><label for="p-energy" class="lbl">ğŸ”‹ ×× ×¨×’×™×”</label>
            </div>
        </div>

        <div class="acc c-gold">
            <div class="acc-head" onclick="tog(this)">âœ¡ï¸ ×“×ª ×•×›×©×¨×•×ª <span>â–¾</span></div>
            <div class="acc-body safe">
                <input type="checkbox" id="k-kosher" class="chip save"><label for="k-kosher" class="lbl">ğŸ“œ ×›×©×¨</label>
                <input type="checkbox" id="k-badatz" class="chip save"><label for="k-badatz" class="lbl">âœ¨ ×‘×“"×¥</label>
                <input type="checkbox" id="k-parve" class="chip save"><label for="k-parve" class="lbl">ğŸ ×¤×¨×•×•×”</label>
                <input type="checkbox" id="k-halal" class="chip save"><label for="k-halal" class="lbl">â˜ªï¸ ×—×œ××œ</label>
                <input type="checkbox" id="k-passover" class="chip save"><label for="k-passover" class="lbl">ğŸš« ×œ×¤×¡×—</label>
            </div>
        </div>

        <div class="acc c-blue">
            <div class="acc-head" onclick="tog(this)">ğŸ¥— ×¢×¨×›×™× ×•×¡×’× ×•×Ÿ ×—×™×™× <span>â–¾</span></div>
            <div class="acc-body safe">
                <input type="checkbox" id="b-israel" class="chip save" checked><label for="b-israel" class="lbl">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</label>
                <input type="checkbox" id="l-vegan" class="chip save"><label for="l-vegan" class="lbl">ğŸŒ± ×˜×‘×¢×•× ×™</label>
                <input type="checkbox" id="l-keto" class="chip save"><label for="l-keto" class="lbl">ğŸ¥‘ ×§×˜×•</label>
                <input type="checkbox" id="l-paleo" class="chip save"><label for="l-paleo" class="lbl">ğŸ– ×¤×œ×™××•</label>
                <input type="checkbox" id="c-clean" class="chip save"><label for="c-clean" class="lbl">ğŸ§ª ×ª×•×•×™×ª × ×§×™×™×”</label>
                <input type="checkbox" id="c-sugar" class="chip save"><label for="c-sugar" class="lbl">ğŸ­ ×œ×œ× ×¡×•×›×¨</label>
            </div>
        </div>
    </div>

    <div id="scanner-overlay">
        <div id="reader"></div>
        <div class="scan-ui">
            <div style="text-align:center; color:white; font-weight:800; font-size:18px;">×¡×¨×™×§×ª ×‘×¨×§×•×“</div>
            <div class="scan-frame"></div>
            <button class="close-cam" onclick="stopCamera()">×¡×’×•×¨ ××¦×œ××”</button>
        </div>
    </div>

    <div class="action-bar">
        <button class="bar-btn" onclick="manualSearch()">âŒ¨ï¸</button>
        <button class="scan-trigger" onclick="startCamera()">
            <svg class="svg-scan" viewBox="0 0 24 24"><path d="M17 3H21C21.5523 3 22 3.44772 22 4V8C22 8.55228 21.5523 9 21 9C20.4477 9 20 8.55228 20 8V5H17C16.4477 5 16 4.55228 16 4C16 3.44772 16.4477 3 17 3ZM7 3H3C2.44772 3 2 3.44772 2 4V8C2 8.55228 2.44772 9 3 9C3.55228 9 4 8.55228 4 8V5H7C7.55228 5 8 4.55228 8 4C8 3.44772 7.55228 3 7 3ZM17 21H21C21.5523 21 22 20.5523 22 20V16C22 15.4477 21.5523 15 21 15C20.4477 15 20 15.4477 20 16V19H17C16.4477 19 16 19.4477 16 20C16 20.5523 16.4477 21 17 21ZM7 21H3C2.44772 21 2 20.5523 2 20V16C2 15.4477 2.44772 15 3 15C3.55228 15 4 15.4477 4 16V19H7C7.55228 19 8 19.4477 8 20C8 20.5523 7.55228 21 7 21ZM2 12C2 11.4477 2.44772 11 3 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H3C2.44772 13 2 12.5523 2 12Z"/></svg>
        </button>
        <button class="bar-btn" onclick="openModal('history-modal')">ğŸ•’</button>
    </div>

    <div id="sheet-wrapper">
        <div id="sheet-overlay-bg" onclick="closeSheet()"></div>
        <div id="bottom-sheet">
            <div style="width:40px; height:4px; background:#333; margin:0 auto 20px auto; border-radius:10px;"></div>
            <div class="prod-header">
                <img id="p-img" class="prod-thumb" src="" onerror="this.style.display='none'">
                <div style="flex: 1;">
                    <div id="p-brand" style="font-size:11px; color:#888; font-weight:700;"></div>
                    <input type="text" id="p-name" class="editable-name" value="...">
                    <div style="font-size:10px; color:#666;">âœ ×œ×—×¥ ×œ×ª×™×§×•×Ÿ/×ª×¨×’×•× ×©× ×”××•×¦×¨</div>
                </div>
                <div id="p-score" class="score-circle">--</div>
            </div>
            <div id="bio-res" style="background:#222; padding:15px; border-radius:12px; margin:15px 0; font-size:13px; line-height:1.5;"></div>
            <div id="filter-res" style="margin-top:10px;"></div>
            <div class="action-grid">
                <button class="sheet-btn" onclick="comparePrecise()">
                    <span>ğŸ” ×”×©×•×•××” ××“×•×™×§×ª</span><span style="font-size:9px; opacity:0.6;">×œ×¤×™ ×‘×¨×§×•×“ / ×©×</span>
                </button>
                <button class="sheet-btn" onclick="findAlternatives()">
                    <span>ğŸ’¡ ×—×œ×•×¤×•×ª ×–×•×œ×•×ª</span><span style="font-size:9px; opacity:0.6;">×œ×¤×™ ×§×˜×’×•×¨×™×”</span>
                </button>
                <button class="sheet-btn primary" onclick="addToCart()">ğŸ›’ ×”×•×¡×£ ×œ×¡×œ</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-header"><h2>×”×’×“×¨×•×ª ×¤×¨×•×¤×™×œ</h2><button onclick="closeModal('settings-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
        <div class="modal-body">
            <div class="sec-title">× ×ª×•× ×™× ×¤×™×–×™×™×</div>
            <div style="display:flex;gap:10px;"><input type="number" id="u-w" class="clean-inp" placeholder="××©×§×œ"><input type="number" id="u-h" class="clean-inp" placeholder="×’×•×‘×”"></div>
            <input type="number" id="u-age" class="clean-inp" placeholder="×’×™×œ">
            <div class="sec-title">××ª×§×“×</div>
            <div style="display:flex;gap:10px;"><input type="number" id="u-fat" class="clean-inp" placeholder="% ×©×•××Ÿ"><input type="number" id="u-visceral" class="clean-inp" placeholder="×©×•××Ÿ ×‘×˜× ×™"></div>
            <input type="number" id="u-meta" class="clean-inp" placeholder="×’×™×œ ××˜×‘×•×œ×™">
            <div class="sec-title">××˜×¨×”</div>
            <select id="u-target" class="clean-inp"><option value="maintain">×©××™×¨×”</option><option value="cut">×—×™×˜×•×‘</option><option value="bulk">××¡×”</option></select>
            <select id="u-activity" class="clean-inp"><option value="1.2">×™×•×©×‘× ×™</option><option value="1.375">×¤×¢×™×œ ×§×œ</option><option value="1.55">×¤×¢×™×œ ×‘×™× ×•× ×™</option><option value="1.725">×¤×¢×™×œ ×××•×“</option></select>
            <select id="u-gender" class="clean-inp"><option value="male">×’×‘×¨</option><option value="female">××™×©×”</option></select>
            <button onclick="saveProfile()" class="clean-inp" style="background:white;color:black;font-weight:bold;margin-top:20px;">×©××•×¨ ×•×—×©×‘ ××—×“×©</button>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-header"><h2>×¡×œ ×”×§× ×™×•×ª</h2><button onclick="closeModal('cart-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
        <div class="modal-body" id="cart-list"></div>
        <div style="padding:20px;border-top:1px solid #333;"><button onclick="shareCart()" class="clean-inp" style="background:var(--primary);color:black;font-weight:bold;">×©×ª×£ ×œ×•×•××˜×¡××¤ ğŸ“¤</button></div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-header"><h2>×”×™×¡×˜×•×¨×™×™×ª ×¡×¨×™×§×•×ª</h2><button onclick="closeModal('history-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
        <div class="modal-body" id="history-list"></div>
        <div style="padding:20px;border-top:1px solid #333;"><button onclick="clearHistory()" class="clean-inp" style="background:var(--danger);color:white;font-weight:bold;">× ×§×” ×”×™×¡×˜×•×¨×™×” ğŸ—‘ï¸</button></div>
    </div>

    <script>
        // --- VIBE OS 30.0 FINAL LOGIC ---
        
        let user={w:75,h:175,age:30,gender:'male',target:'maintain',activity:1.2,metaAge:30,visceral:5,fat:18,tdee:2000};
        let cart=JSON.parse(localStorage.getItem('vibeCart'))||[];
        let history=JSON.parse(localStorage.getItem('vibeHistory'))||[];
        let currentItem={name:'',code:'',brand:'',category:''};

        // EXTENDED DICTIONARY
        const dict={
            'milk':'×—×œ×‘','chocolate':'×©×•×§×•×œ×“','coffee':'×§×¤×”','sugar':'×¡×•×›×¨','cheese':'×’×‘×™× ×”','pasta':'×¤×¡×˜×”','rice':'××•×¨×–','bread':'×œ×—×','yogurt':'×™×•×’×•×¨×˜','butter':'×—×××”','oil':'×©××Ÿ','olive':'×–×™×ª','tomato':'×¢×’×‘× ×™×•×ª','sauce':'×¨×•×˜×‘','hummus':'×—×•××•×¡','instant':'× ××¡','beans':'×©×¢×•×¢×™×ª','corn':'×ª×™×¨×¡','tuna':'×˜×•× ×”','water':'××™×','tea':'×ª×”','biscuits':'×‘×™×¡×§×•×•×™×˜×™×','cake':'×¢×•×’×”','flour':'×§××—','salt':'××œ×—','drink':'××©×§×”','soft':'×§×œ','chips':'×—×˜×™×£','snack':'×—×˜×™×£','apple':'×ª×¤×•×—','banana':'×‘× × ×”','orange':'×ª×¤×•×–','juice':'××™×¥','egg':'×‘×™×¦×™×','meat':'×‘×©×¨','chicken':'×¢×•×£','beef':'×‘×§×¨','fish':'×“×’','salmon':'×¡×œ××•×Ÿ','honey':'×“×‘×©','lemon':'×œ×™××•×Ÿ','bar':'×—×˜×™×£ ×× ×¨×’×™×”','protein':'×—×œ×‘×•×Ÿ','spread':'×××¨×—','low fat':'×“×œ ×©×•××Ÿ','no sugar':'×œ×œ× ×¡×•×›×¨','whole wheat':'×—×™×˜×” ××œ××”','cereals':'×“×’× ×™×','soup':'××¨×§','frozen':'×§×¤×•×'
        };

        window.onload=()=>{
            loadUser(); renderCart(); renderHistory();
            document.querySelectorAll('.save').forEach(el=>{
                if(localStorage.getItem(el.id)==='true') el.checked=true;
                el.addEventListener('change',()=>localStorage.setItem(el.id,el.checked));
            });
        };

        function showToast(msg){
            const t=document.getElementById('toast');
            t.innerHTML=`<span>âœ…</span> ${msg}`;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'),2500);
        }

        // UI & NAVIGATION
        function tog(head){ head.nextElementSibling.classList.toggle('open'); }
        function openModal(id){ document.getElementById(id).classList.add('open'); }
        function closeModal(id){ document.getElementById(id).classList.remove('open'); }
        function closeSheet(){ document.getElementById('sheet-wrapper').classList.remove('active-sheet'); }
        const chk=(id)=>document.getElementById(id).checked;

        // USER STATE
        function loadUser(){
            const u=localStorage.getItem('vibe30_user');
            if(u) user=JSON.parse(u);
            updateDash();
        }
        function saveProfile(){
            const v=(id)=>document.getElementById(id).value;
            if(v('u-w')) user.w=Number(v('u-w'));
            if(v('u-h')) user.h=Number(v('u-h'));
            if(v('u-age')) user.age=Number(v('u-age'));
            if(v('u-fat')) user.fat=Number(v('u-fat'));
            if(v('u-visceral')) user.visceral=Number(v('u-visceral'));
            if(v('u-meta')) user.metaAge=Number(v('u-meta'));
            user.gender=v('u-gender');
            user.target=v('u-target');
            user.activity=Number(v('u-activity'));
            
            let bmr=10*user.w+6.25*user.h-5*user.age+(user.gender==='male'?5:-161);
            user.tdee=Math.round(bmr*user.activity);
            if(user.metaAge<user.age) user.tdee+=100;
            if(user.target==='cut') user.tdee-=500;
            if(user.target==='bulk') user.tdee+=300;
            
            localStorage.setItem('vibe30_user',JSON.stringify(user));
            updateDash();
            closeModal('settings-modal');
            showToast('×”×¤×¨×•×¤×™×œ ×¢×•×“×›×Ÿ');
        }
        function updateDash(){
            document.getElementById('d-cals').innerText=user.tdee;
            const m={cut:'×—×™×˜×•×‘',maintain:'×©××™×¨×”',bulk:'××¡×”'};
            document.getElementById('d-goal').innerText=m[user.target];
        }

        // CART LOGIC
        function renderCart(){
            const l=document.getElementById('cart-list'); l.innerHTML="";
            cart.forEach((item,i)=>{
                l.innerHTML+=`<div class="list-item"><div><div style="font-weight:bold;font-size:16px;">${item.name}</div><div style="font-size:12px;color:#888;">${item.brand||''}</div></div><div class="cart-del" onclick="removeFromCart(${i})">ğŸ—‘ï¸</div></div>`;
            });
            document.getElementById('badge').innerText=cart.length;
            document.getElementById('d-cart').innerText=cart.length;
            localStorage.setItem('vibeCart',JSON.stringify(cart));
        }
        function addToCart(){
            const n=document.getElementById('p-name').value;
            cart.push({name:n,brand:currentItem.brand});
            renderCart(); closeSheet(); showToast(`${n} × ×•×¡×£ ×œ×¡×œ`);
        }
        function removeFromCart(i){ cart.splice(i,1); renderCart(); }
        function shareCart(){
            const t="×¨×©×™××ª ×§× ×™×•×ª Vibe OS:%0A"+cart.map(i=>"- "+i.name).join("%0A");
            window.open(`https://wa.me/?text=${t}`,'_blank');
        }

        // HISTORY LOGIC
        function addToHistory(item){
            history.unshift(item);
            if(history.length>20) history.pop();
            localStorage.setItem('vibeHistory',JSON.stringify(history));
            renderHistory();
        }
        function renderHistory(){
            const l=document.getElementById('history-list'); l.innerHTML="";
            history.forEach(item=>{
                l.innerHTML+=`<div class="list-item" onclick="analyze('${item.code}')"><div><div style="font-weight:bold;font-size:16px;">${item.name}</div><div style="font-size:12px;color:#888;">${item.date}</div></div><div style="font-size:18px; font-weight:bold; color:${item.score>50?'var(--primary)':'var(--danger)'}">${item.score}%</div></div>`;
            });
        }
        function clearHistory(){ history=[]; localStorage.removeItem('vibeHistory'); renderHistory(); showToast('×”×”×™×¡×˜×•×¨×™×” × ×•×§×ª×”'); }

        // CAMERA ENGINE
        const html5QrCode = new Html5Qrcode("reader");
        function startCamera(){
            document.getElementById('scanner-overlay').style.display='block';
            html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},(txt)=>{
                stopCamera(); analyze(txt);
            }).catch(()=>{alert("××™×Ÿ ×’×™×©×” ×œ××¦×œ××”"); stopCamera();});
        }
        function stopCamera(){
            html5QrCode.stop().then(()=>document.getElementById('scanner-overlay').style.display='none')
                       .catch(()=>document.getElementById('scanner-overlay').style.display='none');
        }
        function manualSearch(){ const c=prompt("×”×§×œ×“ ×‘×¨×§×•×“:"); if(c) analyze(c); }

        // --- BRAIN: ANALYSIS ---
        async function analyze(code){
            document.getElementById('sheet-wrapper').classList.add('active-sheet');
            document.getElementById('p-name').value="×˜×•×¢×Ÿ × ×ª×•× ×™×...";
            document.getElementById('p-score').innerText="--";
            
            try {
                const res=await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
                const data=await res.json();
                if(data.status!==1) throw new Error();
                
                const p=data.product;
                let name=p.product_name_he||p.product_name||"";
                
                // Translate
                if(!p.product_name_he){
                    name=name.toLowerCase().split(' ').map(w=>dict[w]||w).join(' ');
                    name=name.charAt(0).toUpperCase()+name.slice(1);
                }

                currentItem={name:name,code:code,brand:p.brands||"",category:p.categories?p.categories.split(',')[0]:name};
                document.getElementById('p-name').value=name;
                document.getElementById('p-brand').innerText=p.brands||"";
                document.getElementById('p-img').src=p.image_front_small_url||"";

                // LOGIC
                const n=p.nutriments||{};
                const txt=(p.ingredients_text||"")+(p.labels||"")+(p.categories||"");
                const low=txt.toLowerCase();
                const tags=(p._keywords||[]).join(" ").toLowerCase();
                const add=(p.additives_tags||[]).join(" ");
                
                let score=100, flags=[];

                const crit=(id,keys,msg)=>{ if(chk(id)){ for(let k of keys) if(low.includes(k)||tags.includes(k)){ score=0; flags.push(msg); return; } } };

                // 60+ FILTERS
                crit('a-milk',['milk','lait','×—×œ×‘','whey'],'â›” ×—×œ×‘');
                crit('a-gluten',['gluten','wheat','×—×™×˜×”','barley','rye'],'â›” ×’×œ×•×˜×Ÿ');
                crit('a-nuts',['nut','almond','××’×•×–','cashew','pecan'],'â›” ××’×•×–×™×');
                crit('a-peanuts',['peanut','×‘×•×˜× ×™×'],'â›” ×‘×•×˜× ×™×');
                crit('a-soy',['soy','×¡×•×™×”'],'â›” ×¡×•×™×”');
                crit('a-sesame',['sesame','×©×•××©×•×'],'â›” ×©×•××©×•×');
                crit('a-eggs',['egg','oeuf','×‘×™×¦×™×'],'â›” ×‘×™×¦×™×');
                crit('a-fish',['fish','×“×’'],'â›” ×“×’×™×');
                crit('a-sulfites',['sulfite','e220','e224'],'â›” ×¡×•×œ×¤×™×˜×™×');

                if(chk('d-diabetic')&&(n.sugars_100g>5||n.carbohydrates_100g>50)) {score-=50; flags.push("âš ï¸ ×¡×•×›×¨/×¤×—××™××” ×’×‘×•×”×”");}
                if(chk('d-heart')&&(n.salt_100g>1||n['saturated-fat_100g']>4)) {score-=40; flags.push("âš ï¸ × ×ª×¨×Ÿ/×©×•××Ÿ ×¨×•×•×™ ×’×‘×•×”");}
                if(chk('d-celiac')&&(low.includes('wheat')||low.includes('gluten'))) {score=0; flags.push("â›” ×—×©×© ×’×œ×•×˜×Ÿ");}
                if(chk('d-gout')&&(low.includes('liver')||low.includes('yeast'))) {score=0; flags.push("â›” ×¤×•×¨×™× ×™× ×’×‘×•×”×™×");}
                if(chk('d-kidney')&&n.potassium_100g>0.3) {score-=40; flags.push("âš ï¸ ××©×œ×’×Ÿ ×’×‘×•×”");}
                if(chk('d-reflux')&&(low.includes('spice')||low.includes('tomato')||low.includes('citrus'))) {score-=30; flags.push("âš ï¸ ×—×•××¦×™×•×ª/×—×¨×™×¤×•×ª");}
                if(chk('d-anemia')&&(low.includes('tea')||low.includes('caffeine'))) {score-=10; flags.push("âš ï¸ ××¢×›×‘ ×¡×¤×™×’×ª ×‘×¨×–×œ");}
                
                if(chk('x-preg')&&(low.includes('caffeine')||low.includes('alcohol'))) {score=0; flags.push("â›” ×§×¤××™×Ÿ/××œ×›×•×”×•×œ");}
                if(chk('x-baby')&&(n.sugars_100g>2||n.salt_100g>0.5)) {score=0; flags.push("â›” ×œ× ×œ×ª×™× ×•×§×•×ª");}
                if(chk('x-elderly')&&(low.includes('hard')||low.includes('nut'))) {score-=20; flags.push("âš ï¸ ××¨×§× ×§×©×”");}
                
                if(chk('k-parve')&&(low.includes('milk')||low.includes('meat'))) {score=0; flags.push("â›” ×œ× ×¤×¨×•×•×”");}
                if(chk('k-halal')&&(low.includes('pork')||low.includes('alcohol'))) {score=0; flags.push("â›” ×—×¨××");}
                if(chk('l-vegan')&&(low.includes('milk')||low.includes('egg')||low.includes('honey')||low.includes('meat'))) {score=0; flags.push("â›” ×œ× ×˜×‘×¢×•× ×™");}
                if(chk('l-paleo')&&(low.includes('sugar')||low.includes('grain'))) {score=0; flags.push("â›” ×œ× ×¤×œ×™××•");}
                if(chk('l-keto')&&n.carbohydrates_100g>10) {score=0; flags.push("â›” ×¤×—××™××” ×’×‘×•×”×”");}
                
                if(chk('c-clean')&&(add.includes('e2')||add.includes('e6')||add.includes('e1'))) {score-=20; flags.push("ğŸ§ª ×ª×•×¡×¤×™× ××œ××›×•×ª×™×™×");}
                if(chk('k-kosher')&&!low.includes('kosher')&&!low.includes('×›×©×¨')) {score-=10; flags.push("âš ï¸ ××™×Ÿ ×¡×™××•×Ÿ ×›×©×¨×•×ª");}
                
                const cal=n['energy-kcal_100g']||0;
                if(user.target==='cut'&&cal>280) {score-=30; flags.push(`ğŸ“‰ ×¦×¤×•×£ ×§×œ×•×¨×™×ª (${cal})`);}
                if(user.visceral>9&&n['saturated-fat_100g']>3) {score-=25; flags.push("ğŸ©¸ ×©×•××Ÿ ×‘×˜× ×™ ×’×‘×•×”");}
                if(user.target==='bulk'&&n.proteins_100g>10) {score+=10; flags.push("ğŸ’ª ×¢×©×™×¨ ×‘×—×œ×‘×•×Ÿ");}

                if(chk('b-israel')) { if(!code.startsWith('729')) {score-=10; flags.push("ğŸŒ ×™×‘×•×");} else {score+=5;} }

                if(score<0) score=0; if(score>100) score=100;

                // UI UPDATE
                const el=document.getElementById('p-score'); el.innerText=score+"%";
                el.style.borderColor = score>70?'var(--primary)':(score>40?'var(--gold)':'var(--danger)');
                el.style.color = el.style.borderColor;
                
                document.getElementById('bio-res').innerHTML = `<div style="display:flex; justify-content:space-between; font-weight:700;"><span>${cal} ×§×§"×œ</span><span>${n.proteins_100g||0}g ×—×œ×‘×•×Ÿ</span></div><div style="color:#888; margin-top:5px;">××”×•×•×” ${Math.round((cal/user.tdee)*100)}% ××”×ª×§×¦×™×‘ ×”×™×•××™</div>`;
                
                let h="";
                if(flags.length) h+=flags.map(f=>`<div style="color:#ff5555; margin-top:5px;">${f}</div>`).join('');
                else h=`<div style="color:#00e676; margin-top:5px;">âœ¨ ××•×¦×¨ ×ª×•×× ××•×©×œ×</div>`;
                document.getElementById('filter-res').innerHTML=h;

                addToHistory({name:name, code:code, score:score, date:new Date().toLocaleDateString()});

            } catch(e) {
                document.getElementById('p-name').value="×œ× × ××¦× - ×”×§×œ×“ ×©×";
                currentItem.code=code;
                document.getElementById('bio-res').innerText="×œ× × ××¦××• × ×ª×•× ×™×.";
                document.getElementById('p-score').innerText="?";
            }
        }

        // --- COMPARISON ---
        function comparePrecise(){
            const name = document.getElementById('p-name').value;
            let query = "";
            if(currentItem.code && name === currentItem.name) query = currentItem.code;
            else query = `${name} ××—×™×¨ site:.il`;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
        }
        function findAlternatives(){
            const name = document.getElementById('p-name').value;
            let generic = name.replace(currentItem.brand, '').trim();
            if(generic.length < 3) generic = name; 
            window.open(`https://www.google.com/search?q=${encodeURIComponent(generic+" ×”×©×•×•××ª ××—×™×¨×™×")}`, '_blank');
        }

    </script>
</body>
</html>
