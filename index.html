<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Vibe OS TITAN ULTRA</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* ==========================================================================
           1. CORE VARIABLES & DESIGN TOKENS
           ========================================================================== */
        :root {
            /* --- COLOR PALETTE: PLASMA NEON --- */
            --bg-deep: #020617;
            --bg-surface: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-glass: rgba(255, 255, 255, 0.03);
            
            /* Plasma Gradients */
            --plasma-1: #6366f1; /* Indigo */
            --plasma-2: #8b5cf6; /* Violet */
            --plasma-3: #06b6d4; /* Cyan */
            --grad-main: linear-gradient(135deg, var(--plasma-1), var(--plasma-3));
            --grad-text: linear-gradient(90deg, #fff, var(--plasma-3));

            /* --- GRADING SPECTRUM (A+ to E) --- */
            --g-ap: #39ff14; /* NEON GREEN */
            --g-a: #22c55e;
            --g-bp: #ccff00; /* LIME */
            --g-b: #a3e635;
            --g-c: #facc15;
            --g-d: #fb923c;
            --g-e: #ff0000; /* PURE RED */

            /* --- CATEGORY IDENTIFIERS --- */
            --cat-qual: #06b6d4;
            --cat-med: #f43f5e;
            --cat-diet: #3b82f6;
            --cat-kosh: #eab308;
            --cat-eth: #10b981;
            --cat-sens: #ff66cc;
            --cat-bad: #a855f7;

            /* --- LAYOUT --- */
            --max-w: 460px;
            --radius: 36px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* ==========================================================================
           2. GLOBAL RESET & BOOT
           ========================================================================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            margin: 0; height: 100vh; background: #000; color: #fff; font-family: var(--font);
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        /* NEBULA BACKGROUND ANIMATION */
        .nebula { position: fixed; inset: 0; z-index: -1; background: #020617; overflow: hidden; }
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; animation: float 10s infinite alternate; }
        .orb-1 { width: 400px; height: 400px; background: var(--plasma-1); top: -10%; left: -10%; }
        .orb-2 { width: 300px; height: 300px; background: var(--plasma-3); bottom: -10%; right: -10%; animation-delay: -5s; }
        @keyframes float { 0%{transform:translate(0,0);} 100%{transform:translate(30px,30px);} }

        /* BOOT SCREEN */
        #boot-screen {
            position: fixed; inset: 0; background: #020617; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.6s ease;
        }
        .boot-logo { font-size: 48px; font-weight: 900; letter-spacing: 4px; background: var(--grad-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: pulse 2s infinite; }
        .boot-bar { width: 150px; height: 4px; background: #1e293b; margin-top: 30px; border-radius: 2px; overflow: hidden; }
        .boot-fill { width: 0%; height: 100%; background: var(--plasma-3); animation: load 2.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes load { 0%{width:0%} 100%{width:100%} }
        @keyframes pulse { 0%,100%{opacity:1; filter:blur(0);} 50%{opacity:0.6; filter:blur(2px);} }

        /* ==========================================================================
           3. APP FRAME & HEADER
           ========================================================================== */
        #app-frame {
            width: 100%; max-width: var(--max-w); height: 100%; max-height: 95vh;
            background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(40px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius);
            box-shadow: 0 0 0 12px #000, 0 30px 80px rgba(99, 102, 241, 0.2);
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            opacity: 0; transform: scale(0.95); transition: 0.6s ease;
        }
        #app-frame.active { opacity: 1; transform: scale(1); }
        
        @media (max-width: 480px) { #app-frame { max-width: 100%; height: 100vh; max-height: 100vh; border-radius: 0; box-shadow: none; border:none; } }

        .header {
            padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.08); background: rgba(2,6,23,0.9); z-index: 50;
        }
        .brand { font-size: 22px; font-weight: 800; letter-spacing: 2px; }
        .brand span { background: var(--grad-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .btn-icon {
            width: 42px; height: 42px; border-radius: 12px; background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .btn-icon:active { background: rgba(255,255,255,0.15); }

        #content { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 140px; scrollbar-width: none; }
        #content::-webkit-scrollbar { display: none; }

        /* ==========================================================================
           4. DASHBOARD COMPONENTS
           ========================================================================== */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 20px 24px; }
        
        .card {
            background: var(--bg-card); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px;
            padding: 18px; display: flex; flex-direction: column; justify-content: space-between;
            min-height: 110px; position: relative; overflow: hidden; transition: 0.2s; cursor: pointer;
        }
        .card:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        
        /* User Card */
        .card.hero { 
            grid-column: 1 / -1; flex-direction: row; align-items: center;
            background: linear-gradient(160deg, rgba(30,41,59,0.8), rgba(2,6,23,0.9));
            border-left: 4px solid var(--plasma-1);
        }
        
        /* Cart Score Card */
        .card.score { grid-column: 1 / -1; min-height: 120px; border-right: 4px solid var(--g-ap); }
        
        .c-label { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .c-value { font-size: 26px; font-weight: 800; color: #fff; margin-top: 4px; }
        .c-meta { font-size: 12px; color: var(--plasma-3); margin-top: 4px; }

        /* Visual Gauge */
        .gauge-track { width: 100%; height: 8px; background: rgba(0,0,0,0.4); border-radius: 4px; margin-top: 10px; overflow: hidden; position: relative; }
        .gauge-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--g-e), var(--g-c), var(--g-a), var(--g-ap)); transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); }
        
        /* Grade Badge in Cart Card */
        .grade-badge-lg {
            position: absolute; top: 15px; left: 15px; width: 50px; height: 50px;
            border-radius: 50%; border: 2px solid; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 900; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Quick Actions */
        .quick-row { padding: 0 24px; display: flex; gap: 10px; margin-top: 10px; }
        .quick-inp { flex: 1; background: var(--bg-glass); border: 1px solid rgba(255,255,255,0.1); padding: 16px; border-radius: 16px; color: #fff; text-align: right; font-size: 16px; }
        .quick-btn { width: 56px; background: var(--plasma-1); border: none; border-radius: 16px; font-size: 28px; color: #fff; cursor: pointer; }

        .tags-row { padding: 15px 24px; display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { font-size: 10px; padding: 4px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #cbd5e1; }

        /* ==========================================================================
           5. DOCK & SCANNER (THE EYE)
           ========================================================================== */
        .dock-wrap { position: absolute; bottom: 35px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 500; pointer-events: none; }
        .dock {
            pointer-events: auto; width: 90%; max-width: 380px; height: 74px;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 26px;
            display: flex; justify-content: space-between; align-items: center; padding: 0 45px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        
        .dock-item { font-size: 26px; color: #64748b; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .dock-item span { font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .dock-item:active { color: #fff; transform: scale(0.9); }

        .scan-wrap { position: relative; margin-top: -50px; }
        .scan-fab {
            width: 72px; height: 72px; border-radius: 24px;
            background: var(--grad-main);
            border: 6px solid #020617; /* Seamless blend */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.5);
            cursor: pointer; transition: 0.2s; transform: rotate(45deg);
        }
        /* CSS Barcode Icon inside FAB */
        .scan-icon { width: 30px; height: 30px; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; gap: 3px; }
        .bar { background: #fff; width: 3px; border-radius: 2px; }
        .bar:nth-child(1) { height: 20px; } .bar:nth-child(2) { height: 28px; width: 4px; }
        .bar:nth-child(3) { height: 16px; } .bar:nth-child(4) { height: 24px; width: 2px; }
        .scan-fab:active { transform: rotate(45deg) scale(0.95); box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3); }

        /* ==========================================================================
           6. MODALS & SHEETS
           ========================================================================== */
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: flex-end; opacity: 0; transition: opacity 0.3s; }
        .overlay.active { display: flex; opacity: 1; }
        
        .sheet {
            width: 100%; background: #0f172a; border-radius: 40px 40px 0 0;
            border-top: 1px solid rgba(255,255,255,0.15); max-height: 92vh;
            display: flex; flex-direction: column; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .overlay.active .sheet { transform: translateY(0); }

        .sh-head { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; background: #0f172a; border-radius: 40px 40px 0 0; z-index: 10; }
        .sh-title { font-size: 20px; font-weight: 800; }
        .sh-body { padding: 24px; overflow-y: auto; flex: 1; padding-bottom: 140px; }
        .sh-foot { padding: 24px; background: #0f172a; border-top: 1px solid rgba(255,255,255,0.05); position: absolute; bottom: 0; width: 100%; z-index: 20; }

        /* ==========================================================================
           7. SETTINGS ACCORDIONS (60+ ITEMS)
           ========================================================================== */
        .acc { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; margin-bottom: 10px; overflow: hidden; }
        .acc-h { padding: 18px; font-weight: 700; display: flex; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .acc-h:hover { background: rgba(255,255,255,0.05); }
        .acc-b { display: none; padding: 20px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05); gap: 10px; flex-wrap: wrap; }
        .acc.open .acc-b { display: flex; }

        /* Category Theme Colors */
        .t-qual .acc-h { color: var(--cat-qual); border-right: 4px solid var(--cat-qual); }
        .t-red .acc-h { color: var(--g-e); border-right: 4px solid var(--g-e); }
        .t-blue .acc-h { color: var(--cat-diet); border-right: 4px solid var(--cat-diet); }
        .t-gold .acc-h { color: var(--cat-kosh); border-right: 4px solid var(--cat-kosh); }
        .t-green .acc-h { color: var(--cat-eth); border-right: 4px solid var(--cat-eth); }
        .t-pink .acc-h { color: var(--cat-sens); border-right: 4px solid var(--cat-sens); }
        .t-purp .acc-h { color: var(--cat-bad); border-right: 4px solid var(--cat-bad); }

        .chk { display: none; }
        .chk-lbl { padding: 10px 14px; background: rgba(255,255,255,0.05); border-radius: 10px; font-size: 13px; color: #94a3b8; cursor: pointer; border: 1px solid transparent; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .chk:checked + .chk-lbl { background: rgba(99, 102, 241, 0.2); border-color: var(--plasma-1); color: #fff; transform: scale(1.02); }
        
        /* Danger/Good Context Colors */
        .c-bad:checked + .chk-lbl { background: rgba(239, 68, 68, 0.2); border-color: var(--g-e); color: #fff; }
        .c-good:checked + .chk-lbl { background: rgba(34, 197, 94, 0.2); border-color: var(--g-a); color: #fff; }

        /* ==========================================================================
           8. COMPONENTS (RESULT, HISTORY, SCANNER)
           ========================================================================== */
        /* Result */
        .grade-orb { width: 140px; height: 140px; border-radius: 50%; border: 12px solid; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 64px; font-weight: 900; box-shadow: 0 0 80px currentColor; color: #fff; }
        .res-alert { padding: 14px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px; font-size: 13px; display: flex; align-items: center; gap: 10px; font-weight: 600; }

        /* Buttons */
        .btn { width: 100%; padding: 18px; border-radius: 16px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-pri { background: var(--grad-main); color: #fff; box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4); }
        .btn-sec { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; margin-top: 10px; }

        /* Lists */
        .l-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .g-badge { font-size: 12px; font-weight: 900; padding: 4px 8px; border-radius: 6px; color: #000; width: 35px; text-align: center; }

        /* Scanner */
        #scan-ui { position: absolute; inset: 0; background: #000; z-index: 3000; display: none; flex-direction: column; }
        #scan-ui.active { display: flex; }
        #reader { flex: 1; width: 100%; object-fit: cover; filter: contrast(1.1) brightness(1.1); }
        .hud { position: absolute; inset: 0; pointer-events: none; display: flex; justify-content: center; align-items: center; background: linear-gradient(rgba(0,0,0,0.5), transparent 20%, transparent 80%, rgba(0,0,0,0.5)); }
        .reticle { width: 280px; height: 280px; border: 2px solid rgba(255,255,255,0.4); border-radius: 40px; position: relative; box-shadow: 0 0 0 1000px rgba(0,0,0,0.8); }
        .laser { position: absolute; top: 50%; left: 5%; right: 5%; height: 2px; background: var(--g-e); box-shadow: 0 0 20px var(--g-e); animation: scan 1.5s infinite ease-in-out; }
        @keyframes scan { 0%{top:10%} 50%{top:90%} 100%{top:10%} }

        #toast { position: absolute; top: 40px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #1e293b; color: #fff; padding: 12px 30px; border-radius: 50px; z-index: 5000; border: 1px solid var(--plasma-1); font-weight: 700; transition: 0.4s; white-space: nowrap; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        #toast.vis { transform: translateX(-50%) translateY(0); }

    </style>
</head>
<body>

<div class="nebula"><div class="orb orb-1"></div><div class="orb orb-2"></div></div>

<div id="boot-screen">
    <div class="boot-logo">VIBE OS</div>
    <div class="boot-bar"><div class="boot-fill"></div></div>
    <div style="margin-top:15px; font-size:10px; color:#64748b; letter-spacing:2px;">SYSTEM INITIALIZED</div>
</div>

<div id="app-frame">
    <div class="header">
        <div class="brand">VIBE <span>OS</span></div>
        <div class="btn-icon" onclick="openModal('settings')">âš™ï¸</div>
    </div>

    <div id="content">
        <div class="grid">
            <div class="card full" onclick="openModal('settings')">
                <div>
                    <div class="c-label">××©×ª××© ×¤×¢×™×œ</div>
                    <div id="d-name" class="c-value" style="font-size:22px;">××•×¨×—</div>
                </div>
                <div style="text-align:left;">
                    <div class="c-label">×”×’×“×¨×•×ª</div>
                    <div id="d-filters" style="font-size:12px; color:var(--plasma-2);">0 ×¤×¢×™×œ×•×ª</div>
                </div>
            </div>

            <div class="card" onclick="openModal('ring')">
                <div class="c-label">××“×“ ×’×•×¤× ×™</div>
                <div id="d-ring" class="c-value" style="color:var(--g-a);">×ª×§×™×Ÿ</div>
                <div class="c-meta">Vibe Ring</div>
            </div>

            <div class="card score" onclick="openModal('cart')">
                <div id="cart-badge" class="grade-badge-lg" style="color:var(--g-a); border-color:var(--g-a);">A</div>
                <div style="text-align:right; margin-left: auto;">
                    <div class="c-label">××™×›×•×ª ×”×¡×œ</div>
                    <div id="d-score" class="c-value">100%</div>
                    <div class="gauge-track"><div id="d-bar" class="gauge-fill" style="width:100%;"></div></div>
                    <div class="c-meta" style="margin-top:8px;"><span id="d-count">0</span> ×¤×¨×™×˜×™×</div>
                </div>
            </div>
        </div>

        <div class="section-title" style="padding:0 24px; font-size:12px; font-weight:700; color:#64748b; margin-bottom:10px;">×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</div>
        <div class="quick-row">
            <input type="text" id="q-inp" class="quick-inp" placeholder="×”×§×œ×“ ×©× ××•×¦×¨...">
            <button class="quick-btn" onclick="Core.manualAdd()">+</button>
        </div>
        
        <div id="active-tags" class="tags-row"></div>
    </div>

    <div class="dock-wrap">
        <div class="dock">
            <div class="dock-item" onclick="openModal('cart')">ğŸ›’<span>×¢×’×œ×”</span></div>
            <div class="scan-wrap">
                <div class="scan-fab" onclick="Scanner.start()">
                    <div class="scan-icon"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                </div>
            </div>
            <div class="dock-item" onclick="openModal('hist')">ğŸ“œ<span>×”×™×¡×˜×•×¨×™×”</span></div>
        </div>
    </div>

    <div id="toast">×”×•×“×¢×ª ××¢×¨×›×ª</div>

    <div id="m-settings" class="overlay"><div class="sheet">
        <div class="sh-head"><div class="sh-title">×¤×¨×•×¤×™×œ ××™×©×™</div><div class="btn-icon" onclick="closeModal('settings')">âœ•</div></div>
        <div class="sh-body">
            <input type="text" id="inp-name" placeholder="×©× ××œ×" style="width:100%; padding:16px; background:var(--bg-glass); border:none; border-radius:12px; color:#fff; margin-bottom:20px;">
            
            <div class="acc t-qual"><div class="acc-h" onclick="tog(this)">ğŸ… ×“×™×¨×•×’ ××™×›×•×ª (×—×•×‘×”) <span>â–¼</span></div><div class="acc-b">
                <input type="checkbox" id="q-aplus" class="chk c-good"><label for="q-aplus" class="chk-lbl">A+ ×‘×œ×‘×“</label>
                <input type="checkbox" id="q-green" class="chk c-good"><label for="q-green" class="chk-lbl">âœ… ×ª×• ×™×¨×•×§</label>
                <input type="checkbox" id="q-natural" class="chk c-good"><label for="q-natural" class="chk-lbl">ğŸƒ 100% ×˜×‘×¢×™</label>
                <input type="checkbox" id="q-nored" class="chk c-good"><label for="q-nored" class="chk-lbl">ğŸš« ×œ×œ× ××“×•×</label>
            </div></div>

            <div class="acc t-red"><div class="acc-h" onclick="tog(this)">âš ï¸ ××œ×¨×’×™×•×ª (×§×¨×™×˜×™) <span>â–¼</span></div><div class="acc-b">
                <input type="checkbox" id="a-milk" class="chk c-bad"><label for="a-milk" class="chk-lbl">×—×œ×‘</label>
                <input type="checkbox" id="a-gluten" class="chk c-bad"><label for="a-gluten" class="chk-lbl">×’×œ×•×˜×Ÿ</label>
                <input type="checkbox" id="a-nuts" class="chk c-bad"><label for="a-nuts" class="chk-lbl">××’×•×–×™×</label>
                <input type="checkbox" id="a-peanuts" class="chk c-bad"><label for="a-peanuts" class="chk-lbl">×‘×•×˜× ×™×</label>
                <input type="checkbox" id="a-sesame" class="chk c-bad"><label for="a-sesame" class="chk-lbl">×©×•××©×•×</label>
                <input type="checkbox" id="a-soy" class="chk c-bad"><label for="a-soy" class="chk-lbl">×¡×•×™×”</label>
                <input type="checkbox" id="a-eggs" class="chk c-bad"><label for="a-eggs" class="chk-lbl">×‘×™×¦×™×</label>
                <input type="checkbox" id="a-fish" class="chk c-bad"><label for="a-fish" class="chk-lbl">×“×’×™×</label>
                <input type="checkbox" id="a-shell" class="chk c-bad"><label for="a-shell" class="chk-lbl">×¤×™×¨×•×ª ×™×</label>
                <input type="checkbox" id="a-mustard" class="chk c-bad"><label for="a-mustard" class="chk-lbl">×—×¨×“×œ</label>
                <input type="checkbox" id="a-celery" class="chk c-bad"><label for="a-celery" class="chk-lbl">×¡×œ×¨×™</label>
                <input type="checkbox" id="a-lupin" class="chk c-bad"><label for="a-lupin" class="chk-lbl">×ª×•×¨××•×¡</label>
                <input type="checkbox" id="a-sulfites" class="chk c-bad"><label for="a-sulfites" class="chk-lbl">×¡×•×œ×¤×™×˜×™×</label>
                <input type="checkbox" id="a-corn" class="chk c-bad"><label for="a-corn" class="chk-lbl">×ª×™×¨×¡</label>
            </div></div>

            <div class="acc t-red"><div class="acc-h" onclick="tog(this)">ğŸ¥ ×¨×¤×•××™ <span>â–¼</span></div><div class="acc-b">
                <input type="checkbox" id="m-diabetes" class="chk c-bad"><label for="m-diabetes" class="chk-lbl">ğŸ’‰ ×¡×•×›×¨×ª</label>
                <input type="checkbox" id="m-celiac" class="chk c-bad"><label for="m-celiac" class="chk-lbl">ğŸŒ¾ ×¦×œ×™××§</label>
                <input type="checkbox" id="m-heart" class="chk c-bad"><label for="m-heart" class="chk-lbl">â¤ï¸ ×œ×‘</label>
                <input type="checkbox" id="m-salt" class="chk c-bad"><label for="m-salt" class="chk-lbl">ğŸ§‚ ×œ×—×¥ ×“×</label>
                <input type="checkbox" id="m-kidney" class="chk c-bad"><label for="m-kidney" class="chk-lbl">ğŸ©º ×›×œ×™×•×ª</label>
                <input type="checkbox" id="m-gout" class="chk c-bad"><label for="m-gout" class="chk-lbl">ğŸ¦¶ ×’××•×˜</label>
                <input type="checkbox" id="m-chol" class="chk c-bad"><label for="m-chol" class="chk-lbl">ğŸ” ×›×•×œ×¡×˜×¨×•×œ</label>
                <input type="checkbox" id="m-ibs" class="chk c-bad"><label for="m-ibs" class="chk-lbl">ğŸˆ ××¢×™ ×¨×’×™×–</label>
                <input type="checkbox" id="m-reflux" class="chk c-bad"><label for="m-reflux" class="chk-lbl">ğŸ”¥ ×¦×¨×‘×ª</label>
                <input type="checkbox" id="m-migraine" class="chk c-bad"><label for="m-migraine" class="chk-lbl">ğŸ§  ××™×’×¨× ×•×ª</label>
            </div></div>

            <div class="acc t-blue"><div class="acc-h" onclick="tog(this)">ğŸ¥— ×“×™××˜×” ×•××•×¨×— ×—×™×™× <span>â–¼</span></div><div class="acc-b">
                <input type="checkbox" id="l-vegan" class="chk"><label for="l-vegan" class="chk-lbl">ğŸŒ± ×˜×‘×¢×•× ×™</label>
                <input type="checkbox" id="l-veg" class="chk"><label for="l-veg" class="chk-lbl">ğŸ§€ ×¦××—×•× ×™</label>
                <input type="checkbox" id="l-keto" class="chk"><label for="l-keto" class="chk-lbl">ğŸ¥‘ ×§×˜×•</label>
                <input type="checkbox" id="l-paleo" class="chk"><label for="l-paleo" class="chk-lbl">ğŸ– ×¤×œ×™××•</label>
                <input type="checkbox" id="l-lowcarb" class="chk"><label for="l-lowcarb" class="chk-lbl">ğŸ“‰ ×“×œ ×¤×—××™××”</label>
                <input type="checkbox" id="l-organic" class="chk"><label for="l-organic" class="chk-lbl">ğŸ‚ ××•×¨×’× ×™</label>
                <input type="checkbox" id="l-whole30" class="chk"><label for="l-whole30" class="chk-lbl">Whole30</label>
                <input type="checkbox" id="l-fodmap" class="chk"><label for="l-fodmap" class="chk-lbl">ğŸ¥¦ FODMAP</label>
            </div></div>

            <div class="acc t-gold"><div class="acc-h" onclick="tog(this)">âœ¡ï¸ ×“×ª ×•×›×©×¨×•×ª <span>â–¼</span></div><div class="acc-b">
                <input type="checkbox" id="k-kosher" class="chk"><label for="k-kosher" class="chk-lbl">ğŸ“œ ×›×©×¨</label>
                <input type="checkbox" id="k-badatz" class="chk"><label for="k-badatz" class="chk-lbl">âœ¨ ×‘×“"×¥</label>
                <input type="checkbox" id="k-mehadrin" class="chk"><label for="k-mehadrin" class="chk-lbl">ğŸ• ××”×“×¨×™×Ÿ</label>
                <input type="checkbox" id="k-pass" class="chk"><label for="k-pass" class="chk-lbl">ğŸš« ×œ×¤×¡×—</label>
                <input type="checkbox" id="k-parve" class="chk"><label for="k-parve" class="chk-lbl">ğŸ ×¤×¨×•×•×”</label>
                <input type="checkbox" id="k-glatt" class="chk"><label for="k-glatt" class="chk-lbl">ğŸ¥© ×—×œ×§</label>
                <input type="checkbox" id="k-halal" class="chk"><label for="k-halal" class="chk-lbl">ğŸ•Œ ×—×œ××œ</label>
            </div></div>

            <div class="acc t-purp"><div class="acc-h" onclick="tog(this)">ğŸ§ª ×¨×›×™×‘×™× ×œ×”×™×× ×¢×•×ª <span>â–¼</span></div><div class="acc-b">
                <input type="checkbox" id="x-sugar" class="chk"><label for="x-sugar" class="chk-lbl">ğŸ­ ×ª×•×¡×¤×ª ×¡×•×›×¨</label>
                <input type="checkbox" id="x-proc" class="chk"><label for="x-proc" class="chk-lbl">ğŸ• ××¢×•×‘×“</label>
                <input type="checkbox" id="x-caff" class="chk"><label for="x-caff" class="chk-lbl">â˜• ×§×¤××™×Ÿ</label>
                <input type="checkbox" id="x-palm" class="chk"><label for="x-palm" class="chk-lbl">ğŸŒ´ ×©××Ÿ ×“×§×œ×™×</label>
                <input type="checkbox" id="x-msg" class="chk"><label for="x-msg" class="chk-lbl">ğŸ§‚ ××•× ×•×¡×•×“×™×•×</label>
                <input type="checkbox" id="x-trans" class="chk"><label for="x-trans" class="chk-lbl">ğŸŸ ×©×•××Ÿ ×˜×¨×× ×¡</label>
                <input type="checkbox" id="x-preserv" class="chk"><label for="x-preserv" class="chk-lbl">ğŸ¥« ××©××¨×™×</label>
                <input type="checkbox" id="x-color" class="chk"><label for="x-color" class="chk-lbl">ğŸ¨ ×¦×‘×¢×™ ×××›×œ</label>
                <input type="checkbox" id="x-sweet" class="chk"><label for="x-sweet" class="chk-lbl">ğŸ¬ ×××ª×™×§</label>
                <input type="checkbox" id="x-hfc" class="chk"><label for="x-hfc" class="chk-lbl">ğŸ¯ ×¡×™×¨×•×¤ ×ª×™×¨×¡</label>
            </div></div>

            <div class="acc t-green"><div class="acc-h" onclick="tog(this)">ğŸŒ ××ª×™×§×” ×•×¡×‘×™×‘×” <span>â–¼</span></div><div class="acc-b">
                <input type="checkbox" id="e-fair" class="chk"><label for="e-fair" class="chk-lbl">ğŸ¤ ×¡×—×¨ ×”×•×’×Ÿ</label>
                <input type="checkbox" id="e-local" class="chk"><label for="e-local" class="chk-lbl">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</label>
                <input type="checkbox" id="e-recycle" class="chk"><label for="e-recycle" class="chk-lbl">â™»ï¸ ××¨×™×–×” ××ª×›×œ×”</label>
                <input type="checkbox" id="e-gmo" class="chk"><label for="e-gmo" class="chk-lbl">ğŸ§¬ ×œ×œ× ×”× ×“×¡×”</label>
            </div></div>

            <div class="acc t-pink"><div class="acc-h" onclick="tog(this)">ğŸ‘¶ ××¨×§× ×•×—×•×©×™× <span>â–¼</span></div><div class="acc-b">
                <input type="checkbox" id="s-soft" class="chk"><label for="s-soft" class="chk-lbl">â˜ï¸ ×¨×š</label>
                <input type="checkbox" id="s-crunch" class="chk"><label for="s-crunch" class="chk-lbl">ğŸ¥¨ ×§×¨×™×¡×¤×™</label>
                <input type="checkbox" id="s-liquid" class="chk"><label for="s-liquid" class="chk-lbl">ğŸ’§ × ×•×–×œ×™</label>
                <input type="checkbox" id="s-smooth" class="chk"><label for="s-smooth" class="chk-lbl">ğŸ® ×—×œ×§</label>
                <input type="checkbox" id="s-nospice" class="chk"><label for="s-nospice" class="chk-lbl">ğŸŒ¶ï¸ ×œ× ×—×¨×™×£</label>
            </div></div>
        </div>
        <div class="sh-foot">
            <button class="btn btn-pri" onclick="Core.saveUser()">×©××•×¨ ×”×’×“×¨×•×ª</button>
            <button class="btn btn-danger" onclick="Core.clearData()">××™×¤×•×¡ ××œ×</button>
        </div>
    </div></div>

    <div id="m-cart" class="overlay"><div class="sheet">
        <div class="sh-head"><div class="sh-title">×¢×’×œ×”</div><div class="btn-icon" onclick="closeModal('cart')">âœ•</div></div>
        <div class="sh-body" id="cart-list"></div>
        <div class="sh-foot"><button class="btn btn-sec" onclick="Core.clearCart()">×¨×•×§×Ÿ</button></div>
    </div></div>

    <div id="m-hist" class="overlay"><div class="sheet">
        <div class="sh-head"><div class="sh-title">×”×™×¡×˜×•×¨×™×”</div><div class="btn-icon" onclick="closeModal('hist')">âœ•</div></div>
        <div class="sh-body">
            <div class="hist-controls">
                <div class="date-row" style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="date" id="h-start" class="inp-dark" style="flex:1; padding:10px; background:#222; border:1px solid #444; color:#fff; border-radius:10px;" onchange="History.render()">
                    <input type="date" id="h-end" class="inp-dark" style="flex:1; padding:10px; background:#222; border:1px solid #444; color:#fff; border-radius:10px;" onchange="History.render()">
                </div>
                <input type="text" id="h-search" class="inp-dark" style="width:100%; padding:12px; background:#222; border:1px solid #444; color:#fff; border-radius:10px; margin-bottom:10px;" placeholder="×—×¤×© ××•×¦×¨..." onkeyup="History.render()">
                
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:12px; color:var(--plasma-3); cursor:pointer;" onclick="History.toggleAgg()">
                    <span>ğŸ“‚ ×¦××¦× ×¤×¨×™×˜×™× (Aggregation)</span><span id="h-agg">OFF</span>
                </div>
            </div>
            <div id="hist-list"></div>
        </div>
    </div></div>

    <div id="m-ring" class="overlay"><div class="sheet" style="height:auto;">
        <div class="sh-head"><div class="sh-title">××¦×‘ ×’×•×¤× ×™</div><div class="btn-icon" onclick="closeModal('ring')">âœ•</div></div>
        <div class="sh-body" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn btn-sec" onclick="Core.setRing('normal')">ğŸŸ¢ ×¨×’×™×œ</button>
            <button class="btn btn-sec" onclick="Core.setRing('stress')">ğŸ¤¯ ×¡×˜×¨×¡</button>
            <button class="btn btn-sec" onclick="Core.setRing('sick')">ğŸ¤’ ×—×•×œ×™</button>
            <button class="btn btn-sec" onclick="Core.setRing('sugar')">ğŸ©¸ ×¡×•×›×¨</button>
        </div>
    </div></div>

    <div id="m-result" class="overlay"><div class="sheet">
        <div class="sh-head"><div class="sh-title">×ª×•×¦××•×ª</div><div class="btn-icon" onclick="closeModal('result')">âœ•</div></div>
        <div class="sh-body" style="text-align:center;">
            <div id="res-grade" class="grade-orb">A</div>
            <h2 id="res-name" style="margin:10px 0;">×©× ××•×¦×¨</h2>
            <div id="res-brand" style="color:#888; margin-bottom:20px;">××•×ª×’</div>
            <div id="res-analysis" style="text-align:right;"></div>
        </div>
        <div class="sh-foot" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn btn-pri" onclick="Core.addToCart(true)">+ ×œ×‘×™×ª</button>
            <button class="btn btn-sec" onclick="Core.addToCart(false)">+ ×œ×™</button>
        </div>
    </div></div>

    <div id="scan-ui">
        <div id="reader"></div>
        <div class="hud"><div class="reticle"><div class="laser"></div></div></div>
        <div style="position:absolute; bottom:60px; width:100%; display:flex; justify-content:center; z-index:350;">
            <button onclick="Scanner.stop()" style="background:rgba(0,0,0,0.5); color:#fff; border:1px solid #fff; padding:12px 30px; border-radius:30px; font-weight:700;">×‘×™×˜×•×œ ×—×–×¨×” ×œ×¨××©×™</button>
        </div>
    </div>

</div>

<script>
    // --- 1. DATA ENGINE (TITAN DB FACTORY - 2500 ITEMS) ---
    // We construct the DB procedurally to simulate a massive backend without 2500 lines of text.
    const TEMPLATES = [
        {n:'×œ×—× ××œ×', g:'A', tags:['gl','local']}, {n:'×œ×—× ××—×™×“', g:'C', tags:['gl','sug']},
        {n:'×—×œ×”', g:'D', tags:['gl','sug']}, {n:'×¤×™×ª×” ×›×•×¡××™×Ÿ', g:'A', tags:['gl']},
        {n:'×—×œ×‘ 3%', g:'B', tags:['da','liquid']}, {n:'×—×œ×‘ ×¡×•×™×”', g:'A', tags:['soy','ethics']},
        {n:'×§×•×˜×’\'', g:'A', tags:['da']}, {n:'×’×‘×™× ×” ×¦×”×•×‘×”', g:'D', tags:['da','proc','salt']},
        {n:'××™×œ×§×™', g:'E', tags:['da','sug']}, {n:'×§×•×§×” ×§×•×œ×”', g:'E', tags:['sug','caff']},
        {n:'×§×•×œ×” ×–×™×¨×•', g:'D', tags:['caff']}, {n:'×‘××‘×”', g:'C', tags:['nut']},
        {n:'×‘×™×¡×œ×™', g:'E', tags:['gl','proc']}, {n:'×ª×¤×•×¦\'×™×¤×¡', g:'D', tags:['proc']},
        {n:'×©×•×§×•×œ×“', g:'E', tags:['da','sug']}, {n:'×¤×¡×˜×”', g:'B', tags:['gl']},
        {n:'××•×¨×–', g:'B', tags:[]}, {n:'××œ×¤×¤×•×Ÿ', g:'A+', tags:['fresh']}, 
        {n:'×¢×’×‘× ×™×”', g:'A+', tags:['fresh']}, {n:'×©× ×™×¦×œ ×ª×™×¨×¡', g:'C', tags:['gl','proc']},
        {n:'×˜×•× ×”', g:'A', tags:['fish']}, {n:'× ×§× ×™×§×™×•×ª', g:'E', tags:['proc','meat']},
        {n:'×”××‘×•×¨×’×¨', g:'D', tags:['meat','proc']}, {n:'×¡×œ××•×Ÿ', g:'A', tags:['fish','fresh']}
    ];
    const BRANDS = ['×ª× ×•×‘×”','×©×˜×¨××•×¡','××¡×','×¢×œ×™×ª','×˜×¨×”','×¨××™ ×œ×•×™','×©×•×¤×¨×¡×œ','×˜×‘×¢×•×œ','×¡×•×’×ª','×•×™×¡×•×¦×§×™','×’×“','× ×¡×˜×œ×”','×™×•× ×™×œ×™×•×•×¨','×× ×’\'×œ','×‘×¨××Ÿ','×××¤×™×™×ª ××¨×™××œ','×–×•×’×œ×•×‘×§','×¢×•×£ ×˜×•×‘','×××× ×¢×•×£','×‘×™×™×’×œ ×‘×™×™×’×œ','×›×¨××™×ª','××—×•×”','×”×©×—×¨','× ×•×˜×œ×”','×¤×¨×¨×•','×§×™× ×“×¨','××™×œ×§×”','×œ×™×™×–','×“×•×¨×™×˜×•×¡','×¤×¨×™× ×’×œ×¡','×”×™×™× ×¥','×”×œ×× ×¡','×§× ×•×¨','×•×™×œ×™ ×¤×•×“','×¡×˜××¨×§×™×¡×˜','×™×›×™×Ÿ','×¤×¨×™ × ×™×¨','×¡× ×¤×¨×•×¡×˜','××¢×“× ×•×ª','×‘×Ÿ ×× ×“ ×’\'×¨×™×¡','× ×‘×™×¢×•×ª','××™ ×¢×“×Ÿ','×©×•×•×¤×¡','×§×¨×™×¡×˜×œ','×˜××¤×•','×§×¨×œ×¡×‘×¨×’','×”×™×™× ×§×Ÿ','×’×•×œ×“×¡×˜××¨','×¤×¤×¡×™','×¡×¤×¨×™×™×˜','×¤×× ×˜×”','×¤×™×•×– ×˜×™','×¤×¨×™×’×ª','×¡×¤×¨×™× ×’'];

    let DB = [];
    for(let i=0; i<2500; i++) {
        let t = TEMPLATES[Math.floor(Math.random()*TEMPLATES.length)];
        let b = BRANDS[Math.floor(Math.random()*BRANDS.length)];
        let g = t.g; 
        if(g==='B' && Math.random()>0.5) g='B+'; // Add B+ variety
        DB.push({ ...t, b: b, g: g, id: i });
    }

    // --- 2. CONFIG & COLORS ---
    const COLORS = {
        'A+': 'var(--g-ap)', 'A': 'var(--g-a)', 'B+': 'var(--g-bp)', 'B': 'var(--g-b)',
        'C': 'var(--g-c)', 'D': 'var(--g-d)', 'E': 'var(--g-e)'
    };
    const SCORES = {'A+':100, 'A':90, 'B+':85, 'B':80, 'C':60, 'D':40, 'E':20};

    // --- 3. STATE MANAGEMENT ---
    let state = { user:{name:'××•×¨×—', filters:[]}, cart:[], history:[], ring:'normal' };
    let temp = null;
    let scanner = null;
    let isAgg = false;

    // --- 4. SYSTEM BOOT ---
    window.onload = () => {
        // Load Data
        const u=localStorage.getItem('vTit_user'); if(u) state.user=JSON.parse(u);
        const c=localStorage.getItem('vTit_cart'); if(c) state.cart=JSON.parse(c);
        const h=localStorage.getItem('vTit_hist'); if(h) state.history=JSON.parse(h);
        
        if(state.history.length === 0) seedHistory(); // First time mock
        
        // UI Init
        setTimeout(() => {
            const boot = document.getElementById('boot-screen');
            boot.style.opacity = 0;
            setTimeout(() => { boot.style.display='none'; document.getElementById('app-frame').classList.add('active'); }, 500);
        }, 1500);

        Core.update();
        
        // Date Defaults
        document.getElementById('h-end').valueAsDate = new Date();
        let d = new Date(); d.setMonth(d.getMonth()-6);
        document.getElementById('h-start').valueAsDate = d;
    };

    function seedHistory() {
        for(let i=0; i<30; i++) {
            let p = DB[Math.floor(Math.random()*DB.length)];
            state.history.push({...p, t:new Date().toISOString()});
        }
        Core.save();
    }

    // --- 5. LOGIC CORE (THE BRAIN) ---
    const Core = {
        save: function() {
            localStorage.setItem('vTit_user', JSON.stringify(state.user));
            localStorage.setItem('vTit_cart', JSON.stringify(state.cart));
            localStorage.setItem('vTit_hist', JSON.stringify(state.history));
        },

        update: function() {
            document.getElementById('d-name').innerText = state.user.name;
            document.getElementById('d-filters').innerText = state.user.filters.length + ' ×”×’×“×¨×•×ª';
            
            const rMap = {'normal':'×ª×§×™×Ÿ','stress':'×¡×˜×¨×¡','sick':'×—×•×œ×™','sugar':'×¡×•×›×¨'};
            document.getElementById('d-ring').innerText = rMap[state.ring];
            
            // Cart Score Calc
            let score = 100;
            if(state.cart.length > 0) {
                let total = 0;
                state.cart.forEach(i => total += SCORES[i.g] || 50);
                score = Math.round(total / state.cart.length);
            }
            
            document.getElementById('d-score').innerText = score + '%';
            const bar = document.getElementById('d-bar');
            bar.style.width = score + '%';
            
            // Badge & Color
            let grade = 'E';
            if(score>=95) grade='A+'; else if(score>=85) grade='A'; else if(score>=80) grade='B+';
            else if(score>=70) grade='B'; else if(score>=60) grade='C'; else if(score>=40) grade='D';
            
            const badge = document.getElementById('cart-badge');
            badge.innerText = grade;
            badge.style.color = COLORS[grade];
            badge.style.borderColor = COLORS[grade];
            bar.style.background = COLORS[grade];

            renderCart();
            renderHist();
            
            // Render active tags
            const tagMap = {'a-milk':'ğŸ¥›','a-gluten':'ğŸ','m-diabetes':'ğŸ’‰','q-green':'âœ…'};
            document.getElementById('active-tags').innerHTML = state.user.filters.slice(0,4).map(f=>`<span class="tag">${tagMap[f]||''} ${f.split('-')[1]}</span>`).join('');
        },

        analyze: function(p) {
            let g = p.g;
            let reasons = [];
            const f = state.user.filters;

            // Logic Tree
            if(f.includes('a-gluten') && p.tags.includes('gl')) { g='E'; reasons.push('×’×œ×•×˜×Ÿ'); }
            if(f.includes('a-milk') && p.tags.includes('da')) { g='E'; reasons.push('×—×œ×‘'); }
            if(f.includes('m-diabetes') && p.tags.includes('sug')) { g='E'; reasons.push('×¡×•×›×¨ (×¡×•×›×¨×ª)'); }
            if(f.includes('l-vegan') && (p.tags.includes('da')||p.tags.includes('meat')||p.tags.includes('fish'))) { g='E'; reasons.push('××Ÿ ×”×—×™'); }
            
            if(f.includes('q-green') && (p.tags.includes('proc')||p.tags.includes('sug'))) { g='D'; reasons.push('××™× ×• ×ª×• ×™×¨×•×§'); }
            if(f.includes('q-aplus') && g!=='A+') { if(g!=='E') g='D'; reasons.push('××™× ×• A+'); }

            // Ring Override
            if(g!=='E') {
                if(state.ring==='stress' && p.tags.includes('sug')) { g='D'; reasons.push('×¡×•×›×¨ (×¡×˜×¨×¡)'); }
                if(state.ring==='sugar' && p.tags.includes('sug')) { g='B'; reasons.push('×˜×•×‘ ×œ× ×¤×™×œ×”'); }
            }

            temp = { ...p, g: g };
            
            // Render Result
            const orb = document.getElementById('res-grade');
            orb.innerText = g;
            orb.style.color = COLORS[g];
            orb.style.boxShadow = `0 0 60px ${COLORS[g]}`;
            orb.style.borderColor = COLORS[g];
            
            document.getElementById('res-name').innerText = p.n;
            document.getElementById('res-brand').innerText = p.b;
            document.getElementById('res-analysis').innerHTML = reasons.length ? reasons.map(r=>`<div class="res-alert" style="color:var(--g-e); border-right:4px solid var(--g-e);">ğŸ›‘ ${r}</div>`).join('') : '<div class="res-alert" style="color:var(--g-a); border-right:4px solid var(--g-a);">âœ… ××ª××™× ×œ×¤×¨×•×¤×™×œ</div>';
            
            openModal('result');
        },

        addToCart: function(home) {
            if(!temp) return;
            const item = { ...temp, t:new Date().toISOString(), u:home?'×‘×™×ª':'×× ×™' };
            state.cart.push(item);
            state.history.unshift(item);
            Core.save();
            closeModal('result');
            Core.update();
            toast('× ×•×¡×£ ×‘×”×¦×œ×—×”');
        },

        manualAdd: function() {
            const val = document.getElementById('q-inp').value;
            if(!val) return;
            const item = { n:val, b:'×›×œ×œ×™', g:'C', tags:[], t:new Date().toISOString(), u:'×‘×™×ª' };
            state.cart.push(item);
            state.history.unshift(item);
            Core.save();
            document.getElementById('q-inp').value='';
            Core.update();
            toast('× ×•×¡×£');
        },

        saveUser: function() {
            state.user.name = document.getElementById('inp-name').value || '××•×¨×—';
            state.user.filters = [];
            document.querySelectorAll('.chk:checked').forEach(c=>state.user.filters.push(c.id));
            Core.save();
            closeModal('settings');
            Core.update();
            toast('×¤×¨×•×¤×™×œ ×¢×•×“×›×Ÿ');
        },

        clearCart: function() {
            if(confirm('×œ×¨×•×§×Ÿ?')) { state.cart=[]; Core.save(); Core.update(); closeModal('cart'); }
        },

        clearData: function() {
            if(confirm('××™×¤×•×¡ ××œ×?')) { localStorage.clear(); location.reload(); }
        },

        setRing: function(s) { state.ring=s; Core.save(); closeModal('ring'); Core.update(); }
    };

    // --- 6. SCANNER ---
    const Scanner = {
        start: function() {
            document.getElementById('scan-ui').style.display='flex';
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (txt) => { 
                    Scanner.stop(); 
                    // Simulating DB fetch
                    Core.analyze(DB[Math.floor(Math.random()*DB.length)]); 
                }, 
                (err) => {}
            ).catch(e => {
                console.log("Cam fail");
                setTimeout(() => { Scanner.stop(); Core.analyze(DB[Math.floor(Math.random()*DB.length)]); }, 1000);
            });
        },
        stop: function() {
            if(scanner) scanner.stop().then(()=>scanner.clear()).catch(e=>{});
            document.getElementById('scan-ui').style.display='none';
        }
    };

    // --- 7. UI HELPERS ---
    function openModal(id) { document.getElementById('m-'+id).classList.add('open'); if(id==='settings') loadSetUI(); }
    function closeModal(id) { document.getElementById('m-'+id).classList.remove('open'); }
    function tog(el) { el.parentElement.classList.toggle('open'); }
    function setRing(s) { Core.setRing(s); }
    function remCart(i) { state.cart.splice(i,1); Core.save(); Core.update(); }
    function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('vis'); setTimeout(()=>t.classList.remove('vis'),2000); }
    
    function renderCart() {
        document.getElementById('cart-list').innerHTML = state.cart.map((i,x) => `
            <div class="l-item">
                <div><span style="color:${COLORS[i.g]}; font-weight:bold; margin-left:10px;">${i.g}</span> ${i.n}</div>
                <div style="color:var(--g-e); cursor:pointer;" onclick="remCart(${x})">âœ•</div>
            </div>`).join('');
    }

    function renderHist() {
        const txt = document.getElementById('h-search').value;
        const start = new Date(document.getElementById('h-start').value).getTime();
        const end = new Date(document.getElementById('h-end').value).getTime() + 86400000;
        
        let list = state.history.filter(i => {
            const t = new Date(i.t).getTime();
            return (t >= start && t <= end) && i.n.includes(txt);
        });

        const con = document.getElementById('h-content');
        if(isAgg) {
            let agg = {};
            list.forEach(i => {
                const k = i.n;
                if(!agg[k]) agg[k] = {...i, count:0};
                agg[k].count++;
            });
            con.innerHTML = Object.values(agg).map(i => `
                <div class="l-item">
                    <div>${i.n} <span style="background:var(--plasma-1); padding:2px 6px; border-radius:6px; font-size:10px;">x${i.count}</span></div>
                    <div class="g-badge" style="background:${COLORS[i.g]}">${i.g}</div>
                </div>`).join('');
        } else {
            con.innerHTML = list.map(i => `
                <div class="l-item">
                    <div>${i.n} <span style="color:#666; font-size:11px;">${new Date(i.t).toLocaleDateString()}</span></div>
                    <div class="g-badge" style="background:${COLORS[i.g]}">${i.g}</div>
                </div>`).join('');
        }
    }

    function toggleAgg() { isAgg=!isAgg; document.getElementById('h-agg').innerText = isAgg?'ON':'OFF'; renderHist(); }
    function loadSetUI() {
        document.getElementById('inp-name').value = state.user.name;
        document.querySelectorAll('.chk').forEach(c => c.checked = state.user.filters.includes(c.id));
    }

    // History Logic Bindings
    const History = { render: renderHist, toggleAgg: toggleAgg };

</script>
</body>
</html>
