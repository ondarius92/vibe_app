<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Vibe OS 38.0 - Stable</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { 
            --primary: #00e676; --warn: #ffca28; --danger: #ff5252; --bg: #000000; 
            --surface: #121212; --surface-soft: #1e1e1e; --text: #ffffff; --radius: 16px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding-bottom: 150px; user-select: none; }
        
        /* HEADER */
        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.95); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #333; backdrop-filter: blur(10px); }
        .brand { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; background: linear-gradient(45deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-icons { display: flex; gap: 15px; }
        .icon-btn { font-size: 22px; cursor: pointer; position: relative; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--primary); color: black; font-size: 10px; font-weight: 900; padding: 2px 5px; border-radius: 10px; border: 2px solid var(--bg); }

        /* DASHBOARD */
        .bento-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; padding: 15px; }
        .bento-card { background: var(--surface); padding: 15px; border-radius: var(--radius); border: 1px solid #222; position: relative; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
        .bento-val { font-size: 26px; font-weight: 800; margin-top: 5px; }
        .bento-lbl { font-size: 10px; color: #888; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        
        .progress-container { width: 100%; height: 6px; background: #333; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; width: 50%; background: linear-gradient(90deg, var(--warn), var(--primary)); transition: width 0.5s ease; }

        /* FILTERS ENGINE */
        .filter-sec { padding: 0 20px 40px 20px; }
        .sec-head { font-size: 11px; color: #666; font-weight: 800; text-transform: uppercase; margin: 25px 0 10px 0; letter-spacing: 1px; }
        .acc { margin-bottom: 8px; background: var(--surface); border-radius: 12px; border: 1px solid #222; overflow: hidden; transition: 0.2s; }
        .acc-head { padding: 16px; font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; border-right: 4px solid transparent; cursor: pointer; background: var(--surface-soft); }
        .acc-body { display: none; padding: 15px; background: #0a0a0a; flex-wrap: wrap; gap: 8px; border-top: 1px solid #222; }
        .acc-body.open { display: flex; }
        
        .c-red .acc-head { border-color: var(--danger); }
        .c-blue .acc-head { border-color: var(--primary); }
        .c-gold .acc-head { border-color: var(--gold); }
        .c-purple .acc-head { border-color: #d500f9; }

        .chip { display: none; }
        .lbl { padding: 8px 14px; background: #1f1f1f; border: 1px solid #333; border-radius: 50px; font-size: 12px; color: #aaa; transition: 0.2s; cursor: pointer; display: flex; align-items: center; gap: 6px; flex-grow: 1; justify-content: center; }
        .chip:checked + .lbl { background: #eee; color: #000; font-weight: 800; border-color: #fff; transform: scale(1.02); }
        .danger .chip:checked + .lbl { background: rgba(255, 82, 82, 0.2); color: var(--danger); border-color: var(--danger); }
        .safe .chip:checked + .lbl { background: rgba(0, 230, 118, 0.2); color: var(--primary); border-color: var(--primary); }

        /* SCANNER */
        #scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .scan-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 40px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .scan-frame { width: 260px; height: 260px; border: 2px solid rgba(255,255,255,0.5); border-radius: 24px; margin: auto; position: relative; box-shadow: 0 0 0 1000px rgba(0,0,0,0.8); }
        .close-cam { pointer-events: auto; background: rgba(30,30,30,0.9); color: white; padding: 12px 30px; border-radius: 50px; border: 1px solid #444; margin: 0 auto; font-weight: bold; backdrop-filter: blur(10px); }

        /* BOTTOM BAR */
        .action-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(30,30,30,0.95); padding: 8px; border-radius: 100px; display: flex; justify-content: space-between; border: 1px solid #444; z-index: 300; backdrop-filter: blur(15px); box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .bar-btn { width: 50px; height: 50px; border: none; background: transparent; font-size: 24px; cursor: pointer; color: #888; display: flex; align-items: center; justify-content: center; }
        .scan-btn { width: 65px; height: 65px; background: white; border-radius: 22px; margin-top: -20px; border: none; box-shadow: 0 5px 25px rgba(255,255,255,0.25); display: flex; align-items: center; justify-content: center; cursor: pointer; color: black; }

        /* RESULTS SHEET */
        #sheet-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; pointer-events: none; opacity: 0; transition: 0.3s; }
        .active-sheet { opacity: 1 !important; pointer-events: auto !important; }
        #sheet-bg { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        #bottom-sheet { position: absolute; bottom: 0; width: 100%; background: #161616; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-top: 1px solid #333; max-height: 85vh; overflow-y: auto; }
        .active-sheet #bottom-sheet { transform: translateY(0); }

        .prod-header { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 20px; }
        .prod-thumb { width: 80px; height: 80px; background: white; border-radius: 16px; object-fit: contain; padding: 5px; }
        .editable-name { background: transparent; border: none; border-bottom: 1px dashed #555; color: white; font-size: 18px; font-weight: 800; width: 100%; font-family: inherit; margin-bottom: 5px; padding: 5px 0; border-radius: 0; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .info-tag { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .tag-neutral { background: rgba(255, 202, 40, 0.15); color: var(--warn); border: 1px solid rgba(255, 202, 40, 0.3); } 
        .tag-good { background: rgba(0, 230, 118, 0.15); color: var(--primary); border: 1px solid rgba(0, 230, 118, 0.3); } 
        .tag-danger { background: rgba(255, 82, 82, 0.15); color: var(--danger); border: 1px solid rgba(255, 82, 82, 0.3); } 

        .analysis-box { background: #222; padding: 15px; border-radius: 12px; margin: 15px 0; font-size: 13px; line-height: 1.5; color: #ccc; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .sheet-btn { padding: 15px; border-radius: 14px; border: 1px solid #333; font-weight: 700; cursor: pointer; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 6px; background: #222; color: white; transition: 0.2s; }
        .sheet-btn.primary { background: rgba(0,230,118,0.15); border-color: var(--primary); color: var(--primary); grid-column: span 2; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 600; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: flex-end; }
        .modal.open { opacity: 1; pointer-events: auto; }
        .modal-content { width: 100%; background: #161616; border-radius: 30px 30px 0 0; max-height: 85vh; overflow-y: auto; border-top: 1px solid #333; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; }
        .modal.open .modal-content { transform: translateY(0); }
        .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; background: #161616; position: sticky; top: 0; z-index: 10; }
        .modal-body { padding: 20px; }

        .aisle-header { font-size: 12px; color: var(--primary); font-weight: 800; text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; letter-spacing: 1px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #2a2a2a; }
        .clean-inp { width: 100%; background: #1c1c1e; border: 1px solid #333; color: white; padding: 15px; border-radius: 12px; font-size: 16px; margin-bottom: 10px; text-align: center; }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #222; color: white; padding: 12px 24px; border-radius: 50px; border: 1px solid #444; z-index: 1000; transition: 0.3s; font-weight: bold; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="header">
        <div class="brand">Vibe OS 38.0</div>
        <div class="nav-icons">
            <div class="icon-btn" onclick="toggleModal('history-modal')">ğŸ•’</div>
            <div class="icon-btn" onclick="toggleModal('settings-modal')">âš™ï¸</div>
            <div class="icon-btn" onclick="toggleModal('cart-modal')">ğŸ›’ <span class="badge" id="badge">0</span></div>
        </div>
    </div>

    <div class="bento-grid">
        <div class="bento-card wide">
            <div style="display:flex; justify-content:space-between;">
                <div class="bento-lbl">××™×–×•×Ÿ ×¡×œ ×©×‘×•×¢×™</div>
                <div class="bento-lbl" id="score-text" style="color:var(--primary);">×˜×¨× ×”×ª×—×œ×ª</div>
            </div>
            <div class="progress-container"><div class="progress-fill" id="basket-score-bar" style="width: 50%;"></div></div>
            <div style="font-size:11px; color:#666; margin-top:5px;">×”××“×“ ×¢×•×œ×” ×›×›×œ ×©×”×¡×œ ××›×™×œ ×™×•×ª×¨ ××•×¦×¨×™× ×˜×¨×™×™× ×•××–×™× ×™×</div>
        </div>
        <div class="bento-card"><div class="bento-lbl">×¤×¨×™×˜×™×</div><div class="bento-val" id="d-cart">0</div></div>
    </div>

    <div class="filter-sec">
        <div class="sec-head">×¤×¨×•×¤×™×œ ××™×©×™</div>
        
        <div class="acc c-red"><div class="acc-head" onclick="tog(this)">âš ï¸ ××œ×¨×’×™×•×ª (×—×•×‘×”) <span>â–¾</span></div><div class="acc-body danger">
            <input type="checkbox" id="a-milk" class="chip save"><label for="a-milk" class="lbl">×—×œ×‘</label>
            <input type="checkbox" id="a-gluten" class="chip save"><label for="a-gluten" class="lbl">×’×œ×•×˜×Ÿ</label>
            <input type="checkbox" id="a-nuts" class="chip save"><label for="a-nuts" class="lbl">××’×•×–×™×</label>
            <input type="checkbox" id="a-peanuts" class="chip save"><label for="a-peanuts" class="lbl">×‘×•×˜× ×™×</label>
            <input type="checkbox" id="a-soy" class="chip save"><label for="a-soy" class="lbl">×¡×•×™×”</label>
            <input type="checkbox" id="a-sesame" class="chip save"><label for="a-sesame" class="lbl">×©×•××©×•×</label>
            <input type="checkbox" id="a-eggs" class="chip save"><label for="a-eggs" class="lbl">×‘×™×¦×™×</label>
            <input type="checkbox" id="a-fish" class="chip save"><label for="a-fish" class="lbl">×“×’×™× (×™×•×“)</label>
            <input type="checkbox" id="a-sulfites" class="chip save"><label for="a-sulfites" class="lbl">×¡×•×œ×¤×™×˜×™×</label>
        </div></div>

        <div class="acc c-red"><div class="acc-head" onclick="tog(this)">ğŸ¥ × ×™×”×•×œ ×¨×¤×•××™ <span>â–¾</span></div><div class="acc-body danger">
            <input type="checkbox" id="d-diabetic" class="chip save"><label for="d-diabetic" class="lbl">×¡×•×›×¨×ª</label>
            <input type="checkbox" id="d-heart" class="chip save"><label for="d-heart" class="lbl">×œ×‘/× ×ª×¨×Ÿ</label>
            <input type="checkbox" id="d-cholesterol" class="chip save"><label for="d-cholesterol" class="lbl">×›×•×œ×¡×˜×¨×•×œ</label>
            <input type="checkbox" id="d-celiac" class="chip save"><label for="d-celiac" class="lbl">×¦×œ×™××§</label>
            <input type="checkbox" id="d-gout" class="chip save"><label for="d-gout" class="lbl">×’××•×˜</label>
            <input type="checkbox" id="d-kidney" class="chip save"><label for="d-kidney" class="lbl">×›×œ×™×•×ª</label>
            <input type="checkbox" id="d-reflux" class="chip save"><label for="d-reflux" class="lbl">×¦×¨×‘×ª</label>
            <input type="checkbox" id="d-ibs" class="chip save"><label for="d-ibs" class="lbl">××¢×™ ×¨×’×™×–</label>
            <input type="checkbox" id="d-anemia" class="chip save"><label for="d-anemia" class="lbl">×× ××™×”</label>
        </div></div>

        <div class="acc c-purple"><div class="acc-head" onclick="tog(this)">ğŸ‘¶ ×¨×’×™×©×•×™×•×ª ××™×•×—×“×•×ª <span>â–¾</span></div><div class="acc-body danger">
            <input type="checkbox" id="x-preg" class="chip save"><label for="x-preg" class="lbl">×”×¨×™×•×Ÿ</label>
            <input type="checkbox" id="x-baby" class="chip save"><label for="x-baby" class="lbl">×ª×™× ×•×§×•×ª</label>
            <input type="checkbox" id="x-elderly" class="chip save"><label for="x-elderly" class="lbl">×’×™×œ ×©×œ×™×©×™</label>
        </div></div>

        <div class="acc c-blue"><div class="acc-head" onclick="tog(this)">ğŸ¥— ×“×™××˜×” ×•×œ×™×™×£ ×¡×˜×™×™×œ <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="l-vegan" class="chip save"><label for="l-vegan" class="lbl">×˜×‘×¢×•× ×™</label>
            <input type="checkbox" id="l-vegetarian" class="chip save"><label for="l-vegetarian" class="lbl">×¦××—×•× ×™</label>
            <input type="checkbox" id="l-keto" class="chip save"><label for="l-keto" class="lbl">×§×˜×•</label>
            <input type="checkbox" id="l-paleo" class="chip save"><label for="l-paleo" class="lbl">×¤×œ×™××•</label>
            <input type="checkbox" id="l-lowcarb" class="chip save"><label for="l-lowcarb" class="lbl">×“×œ ×¤×—××™××”</label>
            <input type="checkbox" id="c-clean" class="chip save"><label for="c-clean" class="lbl">×ª×•×•×™×ª × ×§×™×™×”</label>
            <input type="checkbox" id="c-sugar" class="chip save"><label for="c-sugar" class="lbl">×œ×œ× ×¡×•×›×¨</label>
            <input type="checkbox" id="c-organic" class="chip save"><label for="c-organic" class="lbl">××•×¨×’× ×™</label>
        </div></div>

        <div class="acc c-gold"><div class="acc-head" onclick="tog(this)">âœ¡ï¸ ×“×ª ×•××¡×•×¨×ª <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="k-kosher" class="chip save"><label for="k-kosher" class="lbl">×›×©×¨</label>
            <input type="checkbox" id="k-badatz" class="chip save"><label for="k-badatz" class="lbl">×‘×“"×¥</label>
            <input type="checkbox" id="k-parve" class="chip save"><label for="k-parve" class="lbl">×¤×¨×•×•×”</label>
            <input type="checkbox" id="k-halal" class="chip save"><label for="k-halal" class="lbl">×—×œ××œ</label>
            <input type="checkbox" id="k-passover" class="chip save"><label for="k-passover" class="lbl">×¤×¡×—</label>
        </div></div>

        <div class="acc c-blue"><div class="acc-head" onclick="tog(this)">âš¡ ×¡×¤×•×¨×˜ ×•×—×™×˜×•×‘ <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="p-protein" class="chip save"><label for="p-protein" class="lbl">×—×œ×‘×•×Ÿ ×’×‘×•×”</label>
            <input type="checkbox" id="p-bulk" class="chip save"><label for="p-bulk" class="lbl">××¡×”</label>
            <input type="checkbox" id="p-cut" class="chip save"><label for="p-cut" class="lbl">×—×™×˜×•×‘</label>
            <input type="checkbox" id="p-energy" class="chip save"><label for="p-energy" class="lbl">×× ×¨×’×™×”</label>
        </div></div>
        
        <div class="acc c-blue"><div class="acc-head" onclick="tog(this)">ğŸŒ ×¢×¨×›×™× <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="b-israel" class="chip save" checked><label for="b-israel" class="lbl">×ª×•×¦×¨×ª ×”××¨×¥</label>
            <input type="checkbox" id="b-fairtrade" class="chip save"><label for="b-fairtrade" class="lbl">×¡×—×¨ ×”×•×’×Ÿ</label>
        </div></div>
    </div>

    <div id="scanner-overlay">
        <div id="reader"></div>
        <div class="scan-ui">
            <div style="text-align:center;color:white;font-weight:900;font-size:20px;">×¡×¨×™×§×ª ××•×¦×¨</div>
            <div class="scan-frame"></div>
            <button class="close-cam" onclick="stopCamera()">×¡×’×•×¨</button>
        </div>
    </div>

    <div class="action-bar">
        <button class="bar-btn" onclick="manualSearch()">âŒ¨ï¸</button>
        <button class="scan-btn" onclick="startCamera()">
            <svg viewBox="0 0 24 24" width="32" height="32"><path d="M4 6h2v12H4zm14 0h2v12h-2zm-4 0h2v12h-2zm-4 0h2v12h-2z" fill="black"/><path d="M2 4v16h20V4H2zm18 14H4V6h16v12z" fill="none" stroke="black" stroke-width="2"/></svg>
        </button>
        <button class="bar-btn" onclick="toggleModal('history-modal')">ğŸ“œ</button>
    </div>

    <div id="sheet-wrapper">
        <div id="sheet-bg" onclick="closeSheet()"></div>
        <div class="modal-content" id="bottom-sheet">
            <div style="width:40px;height:4px;background:#333;margin:0 auto 20px auto;border-radius:10px;"></div>
            
            <div class="prod-header">
                <img id="p-img" class="prod-thumb" src="" onerror="this.style.display='none'">
                <div style="flex:1;">
                    <div id="p-brand" style="font-size:11px;color:#888;font-weight:700;"></div>
                    <input type="text" id="p-name" class="editable-name" value="..." oninput="updateName(this.value)">
                    <div style="font-size:10px;color:#666;">âœ ×œ×—×¥ ×œ×¢×¨×™×›×” ×•×ª×¨×’×•×</div>
                </div>
            </div>

            <div id="tags-area" class="tags-container"></div>
            <div id="bio-res" class="analysis-box"></div>

            <div class="action-grid">
                <button class="sheet-btn" onclick="comparePrecise()">ğŸ” ×”×©×•×•××ª ××—×™×¨<span style="font-size:9px;opacity:0.6;">×œ×¤×™ ×‘×¨×§×•×“/×©×</span></button>
                <button class="sheet-btn" onclick="findAlternatives()">ğŸ’¡ ×—×œ×•×¤×•×ª ×–×•×œ×•×ª<span style="font-size:9px;opacity:0.6;">×œ×¤×™ ×§×˜×’×•×¨×™×”</span></button>
                <button class="sheet-btn primary" onclick="addToCart()">ğŸ›’ ×”×•×¡×£ ×œ×¡×œ ×©×‘×•×¢×™</button>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×¡×œ ×§× ×™×•×ª ×©×‘×•×¢×™</h2><button onclick="closeModal('cart-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body" id="cart-body"></div>
            <div style="padding:20px;text-align:center;border-top:1px solid #333;"><button onclick="shareCart()" class="clean-inp" style="background:var(--primary);color:black;font-weight:bold;">×•×•××˜×¡××¤ ğŸ“¤</button></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×”×’×“×¨×•×ª</h2><button onclick="closeModal('settings-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body">
                <input type="number" id="u-w" class="clean-inp" placeholder="××©×§×œ (×§×’)">
                <input type="number" id="u-h" class="clean-inp" placeholder="×’×•×‘×” (×¡×)">
                <input type="number" id="u-age" class="clean-inp" placeholder="×’×™×œ">
                <button onclick="saveProfile()" class="clean-inp" style="background:white;color:black;font-weight:bold;margin-top:20px;">×©××•×¨</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×”×™×¡×˜×•×¨×™×”</h2><button onclick="closeModal('history-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body" id="history-list"></div>
            <div style="padding:20px;"><button onclick="clearHistory()" class="clean-inp" style="background:var(--danger);color:white;">× ×§×” ×”×›×œ</button></div>
        </div>
    </div>

    <script>
        // --- VIBE OS 38.0 STABLE LOGIC ---
        
        let cart = JSON.parse(localStorage.getItem('vibeCart38')) || [];
        let history = JSON.parse(localStorage.getItem('vibeHistory')) || [];
        let user = JSON.parse(localStorage.getItem('vibeUser38')) || {w:75, h:175, age:30};
        let currentItem = { name: '', code: '', brand: '', category: 'other' };

        // 1. MASSIVE DICTIONARY
        const dict = {
            'milk':{he:'×—×œ×‘',c:'fridge'},'cheese':{he:'×’×‘×™× ×”',c:'fridge'},'yogurt':{he:'×™×•×’×•×¨×˜',c:'fridge'},'butter':{he:'×—×××”',c:'fridge'},'cream':{he:'×©×× ×ª',c:'fridge'},
            'bread':{he:'×œ×—×',c:'pantry'},'pasta':{he:'×¤×¡×˜×”',c:'pantry'},'rice':{he:'××•×¨×–',c:'pantry'},'flour':{he:'×§××—',c:'pantry'},'sugar':{he:'×¡×•×›×¨',c:'pantry'},'salt':{he:'××œ×—',c:'pantry'},'oil':{he:'×©××Ÿ',c:'pantry'},'olive':{he:'×–×™×ª',c:'pantry'},'canola':{he:'×§× ×•×œ×”',c:'pantry'},'couscous':{he:'×§×•×¡×§×•×¡',c:'pantry'},'quinoa':{he:'×§×™× ×•××”',c:'pantry'},'lentil':{he:'×¢×“×©×™×',c:'pantry'},'bean':{he:'×©×¢×•×¢×™×ª',c:'pantry'},'chickpea':{he:'×—×•××•×¡',c:'pantry'},'tahini':{he:'×˜×—×™× ×”',c:'pantry'},'corn':{he:'×ª×™×¨×¡',c:'pantry'},'cereal':{he:'×“×’× ×™ ×‘×•×§×¨',c:'pantry'},'oat':{he:'×©×™×‘×•×œ×ª ×©×•×¢×œ',c:'pantry'},'granola':{he:'×’×¨× ×•×œ×”',c:'pantry'},'honey':{he:'×“×‘×©',c:'pantry'},'jam':{he:'×¨×™×‘×”',c:'pantry'},'spread':{he:'×××¨×—',c:'pantry'},'chocolate':{he:'×©×•×§×•×œ×“',c:'pantry'},'halva':{he:'×—×œ×‘×”',c:'pantry'},
            'tomato':{he:'×¢×’×‘× ×™×”',c:'veg'},'cucumber':{he:'××œ×¤×¤×•×Ÿ',c:'veg'},'apple':{he:'×ª×¤×•×—',c:'veg'},'banana':{he:'×‘× × ×”',c:'veg'},'lemon':{he:'×œ×™××•×Ÿ',c:'veg'},'pepper':{he:'×¤×œ×¤×œ',c:'veg'},'carrot':{he:'×’×–×¨',c:'veg'},'onion':{he:'×‘×¦×œ',c:'veg'},'garlic':{he:'×©×•×',c:'veg'},'potato':{he:'×ª×¤×•×— ××“××”',c:'veg'},'lettuce':{he:'×—×¡×”',c:'veg'},'cabbage':{he:'×›×¨×•×‘',c:'veg'},'herb':{he:'×¢×©×‘×™ ×ª×™×‘×•×œ',c:'veg'},'avocado':{he:'××‘×•×§×“×•',c:'veg'},'orange':{he:'×ª×¤×•×–',c:'veg'},'grape':{he:'×¢× ×‘×™×',c:'veg'},'melon':{he:'××œ×•×Ÿ',c:'veg'},'berry':{he:'×¤×™×¨×•×ª ×™×¢×¨',c:'veg'},'date':{he:'×ª××¨',c:'veg'},
            'chicken':{he:'×¢×•×£',c:'meat'},'beef':{he:'×‘×§×¨',c:'meat'},'fish':{he:'×“×’',c:'meat'},'tuna':{he:'×˜×•× ×”',c:'pantry'},'egg':{he:'×‘×™×¦×™×',c:'fridge'},'salami':{he:'× ×§× ×™×§',c:'meat'},'sausage':{he:'× ×§× ×™×§×™×”',c:'meat'},'tofu':{he:'×˜×•×¤×•',c:'fridge'},'seitan':{he:'×¡×™×™×˜×Ÿ',c:'fridge'},'salmon':{he:'×¡×œ××•×Ÿ',c:'meat'},
            'water':{he:'××™×',c:'pantry'},'juice':{he:'××™×¥',c:'fridge'},'soda':{he:'××©×§×” ××•×’×–',c:'pantry'},'cola':{he:'×§×•×œ×”',c:'pantry'},'coffee':{he:'×§×¤×”',c:'pantry'},'tea':{he:'×ª×”',c:'pantry'},'beer':{he:'×‘×™×¨×”',c:'pantry'},'wine':{he:'×™×™×Ÿ',c:'pantry'},'drink':{he:'××©×§×”',c:'pantry'},
            'chips':{he:'×—×˜×™×£ ×¦×³×™×¤×¡',c:'pantry'},'snack':{he:'×—×˜×™×£',c:'pantry'},'cookie':{he:'×¢×•×’×™×”',c:'pantry'},'cake':{he:'×¢×•×’×”',c:'pantry'},'biscuit':{he:'×‘×™×¡×§×•×•×™×˜',c:'pantry'},'wafer':{he:'×•×•×¤×œ',c:'pantry'},'cracker':{he:'×§×¨×§×¨',c:'pantry'},'pretzel':{he:'×‘×™×™×’×œ×”',c:'pantry'},'nut':{he:'××’×•×–×™×',c:'pantry'},'gum':{he:'××¡×˜×™×§',c:'pantry'},'candy':{he:'×¡×•×›×¨×™×”',c:'pantry'},
            'shampoo':{he:'×©××¤×•',c:'home'},'soap':{he:'×¡×‘×•×Ÿ',c:'home'},'cleaner':{he:'×—×•××¨ × ×™×§×•×™',c:'home'},'detergent':{he:'××‘×§×ª ×›×‘×™×¡×”',c:'home'},'softener':{he:'××¨×›×š ×›×‘×™×¡×”',c:'home'},'bleach':{he:'××§×•× ×•××™×§×”',c:'home'},'paper':{he:'× ×™×™×¨ ×˜×•××œ×˜',c:'home'},'towel':{he:'××’×‘×ª × ×™×™×¨',c:'home'},'paste':{he:'××©×—×ª ×©×™× ×™×™×',c:'home'},'brush':{he:'××‘×¨×©×ª',c:'home'},'deodorant':{he:'×“××•×“×•×¨× ×˜',c:'home'},'wipe':{he:'××’×‘×•× ×™×',c:'home'},'diaper':{he:'×—×™×ª×•×œ×™×',c:'home'},
            'sauce':{he:'×¨×•×˜×‘',c:'pantry'},'ketchup':{he:'×§×˜×©×•×¤',c:'fridge'},'mayo':{he:'××™×•× ×–',c:'fridge'},'mustard':{he:'×—×¨×“×œ',c:'fridge'},'vinegar':{he:'×—×•××¥',c:'pantry'},'soy':{he:'×¡×•×™×”',c:'pantry'},'spice':{he:'×ª×‘×œ×™×Ÿ',c:'pantry'},'salt':{he:'××œ×—',c:'pantry'},'pepper':{he:'×¤×œ×¤×œ',c:'pantry'},'paprika':{he:'×¤×¤×¨×™×§×”',c:'pantry'},'cumin':{he:'×›××•×Ÿ',c:'pantry'},'turmeric':{he:'×›×•×¨×›×•×',c:'pantry'}
        };
        const aisles = {'veg':'ğŸ¥¦ ×™×¨×§×•×ª','fridge':'â„ï¸ ××§×¨×¨','meat':'ğŸ¥© ×‘×©×¨','pantry':'ğŸ ××–×•×•×”','home':'ğŸ§´ ×‘×™×ª','other':'ğŸ›’ ×›×œ×œ×™'};

        window.onload=()=>{ renderCart(); renderHistory(); loadChecks(); updateScore(); };

        // UI
        function tog(h){h.nextElementSibling.classList.toggle('open')}
        function toggleModal(id){document.getElementById(id).classList.toggle('open')}
        function closeModal(id){document.getElementById(id).classList.remove('open')}
        function closeSheet(){document.getElementById('sheet-wrapper').classList.remove('active-sheet')}
        function updateName(val){ currentItem.name=val; }
        const chk=(id)=>document.getElementById(id).checked;
        function showToast(msg){ const t=document.getElementById('toast'); t.innerHTML=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
        function loadChecks(){ document.querySelectorAll('.save').forEach(el=>{ if(localStorage.getItem(el.id)==='true') el.checked=true; el.addEventListener('change',()=>localStorage.setItem(el.id,el.checked)); }); }
        function saveProfile(){ 
            user.w=document.getElementById('u-w').value; user.h=document.getElementById('u-h').value; user.age=document.getElementById('u-age').value;
            localStorage.setItem('vibeUser38',JSON.stringify(user)); closeModal('settings-modal'); showToast('×¤×¨×•×¤×™×œ × ×©××¨');
        }

        // CAMERA
        const scanner=new Html5Qrcode("reader");
        function startCamera(){
            document.getElementById('scanner-overlay').style.display='block';
            scanner.start({facingMode:"environment"},{fps:10,qrbox:250},(txt)=>{ stopCamera(); analyze(txt); })
                   .catch(()=>{alert("Camera Error"); stopCamera();});
        }
        function stopCamera(){
            scanner.stop().then(()=>document.getElementById('scanner-overlay').style.display='none')
                       .catch(()=>document.getElementById('scanner-overlay').style.display='none');
        }
        function manualSearch(){const c=prompt("×‘×¨×§×•×“:"); if(c) analyze(c);}

        // --- BRAIN: 100% LOGIC ---
        async function analyze(code){
            document.getElementById('sheet-wrapper').classList.add('active-sheet');
            document.getElementById('p-name').value="×˜×•×¢×Ÿ...";
            document.getElementById('tags-area').innerHTML="";
            
            try {
                const res=await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
                const data=await res.json();
                if(data.status!==1) throw new Error();
                const p=data.product;
                
                // 1. Translate & Categorize
                let name=p.product_name_he||p.product_name||"";
                let cat='other';
                let lowName=name.toLowerCase();
                for(const [k,v] of Object.entries(dict)){
                    if(lowName.includes(k)){
                        if(!p.product_name_he) name=v.he+" "+(p.brands||"");
                        cat=v.c; break;
                    }
                }
                
                currentItem={name:name, code:code, brand:p.brands||"", category:cat};
                document.getElementById('p-name').value=name;
                document.getElementById('p-brand').innerText=p.brands||"";
                document.getElementById('p-img').src=p.image_front_small_url||"";

                // 2. Deep Analysis
                const n=p.nutriments||{};
                const txt=(JSON.stringify(p.ingredients_text)+JSON.stringify(p.labels)).toLowerCase();
                const add=(p.additives_tags||[]).join(" ");
                let tags="";

                // ALLERGIES (Danger)
                const al = (id, k, t) => {
                    if (chk(id)) {
                        for (let w of k) {
                            if (txt.includes(w)) {
                                tags += `<div class="info-tag tag-danger">â›” ${t}</div>`;
                                return;
                            }
                        }
                    }
                };
                
                al('a-milk',['milk','lait','×—×œ×‘','whey'],'×—×œ×‘');
                al('a-gluten',['gluten','wheat','×—×™×˜×”','barley','rye'],'×’×œ×•×˜×Ÿ');
                al('a-nuts',['nut','almond','cashew','pecan','××’×•×–'],'××’×•×–×™×');
                al('a-peanuts',['peanut','×‘×•×˜× ×™×'],'×‘×•×˜× ×™×');
                al('a-soy',['soy','×¡×•×™×”'],'×¡×•×™×”');
                al('a-sesame',['sesame','×©×•××©×•×'],'×©×•××©×•×');
                al('a-eggs',['egg','oeuf','×‘×™×¦×™×'],'×‘×™×¦×™×');
                al('a-fish',['fish','×“×’'],'×“×’×™×/×™×•×“');
                al('a-sulfites',['sulfite','e220','e224'],'×¡×•×œ×¤×™×˜×™×');

                // MEDICAL (Warning/Info)
                if(chk('d-diabetic')&&(n.sugars_100g>5||n.carbohydrates_100g>50)) tags+=`<div class="info-tag tag-neutral">ğŸ¬ ×¡×•×›×¨/×¤×—××™××” ×’×‘×•×”</div>`;
                if(chk('d-heart')&&(n.salt_100g>1||n['saturated-fat_100g']>4)) tags+=`<div class="info-tag tag-neutral">ğŸ§‚ × ×ª×¨×Ÿ/×©×•××Ÿ ×¨×•×•×™ ×’×‘×•×”</div>`;
                if(chk('d-cholesterol')&&n.cholesterol_100g>0.05) tags+=`<div class="info-tag tag-neutral">ğŸ” ×›×•×œ×¡×˜×¨×•×œ</div>`;
                if(chk('d-gout')&&(txt.includes('liver')||txt.includes('yeast')||txt.includes('meat'))) tags+=`<div class="info-tag tag-neutral">ğŸ¦µ ×—×©×© ×¤×•×¨×™× ×™×</div>`;
                if(chk('d-kidney')&&(n.potassium_100g>0.3||add.includes('phosphate'))) tags+=`<div class="info-tag tag-neutral">ğŸ©º ××©×œ×’×Ÿ/×–×¨×—×Ÿ</div>`;
                if(chk('d-reflux')&&(txt.includes('spice')||txt.includes('tomato')||txt.includes('citrus')||txt.includes('mint'))) tags+=`<div class="info-tag tag-neutral">ğŸ”¥ ×—×•××¦×™×•×ª</div>`;
                if(chk('d-ibs')&&(txt.includes('onion')||txt.includes('garlic')||txt.includes('wheat')||txt.includes('milk'))) tags+=`<div class="info-tag tag-neutral">âš ï¸ ×—×©×© FODMAP</div>`;
                if(chk('d-anemia')&&(txt.includes('tea')||txt.includes('coffee')||n.calcium_100g>0.3)) tags+=`<div class="info-tag tag-neutral">ğŸ©¸ ××¢×›×‘ ×‘×¨×–×œ</div>`;

                // SENSITIVE
                if(chk('x-preg')&&(txt.includes('caffeine')||txt.includes('alcohol')||txt.includes('raw'))) tags+=`<div class="info-tag tag-danger">â›” ×”×¨×™×•×Ÿ (×§×¤××™×Ÿ/××œ×›×•×”×•×œ/× ×)</div>`;
                if(chk('x-baby')&&(n.sugars_100g>2||n.salt_100g>0.5||add.length>0)) tags+=`<div class="info-tag tag-danger">â›” ×œ× ×œ×ª×™× ×•×§×•×ª</div>`;
                if(chk('x-elderly')&&(txt.includes('hard')||txt.includes('nut'))) tags+=`<div class="info-tag tag-neutral">ğŸ‘´ ××¨×§× ×§×©×”</div>`;

                // DIET
                if(chk('l-vegan')&&(txt.includes('milk')||txt.includes('egg')||txt.includes('honey')||txt.includes('meat')||txt.includes('fish'))) tags+=`<div class="info-tag tag-neutral">âŒ ×œ× ×˜×‘×¢×•× ×™</div>`;
                if(chk('l-vegetarian')&&(txt.includes('meat')||txt.includes('fish'))) tags+=`<div class="info-tag tag-neutral">âŒ ×œ× ×¦××—×•× ×™</div>`;
                if(chk('l-keto')&&n.carbohydrates_100g>10) tags+=`<div class="info-tag tag-neutral">âŒ ×¤×—××™××” ×’×‘×•×”×” (×œ× ×§×˜×•)</div>`;
                if(chk('l-paleo')&&(txt.includes('sugar')||txt.includes('grain')||txt.includes('legume'))) tags+=`<div class="info-tag tag-neutral">âŒ ×œ× ×¤×œ×™××•</div>`;
                if(chk('c-clean')&&(add.includes('e2')||add.includes('e6')||add.includes('e1')||add.includes('e9'))) tags+=`<div class="info-tag tag-neutral">ğŸ§ª ×ª×•×¡×¤×™× ××œ××›×•×ª×™×™×</div>`;
                if(chk('c-sugar')&&n.sugars_100g>0.5) tags+=`<div class="info-tag tag-neutral">ğŸ­ ××›×™×œ ×¡×•×›×¨</div>`;

                // RELIGION
                if(chk('k-parve')&&(txt.includes('milk')||txt.includes('meat'))) tags+=`<div class="info-tag tag-neutral">âŒ ×œ× ×¤×¨×•×•×”</div>`;
                if(chk('k-passover')&&(txt.includes('leaven')||txt.includes('chametz')||txt.includes('beer'))) tags+=`<div class="info-tag tag-neutral">âŒ ×—××¥</div>`;

                // POSITIVE
                if(n.proteins_100g>10) tags+=`<div class="info-tag tag-good">ğŸ’ª ××§×•×¨ ×œ×—×œ×‘×•×Ÿ</div>`;
                if(n.fiber_100g>3) tags+=`<div class="info-tag tag-good">ğŸŒ¾ ×¡×™×‘×™× ×ª×–×•× ×ª×™×™×</div>`;
                if(chk('b-israel')&&code.startsWith('729')) tags+=`<div class="info-tag tag-good">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</div>`;

                document.getElementById('tags-area').innerHTML = tags || `<div class="info-tag tag-good">âœ¨ ×œ×œ× ××–×”×¨×•×ª ××™×•×—×“×•×ª</div>`;
                document.getElementById('bio-res').innerText = `${n['energy-kcal_100g']||0} ×§×œ×•×¨×™×•×ª | ${n.proteins_100g||0}g ×—×œ×‘×•×Ÿ | ${n.carbohydrates_100g||0}g ×¤×—××™××”`;

                // History
                history.unshift({name:name,code:code,date:new Date().toLocaleDateString()});
                if(history.length>20) history.pop();
                localStorage.setItem('vibeHistory',JSON.stringify(history));
                renderHistory();

            } catch(e) {
                document.getElementById('p-name').value="×œ× × ××¦× (×”×§×œ×“ ×©×)";
                currentItem.code=code;
            }
        }

        // CART & SCORE
        function addToCart(){
            cart.push(currentItem);
            renderCart(); updateScore(); closeSheet(); showToast("âœ… × ×•×¡×£ ×œ×¡×œ");
        }
        function renderCart(){
            const b=document.getElementById('cart-body'); b.innerHTML="";
            const grouped={};
            cart.forEach(i=>{ if(!grouped[i.category]) grouped[i.category]=[]; grouped[i.category].push(i); });
            
            const order=['veg','fridge','meat','pantry','home','other'];
            order.forEach(cat=>{
                if(grouped[cat]){
                    b.innerHTML+=`<div class="aisle-header">${aisles[cat]}</div>`;
                    grouped[cat].forEach(item=>{
                        const idx=cart.indexOf(item);
                        b.innerHTML+=`<div class="cart-item"><span>${item.name}</span><span onclick="del(${idx})" style="color:red;cursor:pointer;">âœ•</span></div>`;
                    });
                }
            });
            document.getElementById('d-cart').innerText=cart.length;
            localStorage.setItem('vibeCart38',JSON.stringify(cart));
        }
        function del(i){cart.splice(i,1); renderCart(); updateScore();}
        
        function updateScore(){
            let s=50; // Base
            cart.forEach(i=>{
                if(i.category==='veg') s+=5;
                if(i.category==='fridge') s+=2;
                if(i.category==='pantry') s+=1;
            });
            s=Math.min(100,Math.max(0,s));
            document.getElementById('basket-score-bar').style.width=s+"%";
            document.getElementById('score-text').innerText= s>80?"××¦×•×™×Ÿ ğŸ†":(s>50?"×××•×–×Ÿ ğŸ‘":"×˜×¢×•×Ÿ ×©×™×¤×•×¨");
        }

        function shareCart(){window.open(`https://wa.me/?text=×¨×©×™××ª ×§× ×™×•×ª:%0A${cart.map(i=>i.name).join('%0A')}`,'_blank');}
        function clearHistory(){history=[]; localStorage.removeItem('vibeHistory'); renderHistory();}
        function renderHistory(){
            const l=document.getElementById('history-list'); l.innerHTML="";
            history.forEach(i=>{l.innerHTML+=`<div class="cart-item" onclick="analyze('${i.code}')"><span>${i.name}</span><small>${i.date}</small></div>`});
        }

        // ACTIONS
        function comparePrecise(){
            let q=currentItem.code;
            if(document.getElementById('p-name').value!==currentItem.name) q=document.getElementById('p-name').value+" ××—×™×¨ site:.il";
            window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`,'_blank');
        }
        function findAlternatives(){
            window.open(`https://www.google.com/search?q=${encodeURIComponent(document.getElementById('p-name').value+" ×§× ×™×™×” ×‘×–×•×œ")}`,'_blank');
        }
    </script>
</body>
</html>
