<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Vibe OS 20.0 - Complete</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- MODERN VARIABLES (Obsidian Theme) --- */
        :root { 
            --primary: #00e676; 
            --danger: #ff3d00;
            --gold: #ffd600;
            --surface: #111111;
            --surface-light: #1e1e1e;
            --bg: #000000;
            --text: #ffffff;
            --text-muted: #888888;
            --radius: 20px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding-bottom: 160px; user-select: none;
        }
        
        /* HEADER */
        .header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.9); position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(10px); border-bottom: 1px solid #222;
        }
        .brand { font-size: 22px; font-weight: 800; background: linear-gradient(to right, #fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .icon-btn { font-size: 18px; padding: 10px; background: var(--surface-light); border-radius: 50%; cursor: pointer; border: 1px solid #333; }

        /* BENTO DASHBOARD */
        .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 20px; }
        .bento-card { 
            background: var(--surface); padding: 20px; border-radius: var(--radius); 
            display: flex; flex-direction: column; justify-content: space-between;
            border: 1px solid #222; position: relative; overflow: hidden;
        }
        .bento-card.wide { grid-column: span 2; background: linear-gradient(145deg, #1a1a1a, #0d0d0d); }
        .bento-val { font-size: 28px; font-weight: 700; margin-top: 5px; }
        .bento-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* FULL FILTERS (The Return of the Stack) */
        .filter-section { padding: 0 20px; }
        .acc { margin-bottom: 10px; border: 1px solid #222; background: var(--surface); border-radius: 12px; overflow: hidden; }
        .acc-head { 
            padding: 15px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            border-right: 4px solid transparent; transition: 0.2s;
        }
        .acc-body { display: none; padding: 15px; background: #080808; flex-wrap: wrap; gap: 8px; border-top: 1px solid #222; }
        .acc-body.open { display: flex; }

        /* Colors per category */
        .c-red .acc-head { border-right-color: var(--danger); }
        .c-blue .acc-head { border-right-color: var(--primary); }
        .c-purple .acc-head { border-right-color: #d500f9; }
        .c-gold .acc-head { border-right-color: var(--gold); }

        /* Modern Chips */
        .chip { display: none; }
        .lbl {
            padding: 8px 16px; background: #1a1a1a; border: 1px solid #333; border-radius: 50px; 
            font-size: 12px; cursor: pointer; color: #999; transition: 0.2s;
        }
        .chip:checked + .lbl { background: #eee; color: #000; border-color: #fff; font-weight: bold; }
        .danger .chip:checked + .lbl { background: var(--danger); color: white; border-color: var(--danger); }
        .safe .chip:checked + .lbl { background: var(--primary); color: black; border-color: var(--primary); }

        /* SCANNER HIDDEN */
        #scanner-container { margin: 20px; height: 300px; border-radius: var(--radius); overflow: hidden; background: #000; display:none; border: 2px solid var(--primary); }
        #reader { width: 100%; height: 100%; object-fit: cover; }

        /* BOTTOM SHEET */
        #sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 200; 
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #161616; 
            border-radius: 30px 30px 0 0; padding: 30px 25px 120px 25px; transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 201; border-top: 1px solid #333;
            max-height: 90vh; overflow-y: auto;
        }
        .active-sheet #sheet-overlay { opacity: 1; pointer-events: all; }
        .active-sheet #bottom-sheet { transform: translateY(0); }

        /* RESULTS UI */
        .prod-header { display: flex; gap: 15px; align-items: start; margin-bottom: 25px; }
        .prod-thumb { width: 80px; height: 80px; background: #fff; border-radius: 18px; object-fit: contain; padding: 5px; border: 1px solid #333; }
        .score-circle {
            width: 70px; height: 70px; border-radius: 50%; border: 4px solid #333; 
            display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 800;
        }
        
        .analysis-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin: 15px 0; font-size: 14px; line-height: 1.6; border: 1px solid #333; }
        
        /* FLOATING ACTION BAR */
        .action-bar {
            position: fixed; bottom: 20px; left: 20px; right: 20px; 
            background: rgba(20,20,20,0.95); backdrop-filter: blur(10px); padding: 10px; 
            border-radius: 100px; display: flex; gap: 5px; border: 1px solid #444; z-index: 300;
        }
        .float-btn {
            flex: 1; height: 50px; border: none; border-radius: 50px; font-weight: 700; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: white;
        }
        .btn-scan { background: var(--text); color: black; flex: 1.5; }
        .btn-ghost { background: transparent; color: #aaa; }

        /* FULL PROFILE EDITOR MODAL */
        #settings-modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:400; padding:20px; overflow-y:auto;
        }
        .inp { width: 100%; padding: 15px; background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 12px; margin-bottom: 10px; text-align: center; font-size: 16px; }
        .sec-title { color: var(--primary); font-size: 12px; font-weight: bold; margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }

    </style>
</head>
<body>

    <div class="header">
        <div class="brand">Vibe OS <span style="font-size:12px; opacity:0.5;">20.0</span></div>
        <div class="icon-btn" onclick="openSettings()">âš™ï¸ ×¤×¨×•×¤×™×œ ××œ×</div>
    </div>

    <div class="bento-grid">
        <div class="bento-card wide">
            <div class="bento-label">×ª×§×¦×™×‘ ×§×œ×•×¨×™ (TDEE)</div>
            <div class="bento-val" id="d-cals">...</div>
        </div>
        <div class="bento-card">
            <div class="bento-label">××˜×¨×”</div>
            <div class="bento-val" id="d-goal">...</div>
        </div>
        <div class="bento-card">
            <div class="bento-label">×‘×¡×œ ×”×§× ×™×•×ª</div>
            <div class="bento-val" id="d-cart">0</div>
        </div>
    </div>

    <div class="filter-section">
        <div style="font-size:11px; color:#666; margin:10px 0; font-weight:bold;">×”×’×“×¨×•×ª ×¡×™× ×•×Ÿ ××ª×§×“××•×ª</div>
        
        <div class="acc c-red">
            <div class="acc-head" onclick="tog('f1')">âš ï¸ ××œ×¨×’×™×•×ª (×¦×™×•×Ÿ 0) <span>â–¾</span></div>
            <div id="f1" class="acc-body danger">
                <input type="checkbox" id="a-milk" class="chip save"><label for="a-milk" class="lbl">ğŸ¥› ×—×œ×‘</label>
                <input type="checkbox" id="a-gluten" class="chip save"><label for="a-gluten" class="lbl">ğŸ ×’×œ×•×˜×Ÿ</label>
                <input type="checkbox" id="a-nuts" class="chip save"><label for="a-nuts" class="lbl">ğŸŒ° ××’×•×–×™×</label>
                <input type="checkbox" id="a-peanuts" class="chip save"><label for="a-peanuts" class="lbl">ğŸ¥œ ×‘×•×˜× ×™×</label>
                <input type="checkbox" id="a-soy" class="chip save"><label for="a-soy" class="lbl">ğŸ¥¢ ×¡×•×™×”</label>
                <input type="checkbox" id="a-sesame" class="chip save"><label for="a-sesame" class="lbl">ğŸ¥¯ ×©×•××©×•×</label>
                <input type="checkbox" id="a-eggs" class="chip save"><label for="a-eggs" class="lbl">ğŸ¥š ×‘×™×¦×™×</label>
                <input type="checkbox" id="a-fish" class="chip save"><label for="a-fish" class="lbl">ğŸŸ ×“×’×™×</label>
            </div>
        </div>

        <div class="acc c-red">
            <div class="acc-head" onclick="tog('f2')">ğŸ¥ ×¨×¤×•××™ ×•××—×œ×•×ª <span>â–¾</span></div>
            <div id="f2" class="acc-body danger">
                <input type="checkbox" id="d-diabetic" class="chip save"><label for="d-diabetic" class="lbl">ğŸ’‰ ×¡×•×›×¨×ª</label>
                <input type="checkbox" id="d-heart" class="chip save"><label for="d-heart" class="lbl">ğŸ«€ ×œ×‘ (× ×ª×¨×Ÿ/×©×•××Ÿ)</label>
                <input type="checkbox" id="d-celiac" class="chip save"><label for="d-celiac" class="lbl">ğŸŒ¾ ×¦×œ×™××§</label>
                <input type="checkbox" id="d-gout" class="chip save"><label for="d-gout" class="lbl">ğŸ¦¶ ×’××•×˜</label>
                <input type="checkbox" id="d-kidney" class="chip save"><label for="d-kidney" class="lbl">ğŸ©º ×›×œ×™×•×ª (××©×œ×’×Ÿ)</label>
                <input type="checkbox" id="d-reflux" class="chip save"><label for="d-reflux" class="lbl">ğŸ”¥ ×¦×¨×‘×ª</label>
            </div>
        </div>

        <div class="acc c-purple">
            <div class="acc-head" onclick="tog('f3')">ğŸ‘¶ ×¨×’×™×©×•×™×•×ª ××™×•×—×“×•×ª <span>â–¾</span></div>
            <div id="f3" class="acc-body danger">
                <input type="checkbox" id="x-preg" class="chip save"><label for="x-preg" class="lbl">ğŸ¤° ×”×¨×™×•×Ÿ</label>
                <input type="checkbox" id="x-baby" class="chip save"><label for="x-baby" class="lbl">ğŸ¼ ×ª×™× ×•×§×•×ª</label>
                <input type="checkbox" id="x-elderly" class="chip save"><label for="x-elderly" class="lbl">ğŸ‘´ ×’×™×œ ×©×œ×™×©×™</label>
            </div>
        </div>

        <div class="acc c-blue">
            <div class="acc-head" onclick="tog('f4')">âš¡ ×¡×¤×•×¨×˜ ×•×‘×™×¦×•×¢×™× <span>â–¾</span></div>
            <div id="f4" class="acc-body safe">
                <input type="checkbox" id="p-protein" class="chip save"><label for="p-protein" class="lbl">ğŸ’ª ×—×œ×‘×•×Ÿ ×’×‘×•×”</label>
                <input type="checkbox" id="p-bulk" class="chip save"><label for="p-bulk" class="lbl">ğŸ¦ ××¡×”</label>
                <input type="checkbox" id="p-cut" class="chip save"><label for="p-cut" class="lbl">âœ‚ï¸ ×—×™×˜×•×‘</label>
                <input type="checkbox" id="p-energy" class="chip save"><label for="p-energy" class="lbl">ğŸ”‹ ×× ×¨×’×™×”</label>
            </div>
        </div>

        <div class="acc c-gold">
            <div class="acc-head" onclick="tog('f5')">ğŸ¥— ×¢×¨×›×™× ×•×“×ª <span>â–¾</span></div>
            <div id="f5" class="acc-body safe">
                <input type="checkbox" id="l-vegan" class="chip save"><label for="l-vegan" class="lbl">ğŸŒ± ×˜×‘×¢×•× ×™</label>
                <input type="checkbox" id="c-sugar" class="chip save"><label for="c-sugar" class="lbl">ğŸ­ ×œ×œ× ×¡×•×›×¨</label>
                <input type="checkbox" id="b-israel" class="chip save" checked><label for="b-israel" class="lbl">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</label>
                <input type="checkbox" id="k-kosher" class="chip save"><label for="k-kosher" class="lbl">ğŸ“œ ×›×©×¨</label>
                <input type="checkbox" id="c-clean" class="chip save"><label for="c-clean" class="lbl">ğŸ§ª ×ª×•×•×™×ª × ×§×™×™×”</label>
            </div>
        </div>
    </div>

    <div id="scanner-container">
        <div id="reader"></div>
    </div>

    <div class="action-bar">
        <button class="float-btn btn-ghost" onclick="manualSearch()">âŒ¨ï¸ ×™×“× ×™</button>
        <button class="float-btn btn-scan" onclick="toggleCamera()">ğŸ“· ×¡×¨×•×§</button>
        <button class="float-btn btn-ghost" onclick="alert('×‘×§×¨×•×‘')">ğŸ•’ ×¢×‘×¨</button>
    </div>

    <div id="sheet-wrapper">
        <div id="sheet-overlay" onclick="closeSheet()"></div>
        <div id="bottom-sheet">
            <div style="width:40px; height:4px; background:#333; margin:0 auto 20px auto; border-radius:10px;"></div>
            
            <div class="prod-header">
                <img id="p-img" class="prod-thumb" src="" onerror="this.style.display='none'">
                <div style="flex:1">
                    <div id="p-brand" style="font-size:12px; color:#888;"></div>
                    <div id="p-name" style="font-size:20px; font-weight:800; line-height:1.2;"></div>
                    <div id="p-meta" style="font-size:11px; color:#666; margin-top:5px;"></div>
                </div>
                <div id="p-score" class="score-circle">--%</div>
            </div>

            <div id="bio-res" class="analysis-box"></div>
            <div id="filter-res"></div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:30px;">
                <button class="float-btn" style="background:#222; border:1px solid #444;" onclick="runSniper()">ğŸ¯ ×”×©×•×•××ª ××—×™×¨</button>
                <button class="float-btn" style="background:rgba(0,230,118,0.2); color:#00e676; border:1px solid #00e676;" onclick="addToCart()">ğŸ›’ ×”×•×¡×£ ×œ×¡×œ</button>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">×¤×¨×•×¤×™×œ ××œ×</h2>
            <button onclick="document.getElementById('settings-modal').style.display='none'" style="background:none; border:none; color:#666; font-size:24px;">&times;</button>
        </div>
        
        <div class="sec-title">× ×ª×•× ×™× ×¤×™×–×™×™×</div>
        <div style="display:flex; gap:10px;">
            <input type="number" id="u-w" class="inp" placeholder="××©×§×œ (×§×’)">
            <input type="number" id="u-h" class="inp" placeholder="×’×•×‘×” (×¡×)">
        </div>
        <input type="number" id="u-age" class="inp" placeholder="×’×™×œ">
        
        <div class="sec-title">×× ×ª×•× ×™ ××©×§×œ ×—×›×</div>
        <div style="display:flex; gap:10px;">
            <input type="number" id="u-fat" class="inp" placeholder="% ×©×•××Ÿ">
            <input type="number" id="u-visceral" class="inp" placeholder="×©×•××Ÿ ×‘×˜× ×™ (1-15)">
        </div>
        <input type="number" id="u-meta" class="inp" placeholder="×’×™×œ ××˜×‘×•×œ×™">

        <div class="sec-title">×”×’×“×¨×•×ª ××ª×§×“××•×ª</div>
        <select id="u-gender" class="inp">
            <option value="male">×’×‘×¨</option>
            <option value="female">××™×©×”</option>
        </select>
        <select id="u-activity" class="inp">
            <option value="1.2">×™×•×©×‘× ×™ (××©×¨×“)</option>
            <option value="1.375">×¤×¢×™×œ ×§×œ (1-3 ××™××•× ×™×)</option>
            <option value="1.55">×¤×¢×™×œ ×‘×™× ×•× ×™ (3-5 ××™××•× ×™×)</option>
            <option value="1.725">×¤×¢×™×œ ×××•×“ (×¡×¤×•×¨×˜××™)</option>
        </select>
        <select id="u-target" class="inp">
            <option value="maintain">×©××™×¨×” ×¢×œ ××©×§×œ</option>
            <option value="cut">×—×™×˜×•×‘ (×’×™×¨×¢×•×Ÿ ×§×œ×•×¨×™)</option>
            <option value="bulk">××¡×” (×¢×•×“×£ ×§×œ×•×¨×™)</option>
        </select>

        <button onclick="saveProfile()" class="float-btn btn-scan" style="width:100%; margin-top:20px;">×©××•×¨ ×•×¢×“×›×Ÿ ××œ×’×•×¨×™×ª×</button>
    </div>

    <script>
        // --- VIBE OS 20.0 CORE ---
        
        let user = { w: 75, h: 175, age: 30, gender: 'male', target: 'maintain', activity: 1.2, metaAge: 30, fat: 18, visceral: 5, tdee: 2000 };
        let currentProd = { name: '', brand: '', exactQuery: '' };
        let cart = 0;
        let isCamOpen = false;

        window.onload = () => { loadUser(); setupHaptics(); };

        // --- Logic & Haptics ---
        function setupHaptics() {
            document.querySelectorAll('button, input[type=checkbox]').forEach(el => {
                el.addEventListener('click', () => { if(navigator.vibrate) navigator.vibrate(10); });
            });
        }

        function tog(id) { document.getElementById(id).classList.toggle('open'); }
        function openSettings() { document.getElementById('settings-modal').style.display = 'block'; }
        
        function saveProfile() {
            const get = (id) => document.getElementById(id).value;
            if(get('u-w')) user.w = Number(get('u-w'));
            if(get('u-h')) user.h = Number(get('u-h'));
            if(get('u-age')) user.age = Number(get('u-age'));
            if(get('u-fat')) user.fat = Number(get('u-fat'));
            if(get('u-visceral')) user.visceral = Number(get('u-visceral'));
            if(get('u-meta')) user.metaAge = Number(get('u-meta'));
            
            user.gender = get('u-gender');
            user.activity = Number(get('u-activity'));
            user.target = get('u-target');

            // Complex TDEE Calc
            let bmr = 10 * user.w + 6.25 * user.h - 5 * user.age;
            bmr += (user.gender === 'male') ? 5 : -161;
            let tdee = bmr * user.activity;
            if (user.metaAge < user.age) tdee += 100; // Metabolism bonus
            if(user.target === 'cut') tdee -= 500;
            if(user.target === 'bulk') tdee += 300;
            
            user.tdee = Math.round(tdee);
            localStorage.setItem('vibeUser20', JSON.stringify(user));
            updateDash();
            document.getElementById('settings-modal').style.display = 'none';
        }

        function loadUser() {
            const saved = localStorage.getItem('vibeUser20');
            if(saved) user = JSON.parse(saved);
            updateDash();
            // Load checkbox states
            document.querySelectorAll('.save').forEach(el => {
                if(localStorage.getItem(el.id) === 'true') el.checked = true;
                el.addEventListener('change', () => localStorage.setItem(el.id, el.checked));
            });
        }

        function updateDash() {
            document.getElementById('d-cals').innerText = user.tdee;
            const map = {cut:'×—×™×˜×•×‘', maintain:'×©××™×¨×”', bulk:'××¡×”'};
            document.getElementById('d-goal').innerText = map[user.target];
        }

        // --- Camera & Sheet ---
        function toggleCamera() {
            const el = document.getElementById('scanner-container');
            if(isCamOpen) { html5QrCode.stop(); el.style.display = 'none'; isCamOpen = false; }
            else { el.style.display = 'block'; startScanner(); isCamOpen = true; }
        }
        function closeSheet() { document.getElementById('sheet-wrapper').classList.remove('active-sheet'); }

        const html5QrCode = new Html5Qrcode("reader");
        function startScanner() {
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 250, height: 250 } }, (txt) => {
                toggleCamera(); analyze(txt);
            }).catch(e => console.log(e));
        }

        function manualSearch() { const c = prompt("×‘×¨×§×•×“:"); if(c) analyze(c); }

        // --- ULTIMATE ANALYSIS ENGINE (Merged v18 Logic) ---
        async function analyze(code) {
            document.getElementById('sheet-wrapper').classList.add('active-sheet');
            document.getElementById('p-name').innerText = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
            
            try {
                const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
                const data = await res.json();
                if(data.status !== 1) throw new Error("Not found");

                const p = data.product;
                const name = p.product_name_he || p.product_name || "××•×¦×¨ ×›×œ×œ×™";
                const brand = p.brands || "";
                
                // Sniper Data
                currentProd.name = name;
                currentProd.exactQuery = `${brand} ${name} ${p.quantity || ''}`;

                document.getElementById('p-name').innerText = name;
                document.getElementById('p-brand').innerText = brand;
                document.getElementById('p-img').src = p.image_front_small_url || '';
                document.getElementById('p-meta').innerText = `${p.quantity || ''} | ${code}`;

                // --- 60 Parameter Logic ---
                const n = p.nutriments || {};
                const txt = (p.ingredients_text || "").toLowerCase() + " " + (p.labels || "").toLowerCase();
                const tags = (p._keywords || []).join(" ").toLowerCase();
                const additives = (p.additives_tags || []).join(" ");
                const chk = (id) => document.getElementById(id).checked;

                let score = 100;
                let flags = [];
                let info = [];

                // 1. Critical Filters
                const crit = (id, keys, msg) => {
                    if(chk(id)) {
                        for(let k of keys) if(txt.includes(k) || tags.includes(k)) { score=0; flags.push(`â›” ${msg}`); return; }
                    }
                };
                crit('a-milk', ['milk','lait','×—×œ×‘','whey'], '××›×™×œ ×—×œ×‘');
                crit('a-gluten', ['gluten','wheat','×—×™×˜×”','barley'], '××›×™×œ ×’×œ×•×˜×Ÿ');
                crit('a-nuts', ['nut','almond','××’×•×–','cashew'], '××›×™×œ ××’×•×–×™×');
                crit('a-peanuts', ['peanut','×‘×•×˜× ×™×'], '××›×™×œ ×‘×•×˜× ×™×');
                
                // 2. Medical Penalties
                if(chk('d-diabetic') && (n.sugars_100g > 5 || n.carbohydrates_100g > 50)) { score-=50; flags.push("âš ï¸ ×¡×•×›×¨/×¤×—××™××” ×’×‘×•×”×” (×¡×•×›×¨×ª)"); }
                if(chk('d-heart') && (n.salt_100g > 1 || n['saturated-fat_100g'] > 4)) { score-=40; flags.push("âš ï¸ × ×ª×¨×Ÿ/×©×•××Ÿ ×’×‘×•×” (×œ×‘)"); }
                if(chk('d-kidney') && n.potassium_100g > 0.3) { score-=40; flags.push("âš ï¸ ××©×œ×’×Ÿ ×’×‘×•×”"); }
                
                // 3. Religion/Lifestyle
                if(chk('k-parve') && (txt.includes('milk') || txt.includes('meat'))) { score=0; flags.push("â›” ×œ× ×¤×¨×•×•×”"); }
                if(chk('l-vegan') && (txt.includes('milk') || txt.includes('egg') || txt.includes('honey'))) { score=0; flags.push("â›” ×œ× ×˜×‘×¢×•× ×™"); }
                if(chk('c-clean') && (additives.includes('e2') || additives.includes('e6'))) { score-=20; flags.push("ğŸ§ª ×ª×•×¡×¤×™× ××œ××›×•×ª×™×™×"); }

                // 4. Biometric/Goals
                const cal = n['energy-kcal_100g'] || 0;
                if(user.target === 'cut' && cal > 280) { score-=30; flags.push(`ğŸ“‰ ×¦×¤×•×£ ×§×œ×•×¨×™×ª (${cal})`); }
                if(user.visceral > 9 && n['saturated-fat_100g'] > 3) { score-=25; flags.push("ğŸ©¸ ×©×•××Ÿ ×‘×˜× ×™ ×’×‘×•×”"); }

                // 5. Israel
                if(chk('b-israel')) {
                    if(!code.startsWith('729')) { score-=10; flags.push("ğŸŒ ×™×‘×•× (×œ× ×™×©×¨××œ×™)"); }
                    else { score+=5; info.push("ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥"); }
                }

                if(score<0) score=0; if(score>100) score=100;

                // Render Results
                const scoreEl = document.getElementById('p-score');
                scoreEl.innerText = score + "%";
                scoreEl.style.borderColor = score > 70 ? 'var(--primary)' : (score > 40 ? 'var(--gold)' : 'var(--danger)');
                scoreEl.style.color = scoreEl.style.borderColor;

                document.getElementById('bio-res').innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span>ğŸ”¥ <b>${cal}</b> ×§×§"×œ</span>
                        <span>ğŸ’ª <b>${n.proteins_100g || 0}g</b> ×—×œ×‘×•×Ÿ</span>
                    </div>
                    <div style="font-size:12px; color:#888; margin-top:5px;">××”×•×•×” ${Math.round((cal/user.tdee)*100)}% ××”×ª×§×¦×™×‘ ×”×™×•××™</div>
                `;

                let html = "";
                if(flags.length) html += flags.map(f => `<div style="padding:10px; background:#300; border-radius:8px; margin-top:5px; color:#ff8a80;">${f}</div>`).join('');
                if(info.length) html += info.map(i => `<div style="padding:10px; background:#003300; border-radius:8px; margin-top:5px; color:#69f0ae;">${i}</div>`).join('');
                if(!html) html = `<div style="padding:10px; background:#1a1a1a; border-radius:8px; margin-top:5px; color:#aaa;">×”××•×¦×¨ ×ª×•×× ××ª ×”×¤×¨×•×¤×™×œ.</div>`;
                
                document.getElementById('filter-res').innerHTML = html;

            } catch(e) {
                alert("×œ× × ××¦×"); closeSheet();
            }
        }

        // --- ACTIONS ---
        function runSniper() {
            window.open(`https://www.google.com/search?tbm=shop&q=${encodeURIComponent(currentProd.exactQuery)}`, '_blank');
        }
        function addToCart() {
            cart++; document.getElementById('d-cart').innerText = cart;
            if(navigator.vibrate) navigator.vibrate(50);
            closeSheet();
        }

    </script>
</body>
</html>
