<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Vibe OS OMEGA</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* ================================================================
           1. CORE & VARIABLES
           ================================================================ 
        */
        :root { 
            --bg-body: #050505; --bg-app: #000000; 
            --surface: #141416; --surface-2: #1e1e20; --surface-3: #2c2c2e;
            --border: #333;
            
            --plasma-1: #6366f1; --plasma-2: #d946ef; --plasma-3: #0ea5e9;
            
            /* Enhanced Grading Colors (Vivid) */
            --grade-a-plus: #00ff80; 
            --grade-a: #2ebb56; 
            --grade-b: #aadd00; 
            --grade-c: #ffcc00; 
            --grade-d: #ff9500; 
            --grade-e: #ff3b30;
            
            --cat-ethics: #10b981; 
            --cat-sensory: #f97316;
            --cat-quality: #06b6d4;
            
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --max-w: 440px; 
            --shadow-glow: 0 10px 40px rgba(99, 102, 241, 0.25);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; font-family: var(--font); }
        body { background: var(--bg-body); color: #fff; margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }

        /* BOOT SCREEN */
        #boot-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .boot-logo { font-size: 48px; font-weight: 900; letter-spacing: 4px; background: linear-gradient(135deg, var(--plasma-3), var(--plasma-1), var(--plasma-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: pulse 2s infinite; }
        .boot-bar { width: 140px; height: 4px; background: #222; margin-top: 30px; border-radius: 2px; overflow: hidden; }
        .boot-fill { width: 0%; height: 100%; background: var(--plasma-1); animation: load 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes load { 0% {width:0%} 100% {width:100%} }
        @keyframes pulse { 0% {opacity:0.6} 50% {opacity:1} 100% {opacity:0.6} }

        /* APP FRAME */
        #app-frame { width: 100%; max-width: var(--max-w); height: 100%; max-height: 95vh; background: var(--bg-app); position: relative; border-radius: 44px; box-shadow: 0 0 0 12px #080808, 0 0 0 14px #1a1a1a, 0 20px 80px rgba(0,0,0,0.8); overflow: hidden; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.5s; }
        #app-frame.loaded { opacity: 1; }
        @media (max-width: 480px) { body { align-items: flex-start; } #app-frame { max-width: 100%; height: 100vh; max-height: 100vh; border-radius: 0; box-shadow: none; border: none; } }

        #app-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 140px; scrollbar-width: none; }
        
        /* HEADER */
        .app-header { background: rgba(10, 10, 12, 0.9); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); padding: 18px 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo-neo { font-size: 20px; font-weight: 900; letter-spacing: 2px; background: linear-gradient(90deg, #fff, var(--plasma-3)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* SMART DASHBOARD GRID */
        .dashboard { padding: 20px 24px; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: 14px; }
        
        /* Full Width User Card */
        .card.user-card { 
            grid-column: 1 / -1; 
            background: linear-gradient(160deg, var(--surface-2), #000); 
            border: 1px solid var(--border); border-left: 4px solid var(--plasma-1);
            border-radius: 20px; padding: 20px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* Stat Cards */
        .card.stat { 
            background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 18px; 
            display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; cursor: pointer; transition: 0.2s;
        }
        .card.stat:active { transform: scale(0.97); background: var(--surface-2); }

        .c-lbl { font-size: 11px; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .c-val { font-size: 28px; font-weight: 800; margin-top: 6px; letter-spacing: -0.5px; }
        
        /* Score Ring UI */
        .score-box { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
        .mini-ring { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--surface-2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: #fff; }

        /* QUICK BOX */
        .quick-box { padding: 5px 24px; display: flex; gap: 10px; margin-top: 5px; }
        .quick-inp { flex: 1; background: var(--surface); border: 1px solid var(--border); padding: 16px; border-radius: 16px; color: #fff; text-align: right; font-size: 15px; transition: 0.2s; }
        .quick-inp:focus { border-color: var(--plasma-1); background: #000; }
        .quick-btn { width: 54px; background: var(--plasma-1); border: none; border-radius: 16px; font-size: 24px; color: #fff; cursor: pointer; box-shadow: 0 5px 20px rgba(99,102,241,0.3); }

        .prefs-container { padding: 15px 24px; display: flex; flex-wrap: wrap; gap: 8px; }
        .pref-tag { font-size: 11px; background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 8px; color: #ccc; border: 1px solid var(--border); }

        /* DOCK */
        .dock { position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 360px; height: 72px; background: rgba(22,22,24,0.95); backdrop-filter: blur(30px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; padding: 0 35px; z-index: 500; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
        .dock-icon { font-size: 24px; cursor: pointer; color: #666; transition: 0.2s; }
        .dock-icon:active { color: #fff; transform: scale(0.9); }
        
        .scan-fab { 
            width: 64px; height: 64px; background: linear-gradient(135deg, var(--plasma-1), var(--plasma-3)); 
            border-radius: 22px; display: flex; align-items: center; justify-content: center; 
            font-size: 28px; margin-top: -50px; box-shadow: var(--shadow-glow); 
            cursor: pointer; color: #fff; border: 5px solid var(--bg-app); transform: rotate(45deg); transition: 0.2s;
        }
        .scan-fab span { transform: rotate(-45deg); display: block; font-size: 26px; }
        .scan-fab:active { transform: rotate(45deg) scale(0.9); }

        /* MODALS */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: flex-end; opacity: 0; transition: 0.3s; }
        .modal.open { display: flex; opacity: 1; }
        .modal-sheet { 
            width: 100%; background: #111; border-radius: 36px 36px 0 0; padding: 0;
            max-height: 92vh; height: auto; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.2, 0.9, 0.2, 1);
            border-top: 1px solid var(--border); overflow: hidden;
        }
        .modal.open .modal-sheet { transform: translateY(0); }

        .m-head { padding: 25px 25px 15px 25px; display: flex; justify-content: space-between; align-items: center; background: #111; z-index: 10; border-bottom: 1px solid var(--border); }
        .m-title { font-size: 22px; font-weight: 800; color: #fff; }
        .m-close { width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        
        .m-content { padding: 20px 25px 120px 25px; overflow-y: auto; flex: 1; } /* Padding bottom for floating buttons */

        /* FLOATING BOTTOM BAR IN MODAL */
        .m-footer { 
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px 25px 40px 25px; 
            background: linear-gradient(to top, #000 80%, transparent); pointer-events: none; 
            display: flex; flex-direction: column; gap: 10px;
        }
        .m-footer button { pointer-events: auto; }

        /* ACCORDION */
        .acc { background: var(--surface); border-radius: 14px; margin-bottom: 10px; overflow: hidden; border: 1px solid var(--border); }
        .acc-head { padding: 16px; font-weight: 700; display: flex; justify-content: space-between; cursor: pointer; font-size: 14px; }
        .acc-body { display: none; padding: 15px; background: #080808; flex-wrap: wrap; gap: 8px; border-top: 1px solid var(--border); }
        .acc-body.open { display: flex; }
        
        .c-red .acc-head { color: var(--grade-e); border-right: 3px solid var(--grade-e); }
        .c-teal .acc-head { color: var(--cat-quality); border-right: 3px solid var(--cat-quality); }

        .chip { display: none; }
        .chip-lbl { padding: 10px 14px; background: #1a1a1a; border-radius: 10px; font-size: 13px; color: #888; cursor: pointer; border: 1px solid #333; font-weight: 600; transition: 0.2s; }
        .chip:checked + .chip-lbl { background: #eee; color: #000; border-color: #fff; }
        .quality .chip:checked + .chip-lbl { background: rgba(6, 182, 212, 0.2); color: var(--cat-quality); border-color: var(--cat-quality); }

        /* RESULT & SCANNER */
        .grade-circle { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; font-size: 50px; font-weight: 900; color: #000; box-shadow: 0 0 40px currentColor; flex-shrink: 0; }
        .alert-box { padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; font-size: 13px; border: 1px solid transparent; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        .btn-main { width: 100%; padding: 16px; border-radius: 16px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; background: linear-gradient(90deg, var(--plasma-1), var(--plasma-3)); color: #fff; box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3); }
        .btn-sec { width: 100%; padding: 16px; border-radius: 16px; font-weight: 700; font-size: 16px; cursor: pointer; background: var(--surface-2); color: #fff; border: 1px solid var(--border); }

        #cam-view { position: relative; width: 100%; height: 100%; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .laser { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--grade-e); box-shadow: 0 0 20px var(--grade-e); animation: scan 1.5s infinite; z-index: 10; }
        @keyframes scan { 0% {top:10%} 50% {top:90%} 100% {top:10%} }

        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--surface); border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border); }
        
        #toast { position: absolute; top: 40px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #222; color: #fff; padding: 10px 25px; border-radius: 50px; transition: 0.4s; z-index: 3000; font-weight: 600; border: 1px solid #444; white-space: nowrap; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

<div id="boot-screen">
    <div class="boot-logo">VIBE OS</div>
    <div class="boot-bar"><div class="boot-fill"></div></div>
    <div style="margin-top:10px; font-size:10px; color:#666; letter-spacing:2px;">OMEGA SYSTEM LOADING</div>
</div>

<div id="app-frame">
    <div id="toast"></div>
    <div class="app-header">
        <div class="logo-box"><span style="font-weight:700;">VIBE</span> <span class="logo-neo">OMEGA</span></div>
    </div>

    <div id="app-content">
        <div class="dashboard">
            <div class="card user-card" onclick="openEdit(activeId)">
                <div>
                    <div class="c-lbl">×©×œ×•×,</div>
                    <div id="d-name" style="font-size:22px; font-weight:800; color:#fff;">×˜×•×¢×Ÿ...</div>
                </div>
                <div style="width:40px; height:40px; background:rgba(255,255,255,0.1); border-radius:12px; display:flex; align-items:center; justify-content:center;">âš™ï¸</div>
            </div>

            <div class="card stat" onclick="openRing()">
                <div class="c-lbl">×¡×˜×˜×•×¡ ×’×•×¤× ×™</div>
                <div id="d-status" class="c-val" style="color:var(--grade-a);">×¨×’×™×œ</div>
            </div>

            <div class="card stat" onclick="openModal('cart')">
                <div class="c-lbl">×¦×™×•×Ÿ ×¡×œ</div>
                <div class="score-box">
                    <div id="cart-score" class="c-val">100%</div>
                    <div class="mini-ring"><span id="d-count">0</span></div>
                </div>
            </div>
        </div>

        <div class="quick-box">
            <button class="quick-btn" onclick="quickAdd()">+</button>
            <input type="text" id="q-inp" class="quick-inp" placeholder="×”×•×¡×¤×” ×œ×‘×™×ª...">
        </div>

        <div class="prefs-container" id="d-prefs"></div>
    </div>

    <div class="dock">
        <div class="dock-icon" onclick="openCart()">ğŸ›’</div>
        <div class="scan-fab" onclick="startScanner()"><span>ğŸ“·</span></div>
        <div class="dock-icon" onclick="openHistory()">ğŸ“œ</div>
    </div>

    <div id="modal-edit" class="modal"><div class="modal-sheet">
        <div class="m-head"><div class="m-title">×”×’×“×¨×•×ª ×¤×¨×•×¤×™×œ</div><div class="m-close" onclick="closeModal('edit')">âœ•</div></div>
        
        <div class="m-content">
            <input type="text" id="edit-name" style="width:100%; padding:14px; background:var(--surface-2); border:1px solid var(--border); border-radius:12px; color:#fff; text-align:center; margin-bottom:20px; font-size:16px;" placeholder="×©× ×”××©×ª××©">
            
            <div style="font-weight:700; margin-bottom:15px; color:#888; font-size:14px; text-transform:uppercase;">×§×˜×’×•×¨×™×•×ª ×¡×™× ×•×Ÿ:</div>
            
            <div class="acc c-teal"><div class="acc-head" onclick="tog(this)">ğŸ… ××™×›×•×ª ×•×“×™×¨×•×’ <span>â–¼</span></div><div class="acc-body quality">
                <input type="checkbox" id="q-nored" class="chip"><label for="q-nored" class="chip-lbl">ğŸš« ×œ×œ× ××“×‘×§×•×ª ××“×•××•×ª</label>
                <input type="checkbox" id="q-green" class="chip"><label for="q-green" class="chip-lbl">âœ… ×ª×• ×™×¨×•×§ ×‘×œ×‘×“</label>
                <input type="checkbox" id="q-natural" class="chip"><label for="q-natural" class="chip-lbl">ğŸƒ 100% ×˜×‘×¢×™</label>
                <input type="checkbox" id="g-high" class="chip"><label for="g-high" class="chip-lbl">â­ ×¦×™×•× ×™ A-B ×‘×œ×‘×“</label>
            </div></div>

            <div class="acc c-red"><div class="acc-head" onclick="tog(this)">âš ï¸ ××œ×¨×’×™×•×ª <span>â–¼</span></div><div class="acc-body danger" id="sec-allergy">
                <div style="width:100%; text-align:center; padding:10px; border:1px solid var(--grade-e); color:var(--grade-e); border-radius:10px; margin-bottom:5px; cursor:pointer;" onclick="clearSec('sec-allergy')">× ×§×” ×”×›×œ</div>
                <input type="checkbox" id="a-milk" class="chip"><label for="a-milk" class="chip-lbl">ğŸ¥› ×—×œ×‘</label>
                <input type="checkbox" id="a-gluten" class="chip"><label for="a-gluten" class="chip-lbl">ğŸ ×’×œ×•×˜×Ÿ</label>
                <input type="checkbox" id="a-nuts" class="chip"><label for="a-nuts" class="chip-lbl">ğŸŒ° ××’×•×–×™×</label>
                <input type="checkbox" id="a-peanuts" class="chip"><label for="a-peanuts" class="chip-lbl">ğŸ¥œ ×‘×•×˜× ×™×</label>
                <input type="checkbox" id="a-sesame" class="chip"><label for="a-sesame" class="chip-lbl">ğŸ¥¯ ×©×•××©×•×</label>
                <input type="checkbox" id="a-soy" class="chip"><label for="a-soy" class="chip-lbl">ğŸ¥¢ ×¡×•×™×”</label>
                <input type="checkbox" id="a-eggs" class="chip"><label for="a-eggs" class="chip-lbl">ğŸ¥š ×‘×™×¦×™×</label>
                <input type="checkbox" id="a-fish" class="chip"><label for="a-fish" class="chip-lbl">ğŸŸ ×“×’×™×</label>
            </div></div>
            
            <div style="height:50px;"></div> </div>

        <div class="m-footer">
            <button class="btn-main" onclick="saveProfile()">×©××•×¨ ×©×™× ×•×™×™×</button>
            <button class="btn-sec" style="color:var(--grade-e); border-color:var(--grade-e);" onclick="deleteProfile()">××—×§ ×¤×¨×•×¤×™×œ</button>
        </div>
    </div></div>

    <div id="modal-cart" class="modal"><div class="modal-sheet">
        <div class="m-head"><div class="m-title">×¢×’×œ×”</div><div class="m-close" onclick="closeModal('cart')">âœ•</div></div>
        <div class="m-content" id="cart-content"></div>
        <div class="m-footer">
            <div style="display:flex; gap:10px;">
                <input type="text" id="c-inp" class="quick-inp" placeholder="×”×•×¡×¤×” ×™×“× ×™×ª...">
                <button class="quick-btn" onclick="quickAddCart()">+</button>
            </div>
        </div>
    </div></div>

    <div id="modal-hist" class="modal"><div class="modal-sheet">
        <div class="m-head"><div class="m-title">×”×™×¡×˜×•×¨×™×”</div><div class="m-close" onclick="closeModal('hist')">âœ•</div></div>
        <div class="m-content" id="hist-content"></div>
    </div></div>

    <div id="modal-ring" class="modal"><div class="modal-sheet">
        <div class="m-head"><div class="m-title">Vibe Ring</div><div class="m-close" onclick="closeModal('ring')">âœ•</div></div>
        <div class="m-content">
            <div class="ring-grid">
                <div class="r-opt" onclick="setRing('normal')">ğŸŸ¢ ×¨×’×™×œ</div>
                <div class="r-opt" onclick="setRing('stress')">ğŸ¤¯ ×¡×˜×¨×¡</div>
                <div class="r-opt" onclick="setRing('sick')">ğŸ¤’ ×—×•×œ×™</div>
                <div class="r-opt" onclick="setRing('cycle')">ğŸŒ¸ ××—×–×•×¨</div>
                <div class="r-opt" onclick="setRing('sport')">ğŸ’ª ××™××•×Ÿ</div>
                <div class="r-opt" onclick="setRing('sugar')">ğŸ©¸ ×¡×•×›×¨</div>
                <div class="r-opt" onclick="setRing('tired')">ğŸ˜´ ×¢×™×™×¤×•×ª</div>
                <div class="r-opt" onclick="setRing('dehyd')">ğŸ’§ ×™×•×‘×©</div>
            </div>
        </div>
    </div></div>

    <div id="modal-res" class="modal"><div class="modal-sheet" style="text-align:center;">
        <div class="m-head" style="justify-content:flex-end;"><div class="m-close" onclick="closeModal('res')">âœ•</div></div>
        <div class="m-content">
            <div style="font-size:12px; font-weight:700; color:#888; text-transform:uppercase; letter-spacing:2px; margin-bottom:10px;">×¦×™×•×Ÿ NEO</div>
            <div id="r-grade" class="grade-circle" style="background:var(--grade-a);">A</div>
            <div id="r-name" style="font-size:28px; font-weight:800; margin:10px 0 5px 0; line-height:1.1;">×©×</div>
            <div id="r-brand" style="font-size:16px; color:#888; margin-bottom:25px;">××•×ª×’</div>
            <div id="res-alert"></div>
        </div>
        <div class="m-footer">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <button class="btn-main" onclick="addToCart(true)">+ ×œ×‘×™×ª</button>
                <button class="btn-sec" onclick="addToCart(false)">+ ×œ×™</button>
            </div>
        </div>
    </div></div>

    <div id="modal-scan" class="modal"><div class="modal-sheet" style="height:100%; padding:0; background:#000; border-radius:0;">
        <div id="cam-view">
            <div id="reader" style="width:100%; height:100%; object-fit:cover;"></div>
            <div class="laser"></div>
            <div style="position:absolute; bottom:50px; width:100%; display:flex; justify-content:center; z-index:20;">
                <button onclick="stopScanner()" style="background:rgba(20,20,20,0.8); border:1px solid rgba(255,255,255,0.2); color:#fff; padding:15px 40px; border-radius:30px; font-weight:700; backdrop-filter:blur(10px); display:flex; align-items:center; gap:10px;">
                    <span>âœ•</span> ×‘×™×˜×•×œ
                </button>
            </div>
        </div>
    </div></div>

</div>

<script>
    // --- 1. GLOBAL STATE & CONFIG ---
    window.tempScan = null;
    let html5QrcodeScanner = null;
    let isScanning = false;

    // --- 2. DATABASE ENGINE ---
    // Expanded core for simulation
    const DB_CORE = [
        {n:'×œ×—× ××œ×', cat:'bakery', g:'A', gl:true}, {n:'×œ×—× ××—×™×“', cat:'bakery', g:'C', gl:true, sug:true},
        {n:'×—×œ×‘ 3%', cat:'dairy', g:'B', da:true, liquid:true}, {n:'×—×œ×‘ ×¡×•×™×”', cat:'dairy', g:'A', soy:true, ethics:true},
        {n:'×§×•×˜×’\'', cat:'dairy', g:'A', da:true}, {n:'×’×‘×™× ×” ×¦×”×•×‘×”', cat:'dairy', g:'D', da:true, proc:true},
        {n:'××™×œ×§×™', cat:'dairy', g:'E', da:true, sug:true}, {n:'×§×•×œ×”', cat:'drink', g:'E', sug:true, caff:true},
        {n:'×§×•×œ×” ×–×™×¨×•', cat:'drink', g:'D', caff:true}, {n:'×‘××‘×”', cat:'snack', g:'C', nut:true},
        {n:'×‘×™×¡×œ×™', cat:'snack', g:'E', gl:true, proc:true}, {n:'×ª×¤×•×¦\'×™×¤×¡', cat:'snack', g:'D', proc:true},
        {n:'×©×•×§×•×œ×“ ×¤×¨×”', cat:'snack', g:'E', da:true, sug:true}, {n:'×¤×¡×˜×”', cat:'pantry', g:'B', gl:true},
        {n:'××•×¨×–', cat:'pantry', g:'B'}, {n:'××œ×¤×¤×•×Ÿ', cat:'fresh', g:'A'}, {n:'×¢×’×‘× ×™×”', cat:'fresh', g:'A'},
        {n:'×©× ×™×¦×œ ×ª×™×¨×¡', cat:'frozen', g:'C', gl:true, proc:true}, {n:'×˜×•× ×”', cat:'pantry', g:'A', fish:true}
    ];
    const BRANDS = ['×ª× ×•×‘×”','×©×˜×¨××•×¡','××¡×','×¢×œ×™×ª','×ª×œ××”','×˜×¨×”','×¨××™ ×œ×•×™','×©×•×¤×¨×¡×œ','×’×“','×˜×‘×¢×•×œ'];
    
    // --- 3. APP INIT ---
    let users = JSON.parse(localStorage.getItem('vOmega_users')) || [{id:1, name:'×× ×™', img:null, status:'normal', filters:[], pList:[]}];
    let cart = JSON.parse(localStorage.getItem('vOmega_cart')) || [];
    let history = JSON.parse(localStorage.getItem('vOmega_hist')) || [];
    let activeId = users[0].id;

    const STATES = {
        'normal':{t:'×¨×’×™×œ',c:'var(--grade-a)'}, 'stress':{t:'×¡×˜×¨×¡',c:'var(--grade-e)'}, 'sick':{t:'×—×•×œ×™',c:'var(--plasma-2)'},
        'cycle':{t:'××—×–×•×¨',c:'var(--plasma-2)'}, 'sport':{t:'××™××•×Ÿ',c:'var(--plasma-3)'}, 'sugar':{t:'×¡×•×›×¨',c:'var(--grade-d)'},
        'tired':{t:'×¢×™×™×¤×•×ª',c:'var(--grade-c)'}, 'dehyd':{t:'×™×•×‘×©',c:'var(--plasma-3)'}
    };

    window.onload = () => {
        // Boot Animation Logic
        setTimeout(() => {
            const boot = document.getElementById('boot-screen');
            boot.style.opacity = 0;
            // QA Fix: Ensure display:none to prevent blocking clicks
            setTimeout(() => { boot.style.display = 'none'; }, 500); 
            document.getElementById('app-frame').classList.add('loaded');
        }, 1800);
        updateUI();
    };

    // --- 4. UI LOGIC ---
    function updateUI() {
        const u = users.find(x=>x.id===activeId);
        const s = STATES[u.status];
        
        document.getElementById('d-name').innerText = u.name;
        document.getElementById('d-status').innerText = s.t;
        document.getElementById('d-status').style.color = s.c;
        document.getElementById('d-count').innerText = cart.length;
        
        // Cart Score
        let totalScore=0;
        if(cart.length>0){
            cart.forEach(i=>{
                let val=0;
                if(i.g==='A') val=100; else if(i.g==='B') val=80; else if(i.g==='C') val=60; else if(i.g==='D') val=40; else val=20;
                totalScore+=val;
            });
            let avg = Math.round(totalScore/cart.length);
            const el = document.getElementById('cart-score');
            el.innerText = avg + '%';
            if(avg>=80) el.style.color='var(--grade-a)'; else if(avg>=60) el.style.color='var(--grade-c)'; else el.style.color='var(--grade-e)';
        } else {
            document.getElementById('cart-score').innerText = '100%';
            document.getElementById('cart-score').style.color = '#fff';
        }

        // Prefs
        const p = document.getElementById('d-prefs');
        const map = {'a-milk':'ğŸ¥›','a-gluten':'ğŸ','d-diabetic':'ğŸ’‰','q-green':'âœ…'};
        p.innerHTML = u.filters.length ? u.filters.slice(0,3).map(f=>`<div class="pref-tag">${map[f]||''} ${f.split('-')[1]}</div>`).join('') : '<div class="pref-tag">×œ×œ× ××’×‘×œ×•×ª</div>';
    }

    // --- 5. CAMERA & SCANNING ---
    function startScanner() {
        document.getElementById('modal-scan').classList.add('open');
        isScanning = true;
        
        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
        .catch(err => {
            console.log("Cam Fail/Desktop");
            // QA Fallback: Simulate successful scan after 2s
            setTimeout(() => { if(isScanning) onScanSuccess("DEMO", null); }, 2000); 
        });
    }

    function stopScanner() {
        isScanning = false;
        if(html5QrcodeScanner) {
            try { 
                html5QrcodeScanner.stop().then(() => { html5QrcodeScanner.clear(); }).catch(e=>console.log(e)); 
            } catch(e) { console.log("Scanner stop error", e); }
        }
        closeModal('scan');
    }

    function onScanSuccess(decodedText, decodedResult) {
        stopScanner();
        // Simulate DB Fetch
        const core = DB_CORE[Math.floor(Math.random()*DB_CORE.length)];
        const brand = BRANDS[Math.floor(Math.random()*BRANDS.length)];
        const product = { ...core, brand: brand }; // Create unique item
        
        analyzeProduct(product);
        
        // Add to history
        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        history.unshift({n:product.n, b:brand, t:time});
        if(history.length>15) history.pop();
        localStorage.setItem('vOmega_hist', JSON.stringify(history));
    }
    function onScanFailure(e) {}

    // --- 6. ANALYSIS ENGINE ---
    function analyzeProduct(p) {
        const u = users.find(x=>x.id===activeId);
        let g = p.g; 
        let alerts = [];

        // Quality Check
        if(u.filters.includes('q-green')) { if(g!=='A') { g='D'; alerts.push({t:'××™× ×• ×ª×• ×™×¨×•×§', c:'warn'}); } }
        if(u.filters.includes('g-high')) { if(g!=='A' && g!=='B') alerts.push({t:'×¦×™×•×Ÿ × ××•×š ××”×”×’×“×¨×”', c:'bad'}); }

        // Allergies
        if(u.filters.includes('a-gluten') && p.gl) { g='E'; alerts.push({t:'×’×œ×•×˜×Ÿ', c:'bad'}); }
        if(u.filters.includes('a-milk') && p.da) { g='E'; alerts.push({t:'×—×œ×‘', c:'bad'}); }
        if(u.filters.includes('d-diabetic') && p.sug) { g='E'; alerts.push({t:'×¡×•×›×¨ ×’×‘×•×”', c:'bad'}); }
        
        // Context
        if(g!=='E') {
            if(u.status==='stress' && p.sug) { g='D'; alerts.push({t:'×¡×•×›×¨ (×¡×˜×¨×¡)', c:'warn'}); }
            if(u.status==='sugar' && p.sug) { g='B'; alerts.push({t:'××¢×œ×” ×¡×•×›×¨', c:'good'}); }
        }

        // Global State for Cart
        window.tempScan = {n:p.n, u:u.name, g:g, brand:p.brand};

        // Render Result
        document.getElementById('r-name').innerText = p.n;
        document.getElementById('r-brand').innerText = p.brand;
        const ge = document.getElementById('r-grade');
        ge.innerText = g;
        
        let color = '#fff';
        if(g==='A') color='var(--grade-a)'; else if(g==='B') color='var(--grade-b)'; else if(g==='C') color='var(--grade-c)'; else if(g==='D') color='var(--grade-d)'; else color='var(--grade-e)';
        ge.style.background = color; ge.style.boxShadow = `0 0 50px ${color}`;

        const al = document.getElementById('res-alert');
        al.innerHTML = alerts.length ? alerts.map(a => {
            let ac = a.c==='bad'?'var(--grade-e)':'var(--grade-d)'; 
            if(a.c==='good') ac='var(--grade-a)';
            return `<div class="alert-box" style="border:1px solid ${ac}; color:${ac};">${a.t}</div>`;
        }).join('') : '<div style="color:#666; margin-bottom:10px;">××ª××™× ×œ×¤×¨×•×¤×™×œ</div>';
        
        document.getElementById('modal-res').classList.add('open');
    }

    // --- 7. CART & UTILS ---
    function addToCart(isHome) {
        if(!window.tempScan) return;
        cart.push({n:window.tempScan.n, u:isHome?'×‘×™×ª':window.tempScan.u, g:window.tempScan.g});
        save(); closeModal('res'); showToast('× ×•×¡×£ ×‘×”×¦×œ×—×”'); updateUI();
    }

    function openCart() {
        const d = document.getElementById('cart-content');
        d.innerHTML = cart.length ? cart.map((i,x) => `
            <div class="cart-item">
                <div><span style="font-weight:bold; color:${i.g==='A'?'var(--grade-a)':'var(--grade-c)'}; margin-left:5px;">${i.g}</span> ${i.n}</div>
                <div onclick="remCart(${x})" style="color:var(--grade-e); cursor:pointer;">âœ•</div>
            </div>`).join('') : '<div style="text-align:center; padding:20px; color:#666;">×”×¢×’×œ×” ×¨×™×§×”</div>';
        document.getElementById('modal-cart').classList.add('open');
    }
    
    function remCart(i) { cart.splice(i,1); save(); openCart(); updateUI(); }
    
    function openHistory() {
        const d = document.getElementById('hist-content');
        d.innerHTML = history.length ? history.map(h => `
            <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; color:#bbb;">
                <span>${h.n} <small style="color:#666">(${h.b})</small></span><span>${h.t}</span>
            </div>`).join('') : '<div style="text-align:center; padding:20px; color:#666;">××™×Ÿ ×”×™×¡×˜×•×¨×™×”</div>';
        document.getElementById('modal-hist').classList.add('open');
    }

    // Modal Helpers
    function closeModal(id) { document.getElementById('modal-'+id).classList.remove('open'); }
    function tog(el) { el.nextElementSibling.classList.toggle('open'); }
    function save() { localStorage.setItem('vOmega_users', JSON.stringify(users)); localStorage.setItem('vOmega_cart', JSON.stringify(cart)); }
    function showToast(t) { const el=document.getElementById('toast'); el.innerText=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); }
    
    // Quick Add
    function quickAdd() { const v=document.getElementById('q-inp').value; if(v){cart.push({n:v,u:'×‘×™×ª',g:'C'}); save(); document.getElementById('q-inp').value=''; showToast('× ×•×¡×£'); updateUI();}}
    function quickAddCart() { const v=document.getElementById('c-inp').value; if(v){cart.push({n:v,u:'×‘×™×ª',g:'C'}); save(); document.getElementById('c-inp').value=''; openCart(); updateUI();}}

    // Profile & Settings
    function openEdit(id) {
        const u = users.find(x=>x.id===id);
        document.getElementById('edit-name').value = u.name;
        document.querySelectorAll('.chip').forEach(c=>c.checked=false);
        u.filters.forEach(f=>{ if(document.getElementById(f)) document.getElementById(f).checked=true; });
        document.getElementById('modal-edit').classList.add('open');
    }
    
    function saveProfile() {
        const u = users.find(x=>x.id===activeId);
        u.name = document.getElementById('edit-name').value || '××©×ª××©';
        u.filters = [];
        document.querySelectorAll('.chip:checked').forEach(c => u.filters.push(c.id));
        save(); closeModal('edit'); updateUI();
    }
    
    function clearSec(id) { document.getElementById(id).querySelectorAll('input').forEach(i=>i.checked=false); }
    function openRing() { document.getElementById('modal-ring').classList.add('open'); }
    function setRing(s) { getUser().status=s; save(); closeModal('ring'); updateUI(); }
    function getUser() { return users.find(x=>x.id===activeId); }

</script>
</body>
</html>
