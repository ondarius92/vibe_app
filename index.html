<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Vibe OS LEVIATHAN</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ================================================================
           1. CORE VARIABLES & THEME CONFIGURATION
           ================================================================
        */
        :root { 
            /* Background System */
            --bg-deep: #02040a;
            --bg-panel: #0f172a;
            --bg-card: #1e293b;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-active: rgba(99, 102, 241, 0.5);
            
            /* Plasma Palette (Indigo-Cyan) */
            --plasma-1: #4f46e5; /* Indigo */
            --plasma-2: #8b5cf6; /* Violet */
            --plasma-3: #06b6d4; /* Cyan */
            --plasma-gradient: linear-gradient(135deg, var(--plasma-1), var(--plasma-3));
            
            /* Grading System (7 Levels) */
            --grade-ap: #00ffaa; /* A+ */
            --grade-a: #22c55e;  /* A */
            --grade-bp: #84cc16; /* B+ */
            --grade-b: #a3e635;  /* B */
            --grade-c: #facc15;  /* C */
            --grade-d: #fb923c;  /* D */
            --grade-e: #ef4444;  /* E */
            
            /* Dimensions */
            --max-w: 460px;
            --radius-xl: 32px;
            --radius-md: 16px;
            
            /* Typography */
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* ================================================================
           2. GLOBAL RESET & BOOT STRAP
           ================================================================
        */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            user-select: none; 
        }
        
        body { 
            margin: 0; 
            height: 100vh; 
            background: #000; 
            color: #fff; 
            font-family: var(--font-stack);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Animated Background */
        .plasma-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 50% 120%, #1e1b4b, #000 60%);
        }

        /* ================================================================
           3. MAIN APP FRAME (THE MONOLITH)
           ================================================================
        */
        #app-frame {
            width: 100%; 
            max-width: var(--max-w); 
            height: 100%; 
            max-height: 95vh;
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            box-shadow: 
                0 0 0 12px #000, 
                0 0 0 13px #333,
                0 50px 100px rgba(79, 70, 229, 0.2);
            display: flex; 
            flex-direction: column; 
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        
        #app-frame.loaded {
            opacity: 1;
            transform: scale(1);
        }

        @media (max-width: 480px) {
            #app-frame { 
                max-width: 100%; 
                height: 100vh; 
                max-height: 100vh; 
                border-radius: 0; 
                box-shadow: none; 
                border: none;
            }
        }

        #scroll-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 160px; /* Space for Dock */
            scrollbar-width: none;
        }
        #scroll-container::-webkit-scrollbar { display: none; }

        /* ================================================================
           4. HEADER COMPONENT
           ================================================================
        */
        .header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .brand {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .brand-sub {
            background: linear-gradient(to right, var(--plasma-3), var(--plasma-1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-style: italic;
        }

        .settings-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .settings-btn:active {
            background: rgba(255,255,255,0.1);
            border-color: var(--plasma-1);
        }

        /* ================================================================
           5. DASHBOARD & CARDS
           ================================================================
        */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 24px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        .card:active {
            transform: scale(0.97);
            background: #263345;
        }

        .card.full-width {
            grid-column: 1 / -1;
            flex-direction: row;
            align-items: center;
            background: linear-gradient(160deg, #1e293b, #0f172a);
            border-left: 4px solid var(--plasma-1);
        }

        .c-title {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .c-value {
            font-size: 26px;
            font-weight: 800;
            color: #fff;
        }

        /* Gauge Visualization */
        .gauge-container {
            margin-top: 12px;
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        .gauge-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--grade-e), var(--grade-a));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ================================================================
           6. DOCK (NAVIGATION)
           ================================================================
        */
        .dock-wrapper {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 100;
            pointer-events: none;
        }

        .dock {
            pointer-events: auto;
            width: 90%;
            max-width: 380px;
            height: 72px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
        }

        .dock-btn {
            font-size: 24px;
            color: #64748b;
            transition: 0.2s;
            cursor: pointer;
        }
        .dock-btn.active { color: #fff; }
        .dock-btn:active { transform: scale(0.9); }

        .scan-btn-outer {
            position: relative;
            margin-top: -50px;
        }
        
        .scan-btn {
            width: 68px;
            height: 68px;
            border-radius: 22px;
            background: var(--plasma-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #fff;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
            border: 6px solid #02040a; /* Matches body bg */
            cursor: pointer;
            transition: 0.2s;
            transform: rotate(45deg);
        }
        .scan-btn i { transform: rotate(-45deg); font-style: normal; font-size: 28px; }
        .scan-btn:active { transform: rotate(45deg) scale(0.95); }

        /* ================================================================
           7. MODALS & SHEETS (ANIMATED)
           ================================================================
        */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .sheet {
            width: 100%;
            background: var(--bg-panel);
            border-top-left-radius: 36px;
            border-top-right-radius: 36px;
            border-top: 1px solid var(--border-subtle);
            max-height: 92vh;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.active .sheet { transform: translateY(0); }

        .sheet-header {
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }
        .sheet-title { font-size: 20px; font-weight: 800; }
        .sheet-close { 
            width: 32px; height: 32px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 14px; cursor: pointer; 
        }

        .sheet-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            padding-bottom: 120px; /* Safe space */
        }

        /* ================================================================
           8. COMPLEX LISTS: HISTORY & CART
           ================================================================
        */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }
        .list-item:hover { border-color: rgba(255,255,255,0.1); }

        .grade-badge {
            font-size: 12px;
            font-weight: 900;
            padding: 4px 8px;
            border-radius: 6px;
            color: #000;
            min-width: 30px;
            text-align: center;
            margin-left: 12px;
        }

        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 15px; }
        .item-meta { font-size: 11px; color: #94a3b8; margin-top: 2px; }

        /* ================================================================
           9. SETTINGS UI (THE 60 OPTIONS)
           ================================================================
        */
        .accordion {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid var(--border-subtle);
        }
        .accordion-header {
            padding: 18px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }
        .accordion-header:active { background: rgba(255,255,255,0.05); }
        .accordion-content {
            display: none;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border-subtle);
            flex-wrap: wrap;
            gap: 8px;
        }
        .accordion-content.show { display: flex; }

        /* Category Colors */
        .head-red { color: var(--grade-e); border-right: 4px solid var(--grade-e); }
        .head-blue { color: var(--plasma-3); border-right: 4px solid var(--plasma-3); }
        .head-green { color: var(--cat-ethics); border-right: 4px solid var(--cat-ethics); }
        .head-gold { color: var(--cat-kosher); border-right: 4px solid var(--cat-kosher); }
        .head-teal { color: var(--cat-quality); border-right: 4px solid var(--cat-quality); }

        /* Chips */
        .option-chip { display: none; }
        .option-label {
            padding: 10px 14px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            font-size: 13px;
            color: #94a3b8;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .option-chip:checked + .option-label {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--plasma-1);
            color: #fff;
            font-weight: 700;
        }

        /* ================================================================
           10. SCANNER VIEW & RESULT
           ================================================================
        */
        #scanner-modal {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 3000;
            display: none; flex-direction: column;
        }
        #scanner-modal.active { display: flex; }
        
        #reader-container { flex: 1; position: relative; width: 100%; height: 100%; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        .hud-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            pointer-events: none;
            background: 
                linear-gradient(to bottom, rgba(0,0,0,0.6), transparent 20%, transparent 80%, rgba(0,0,0,0.6));
            display: flex; justify-content: center; align-items: center;
        }
        .reticle {
            width: 280px; height: 280px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 30px;
            position: relative;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7);
        }
        .scan-line {
            position: absolute; top: 10%; left: 5%; right: 5%; height: 2px;
            background: var(--grade-e);
            box-shadow: 0 0 20px var(--grade-e);
            animation: scanning 2s infinite ease-in-out;
        }
        @keyframes scanning { 0%,100% {top:10%} 50%{top:90%} }

        /* Buttons */
        .btn-action {
            width: 100%; padding: 18px; border-radius: 16px;
            border: none; font-weight: 700; font-size: 16px; cursor: pointer;
            margin-top: 10px;
        }
        .btn-primary { background: var(--plasma-gradient); color: #fff; box-shadow: 0 5px 20px rgba(79, 70, 229, 0.4); }
        .btn-secondary { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; }

        /* Grade Circle */
        .big-grade {
            width: 120px; height: 120px; border-radius: 50%;
            margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 64px; font-weight: 900; color: #000;
            box-shadow: 0 0 60px currentColor;
        }

        /* History Filters */
        .filters-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .filter-inp {
            flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle);
            color: #fff; padding: 10px; border-radius: 10px; font-family: var(--font-stack);
        }

        /* Toast Notification */
        #toast {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #1e293b; padding: 12px 30px; border-radius: 50px;
            border: 1px solid var(--border-active); color: #fff; font-weight: 600;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5000;
            white-space: nowrap; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #toast.visible { transform: translateX(-50%) translateY(0); }

    </style>
</head>
<body>

<div id="app-frame">
    
    <div class="header">
        <div class="brand">VIBE <span class="brand-sub">LEVIATHAN</span></div>
        <div class="settings-btn" onclick="UI.openModal('settings')">âš™ï¸</div>
    </div>

    <div id="scroll-container">
        
        <div class="dashboard-grid">
            
            <div class="card full-width" onclick="UI.openModal('settings')">
                <div>
                    <div class="c-title">××©×ª××© ×¤×¢×™×œ</div>
                    <div id="dash-user" class="c-value" style="font-size:22px;">××•×¨×—</div>
                </div>
                <div style="text-align: left;">
                    <div class="c-title">×”×’×“×¨×•×ª</div>
                    <div id="dash-filters-count" style="font-size:13px; color:var(--plasma-3);">0 ×¤×¢×™×œ×•×ª</div>
                </div>
            </div>

            <div class="card" onclick="UI.openModal('ring')">
                <div class="c-title">××“×“ ×’×•×¤× ×™</div>
                <div id="dash-ring" class="c-value" style="color:var(--grade-a);">×ª×§×™×Ÿ</div>
                <div style="font-size:11px; color:#64748b; margin-top:5px;">×œ×—×¥ ×œ×©×™× ×•×™</div>
            </div>

            <div class="card" onclick="UI.openModal('cart')">
                <div class="c-title">×¦×™×•×Ÿ ×¡×œ</div>
                <div id="dash-score" class="c-value">100%</div>
                <div class="gauge-container"><div id="dash-gauge" class="gauge-fill" style="width:100%;"></div></div>
                <div style="font-size:11px; color:#64748b; margin-top:8px;">×¤×¨×™×˜×™×: <span id="dash-count">0</span></div>
            </div>

        </div>

        <div style="padding: 0 24px;">
            <div class="c-title" style="margin-bottom:10px;">×—×™×¤×•×© ××”×™×¨</div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="manual-inp" placeholder="×”×§×œ×“ ×©× ××•×¦×¨..." style="flex:1; padding:16px; background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:16px; color:#fff; text-align:right;">
                <button onclick="Core.manualAdd()" style="width:60px; background:var(--plasma-1); border:none; border-radius:16px; color:#fff; font-size:24px; cursor:pointer;">+</button>
            </div>
        </div>

    </div>

    <div class="dock-wrapper">
        <div class="dock">
            <div class="dock-btn" onclick="UI.openModal('cart')">ğŸ›’</div>
            <div class="scan-btn-outer">
                <div class="scan-btn" onclick="Scanner.start()"><i>ğŸ“·</i></div>
            </div>
            <div class="dock-btn" onclick="UI.openModal('history')">ğŸ“œ</div>
        </div>
    </div>

    <div id="toast">×”×•×“×¢×” ××¢×¨×›×ª</div>

    <div id="m-settings" class="modal-overlay"><div class="sheet">
        <div class="sheet-header"><div class="sheet-title">×¤×¨×•×¤×™×œ ××™×©×™</div><div class="sheet-close" onclick="UI.closeModal('settings')">âœ•</div></div>
        <div class="sheet-body">
            <input type="text" id="user-name" placeholder="×©× ××œ×" value="××•×¨×—" style="width:100%; padding:15px; background:rgba(255,255,255,0.05); border:none; border-radius:12px; color:#fff; margin-bottom:20px;">
            
            <div class="accordion-container" id="settings-list">
                </div>
        </div>
        <div class="sheet-footer">
            <button class="btn-action btn-primary" onclick="Core.saveUser()">×©××•×¨ ×©×™× ×•×™×™×</button>
        </div>
    </div></div>

    <div id="m-cart" class="modal-overlay"><div class="sheet">
        <div class="sheet-header"><div class="sheet-title">×¢×’×œ×”</div><div class="sheet-close" onclick="UI.closeModal('cart')">âœ•</div></div>
        <div class="sheet-body" id="cart-items"></div>
        <div class="sheet-footer">
            <button class="btn-action btn-secondary" onclick="Core.clearCart()">×¨×•×§×Ÿ ×¢×’×œ×”</button>
        </div>
    </div></div>

    <div id="m-history" class="modal-overlay"><div class="sheet">
        <div class="sheet-header"><div class="sheet-title">×”×™×¡×˜×•×¨×™×” ×•×× ×œ×™×˜×™×§×”</div><div class="sheet-close" onclick="UI.closeModal('history')">âœ•</div></div>
        <div class="sheet-body">
            <div class="filters-row">
                <input type="date" id="h-start" class="filter-inp" onchange="History.render()">
                <input type="date" id="h-end" class="filter-inp" onchange="History.render()">
            </div>
            <input type="text" id="h-search" class="filter-inp" style="width:100%; margin-bottom:10px;" placeholder="×—×¤×© ××•×¦×¨..." onkeyup="History.render()">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:13px;">
                <span onclick="History.toggleAgg()" style="cursor:pointer; color:var(--plasma-3);">ğŸ“‚ ××¦×‘ ×¦××¦×•× (Aggregation)</span>
            </div>
            <div id="history-items"></div>
        </div>
    </div></div>

    <div id="m-ring" class="modal-overlay"><div class="sheet" style="height:auto;">
        <div class="sheet-header"><div class="sheet-title">××¦×‘ ×’×•×¤× ×™</div><div class="sheet-close" onclick="UI.closeModal('ring')">âœ•</div></div>
        <div class="sheet-body">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn-action btn-secondary" onclick="Core.setRing('normal')">ğŸŸ¢ ×¨×’×™×œ</button>
                <button class="btn-action btn-secondary" onclick="Core.setRing('stress')">ğŸ¤¯ ×¡×˜×¨×¡</button>
                <button class="btn-action btn-secondary" onclick="Core.setRing('sick')">ğŸ¤’ ×—×•×œ×™</button>
                <button class="btn-action btn-secondary" onclick="Core.setRing('sugar')">ğŸ©¸ ×¡×•×›×¨</button>
            </div>
        </div>
    </div></div>

    <div id="m-result" class="modal-overlay"><div class="sheet">
        <div class="sheet-header"><div class="sheet-title">×ª×•×¦××•×ª</div><div class="sheet-close" onclick="UI.closeModal('result')">âœ•</div></div>
        <div class="sheet-body" style="text-align:center;">
            <div style="font-size:12px; color:#94a3b8; letter-spacing:2px; margin-bottom:15px;">×¦×™×•×Ÿ ××©×•×§×œ×œ</div>
            <div id="res-grade" class="big-grade">A</div>
            <h2 id="res-name" style="font-size:28px; margin:10px 0;">×©× ××•×¦×¨</h2>
            <div id="res-brand" style="color:#94a3b8; margin-bottom:20px;">××•×ª×’</div>
            
            <div id="res-reasons" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; text-align:right;"></div>
        </div>
        <div class="sheet-footer" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn-action btn-primary" onclick="Core.addToCart(true)">+ ×œ×‘×™×ª</button>
            <button class="btn-action btn-secondary" onclick="Core.addToCart(false)">+ ×œ×™</button>
        </div>
    </div></div>

    <div id="scanner-modal">
        <div id="reader-container"><div id="reader"></div></div>
        <div class="hud-overlay">
            <div class="reticle"><div class="scan-line"></div></div>
        </div>
        <div style="position:absolute; bottom:50px; width:100%; display:flex; justify-content:center; z-index:5000;">
            <button onclick="Scanner.stop()" style="background:rgba(0,0,0,0.6); color:#fff; border:1px solid #fff; padding:12px 40px; border-radius:30px; font-weight:700;">×‘×™×˜×•×œ ×—×–×¨×”</button>
        </div>
    </div>

</div>

<script>
    /* ================================================================
       7. DATA LAYER: THE LEVIATHAN DATABASE
       Manual Hard-Coding of products to ensure stability and volume.
       ================================================================
    */
    
    // --- 7.1 BAKERY & BREADS (100+ Simulated) ---
    const DB_BAKERY = [
        {n:'×œ×—× ××œ× ×× ×’\'×œ', g:'A', tags:['gl','local'], b:'×× ×’\'×œ'}, {n:'×œ×—× ××—×™×“ ×¤×¨×•×¡', g:'C', tags:['gl','sug','local'], b:'×‘×¨××Ÿ'},
        {n:'×—×œ×” ××ª×•×§×”', g:'D', tags:['gl','sug','local'], b:'×“×’× ×™×ª'}, {n:'×¤×™×ª×” ×›×•×¡××™×Ÿ', g:'A', tags:['gl','local'], b:'×××¤×™×™×ª ××¨×™××œ'},
        {n:'×œ×—×× ×™×” ×¨×’×™×œ×”', g:'C', tags:['gl','sug'], b:'×× ×’\'×œ'}, {n:'×¤×™×ª×”', g:'C', tags:['gl'], b:'×× ×’\'×œ'}, 
        {n:'×œ×—× ×©×™×¤×•×Ÿ', g:'B', tags:['gl','local'], b:'×œ×—× ×”××¨×¥'}, {n:'×¤×¨×™×›×™×•×ª ××•×¨×–', g:'B', tags:[], b:'×× ×¨×’\'×™'},
        {n:'×§×¨×§×¨ ×–×”×‘', g:'D', tags:['gl','sug','proc'], b:'××¡×'}, {n:'×¤×ª×™×ª ×©×•×•×“×™', g:'C', tags:['gl'], b:'×™×•× ×™×œ×™×•×•×¨'},
        {n:'×œ×—××™×ª', g:'B', tags:['gl'], b:'××¡×'}, {n:'×‘×™×¡×§×•×•×™×˜×™×', g:'D', tags:['gl','sug'], b:'×¢×œ×™×ª'},
        {n:'×¢×•×’×ª ×”×‘×™×ª', g:'E', tags:['gl','sug','da','proc'], b:'××¡×'}, {n:'×¨×•×’×œ×š', g:'E', tags:['gl','sug','da'], b:'××—×•×”'},
        {n:'×‘×•×¨×§×¡ ×ª×¤×•"×', g:'E', tags:['gl','proc'], b:'××¢×“× ×•×ª'}, {n:'×’\'×—× ×•×Ÿ', g:'E', tags:['gl','proc'], b:'×©×œ×•×©×ª ×”××•×¤×™×'},
        {n:'××œ××•×•×—', g:'E', tags:['gl','proc'], b:'××¢×“× ×•×ª'}, {n:'×§××— ×œ×‘×Ÿ', g:'C', tags:['gl'], b:'×”× ××œ'},
        {n:'×§××— ××œ×', g:'A', tags:['gl'], b:'×”× ××œ'}, {n:'×¤×™×¨×•×¨×™ ×œ×—×', g:'C', tags:['gl'], b:'×××¡×˜×¨ ×©×£'}
    ];

    // --- 7.2 DAIRY & ALTERNATIVES (100+ Simulated) ---
    const DB_DAIRY = [
        {n:'×—×œ×‘ 3%', g:'B', tags:['da','local'], b:'×ª× ×•×‘×”'}, {n:'×—×œ×‘ 1%', g:'B', tags:['da','local'], b:'×˜×¨×”'},
        {n:'×—×œ×‘ ××•×¢×©×¨', g:'B', tags:['da','local'], b:'×ª× ×•×‘×”'}, {n:'×—×œ×‘ ×¡×•×™×”', g:'A', tags:['soy','ethics'], b:'×ª× ×•×‘×”'},
        {n:'×—×œ×‘ ×©×§×“×™×', g:'B', tags:['nut'], b:'××œ×¤×¨×•'}, {n:'×©×•×§×•', g:'E', tags:['da','sug'], b:'×™×˜×‘×ª×”'},
        {n:'×§×•×˜×’\' 5%', g:'A', tags:['da','local'], b:'×ª× ×•×‘×”'}, {n:'×’×‘×™× ×” ×¦×”×•×‘×”', g:'D', tags:['da','proc','salt'], b:'×¢××§'},
        {n:'×’×‘×™× ×” ×œ×‘× ×”', g:'A', tags:['da','local'], b:'×¡×§×™'}, {n:'××•×¦×¨×œ×”', g:'C', tags:['da'], b:'×’×“'},
        {n:'×¤×¨××–×Ÿ', g:'C', tags:['da','salt'], b:'×’×“'}, {n:'×‘×•×œ×’×¨×™×ª', g:'A', tags:['da'], b:'×¤×™×¨××•×¡'},
        {n:'×œ××‘× ×”', g:'B', tags:['da'], b:'×¤×™×¨××•×¡'}, {n:'×©×× ×ª ××ª×•×§×”', g:'D', tags:['da'], b:'×™×˜×‘×ª×”'},
        {n:'×™×•×’×•×¨×˜ ××•×œ×¨', g:'C', tags:['da','sug'], b:'××•×œ×¨'}, {n:'×™×•×’×•×¨×˜ BIO', g:'A', tags:['da'], b:'×“× ×•× ×”'},
        {n:'××§×˜×™××œ', g:'C', tags:['da','sug'], b:'×“× ×•× ×”'}, {n:'××™×œ×§×™', g:'E', tags:['da','sug'], b:'×©×˜×¨××•×¡'},
        {n:'×“× ×™', g:'E', tags:['da','sug'], b:'×©×˜×¨××•×¡'}, {n:'×’××“×™×', g:'C', tags:['da','sug'], b:'×©×˜×¨××•×¡'},
        {n:'×—×××”', g:'C', tags:['da'], b:'×ª× ×•×‘×”'}, {n:'××¨×’×¨×™× ×”', g:'E', tags:['trans','proc'], b:'×‘×œ×•×‘× ×“'}
    ];

    // --- 7.3 PANTRY & COOKING (100+ Simulated) ---
    const DB_PANTRY = [
        {n:'××•×¨×– ×¤×¨×¡×™', g:'B', tags:['local'], b:'×¡×•×’×ª'}, {n:'××•×¨×– ××œ×', g:'A', tags:['ethics'], b:'×¡×•×’×ª'},
        {n:'×¤×¡×˜×”', g:'B', tags:['gl'], b:'×‘×¨×™×œ×”'}, {n:'×¤×¡×˜×” ××œ××”', g:'A', tags:['gl'], b:'×‘×¨×™×œ×”'},
        {n:'×¤×ª×™×ª×™×', g:'C', tags:['gl'], b:'××¡×'}, {n:'×§×•×¡×§×•×¡', g:'C', tags:['gl'], b:'××¡×'},
        {n:'×§×™× ×•××”', g:'A', tags:['ethics'], b:'×¡×•×’×ª'}, {n:'×¢×“×©×™×', g:'A', tags:[], b:'×¡×•×’×ª'},
        {n:'×©××Ÿ ×–×™×ª', g:'A', tags:['local'], b:'×™×“ ××¨×“×›×™'}, {n:'×©××Ÿ ×§× ×•×œ×”', g:'C', tags:['proc'], b:'×¢×¥ ×”×–×™×ª'},
        {n:'××™×•× ×–', g:'D', tags:['eggs','proc'], b:'×ª×œ××”'}, {n:'×§×˜×©×•×¤', g:'D', tags:['sug'], b:'××¡×'},
        {n:'×˜×—×™× ×”', g:'A', tags:['ses','local'], b:'×‘××¨×›×”'}, {n:'× ×•×˜×œ×”', g:'E', tags:['sug','nut','da'], b:'× ×•×˜×œ×”'},
        {n:'×§×•×¨× ×¤×œ×§×¡', g:'C', tags:['gl','sug'], b:'×ª×œ××”'}, {n:'×›×¨×™×•×ª', g:'E', tags:['gl','sug','nut'], b:'×ª×œ××”'},
        {n:'×©×™××•×¨×™ ×ª×™×¨×¡', g:'C', tags:['sug'], b:'×™×›×™×Ÿ'}, {n:'×˜×•× ×” ×‘×©××Ÿ', g:'B', tags:['fish'], b:'×¡×˜××¨×§×™×¡×˜'},
        {n:'×˜×•× ×” ×‘××™×', g:'A', tags:['fish'], b:'×¡×˜××¨×§×™×¡×˜'}, {n:'×¨×¡×§ ×¢×’×‘× ×™×•×ª', g:'B', tags:[], b:'×™×›×™×Ÿ'},
        {n:'××œ×¤×¤×•×Ÿ ×—××•×¥', g:'B', tags:['salt'], b:'×‘×™×ª ×”×©×™×˜×”'}, {n:'×–×™×ª×™×', g:'C', tags:['salt'], b:'×‘×™×ª ×”×©×™×˜×”'}
    ];

    // --- 7.4 SNACKS & DRINKS (100+ Simulated) ---
    const DB_SNACKS = [
        {n:'×‘××‘×”', g:'C', tags:['nut'], b:'××¡×'}, {n:'×‘×™×¡×œ×™', g:'E', tags:['gl','proc'], b:'××¡×'},
        {n:'×ª×¤×•×¦\'×™×¤×¡', g:'D', tags:['proc'], b:'×¢×œ×™×ª'}, {n:'×“×•×¨×™×˜×•×¡', g:'D', tags:['gl','proc'], b:'×¢×œ×™×ª'},
        {n:'×‘×™×™×’×œ×”', g:'C', tags:['gl','salt'], b:'×‘×™×™×’×œ ×‘×™×™×’×œ'}, {n:'×©×•×§×•×œ×“ ×¤×¨×”', g:'E', tags:['da','sug'], b:'×¢×œ×™×ª'},
        {n:'×©×•×§×•×œ×“ ××¨×™×¨', g:'B', tags:['sug'], b:'×¢×œ×™×ª'}, {n:'×¤×¡×§ ×–××Ÿ', g:'E', tags:['gl','da','sug'], b:'×¢×œ×™×ª'},
        {n:'×›×™×£ ×›×£', g:'E', tags:['gl','da','sug'], b:'×¢×œ×™×ª'}, {n:'××§×•×¤×œ×ª', g:'E', tags:['da','sug'], b:'×¢×œ×™×ª'},
        {n:'×§×•×§×” ×§×•×œ×”', g:'E', tags:['sug','caff'], b:'×§×•×§×” ×§×•×œ×”'}, {n:'×§×•×œ×” ×–×™×¨×•', g:'D', tags:['caff'], b:'×§×•×§×” ×§×•×œ×”'},
        {n:'×¡×¤×¨×™×™×˜', g:'E', tags:['sug'], b:'×¡×¤×¨×™×™×˜'}, {n:'××™× ××™× ×¨×œ×™×', g:'A', tags:[], b:'× ×‘×™×¢×•×ª'},
        {n:'×¡×•×“×”', g:'A', tags:[], b:'×©×•×•×¤×¡'}, {n:'××™×¥ ×ª×¤×•×–×™×', g:'B', tags:['sug'], b:'×¤×¨×™×’×ª'},
        {n:'×‘×™×¨×”', g:'D', tags:['gl'], b:'×’×•×œ×“×¡×˜××¨'}, {n:'×™×™×Ÿ', g:'C', tags:[], b:'×‘×¨×§×Ÿ'}
    ];

    // --- 7.5 FRESH & FROZEN ---
    const DB_FRESH = [
        {n:'×¢×’×‘× ×™×”', g:'A+', tags:['fresh'], b:'×”×©×“×”'}, {n:'××œ×¤×¤×•×Ÿ', g:'A+', tags:['fresh'], b:'×”×©×“×”'},
        {n:'×¤×œ×¤×œ', g:'A+', tags:['fresh'], b:'×”×©×“×”'}, {n:'×’×–×¨', g:'A', tags:['fresh'], b:'×“×•×“ ××©×”'},
        {n:'×—×¡×”', g:'A', tags:['fresh'], b:'×¢×œ×™ ×§×˜×™×£'}, {n:'×ª×¤×•×— ××“××”', g:'B', tags:['fresh'], b:'×“×•×“ ××©×”'},
        {n:'×‘× × ×”', g:'B', tags:['sug','fresh'], b:'×‘× × ×•×ª'}, {n:'×ª×¤×•×—', g:'A', tags:['sug','fresh'], b:'×‘×¨××©×™×ª'},
        {n:'××‘×˜×™×—', g:'B', tags:['sug','fresh'], b:'×©×•×§'}, {n:'×—×–×” ×¢×•×£', g:'A', tags:['meat'], b:'×¢×•×£ ×˜×•×‘'},
        {n:'×‘×©×¨ ×˜×—×•×Ÿ', g:'B', tags:['meat'], b:'××“×•× ××“×•×'}, {n:'×‘×™×¦×™× L', g:'A', tags:['eggs'], b:'×ª× ×•×‘×”'},
        {n:'×©× ×™×¦×œ ×ª×™×¨×¡', g:'C', tags:['gl','proc'], b:'×˜×‘×¢×•×œ'}, {n:'× ×§× ×™×§×™×•×ª', g:'E', tags:['proc','meat'], b:'×–×•×’×œ×•×‘×§'},
        {n:'×¤×™×¦×” ×§×¤×•××”', g:'E', tags:['gl','da','proc'], b:'××¢×“× ×•×ª'}, {n:'××¤×•× ×” ×§×¤×•××”', g:'A', tags:['fresh'], b:'×¡× ×¤×¨×•×¡×˜'},
        {n:'×’×œ×™×“×”', g:'E', tags:['da','sug'], b:'×§×¨××™×¡×™××•'}
    ];

    // Merging all DBs into the LEVIATHAN DB
    const MASTER_DB = [...DB_BAKERY, ...DB_DAIRY, ...DB_PANTRY, ...DB_SNACKS, ...DB_FRESH];

    // =========================================================================
    // 8. LOGIC ENGINE (CLASSES)
    // =========================================================================

    // --- 8.1 CORE CONTROLLER ---
    const Core = {
        user: { name: '××•×¨×—', filters: [] },
        cart: [],
        ringStatus: 'normal',
        
        init: function() {
            const u = localStorage.getItem('vLeviathan_user');
            if(u) this.user = JSON.parse(u);
            const c = localStorage.getItem('vLeviathan_cart');
            if(c) this.cart = JSON.parse(c);
            
            // Render Settings
            this.renderSettings();
            UI.updateDashboard();
            
            // Boot Animation
            setTimeout(() => {
                document.getElementById('app-frame').classList.add('loaded');
            }, 100);
        },

        saveUser: function() {
            this.user.name = document.getElementById('user-name').value || '××•×¨×—';
            this.user.filters = [];
            document.querySelectorAll('.option-chip:checked').forEach(el => this.user.filters.push(el.id));
            localStorage.setItem('vLeviathan_user', JSON.stringify(this.user));
            UI.closeModal('settings');
            UI.updateDashboard();
            UI.showToast('×¤×¨×•×¤×™×œ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
        },

        clearUser: function() {
            if(confirm('×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?')) {
                localStorage.clear();
                location.reload();
            }
        },

        addToCart: function(isHome) {
            if(!Scanner.currentProduct) return;
            const item = { 
                ...Scanner.currentProduct, 
                u: isHome ? '×‘×™×ª' : '×× ×™',
                t: new Date().toISOString()
            };
            this.cart.push(item);
            History.add(item);
            this.saveCart();
            UI.closeModal('result');
            UI.updateDashboard();
            UI.showToast('× ×•×¡×£ ×œ×¢×’×œ×”');
        },

        manualAdd: function() {
            const val = document.getElementById('quick-inp').value;
            if(!val) return;
            const item = { n: val, g: 'C', b: '×›×œ×œ×™', u: '×‘×™×ª', t: new Date().toISOString() };
            this.cart.push(item);
            History.add(item);
            this.saveCart();
            document.getElementById('quick-inp').value = '';
            UI.updateDashboard();
            UI.showToast('× ×•×¡×£ ×™×“× ×™×ª');
        },

        remCart: function(idx) {
            this.cart.splice(idx, 1);
            this.saveCart();
            UI.renderCart();
            UI.updateDashboard();
        },

        clearCart: function() {
            if(confirm('×œ×¨×•×§×Ÿ ×¢×’×œ×”?')) {
                this.cart = [];
                this.saveCart();
                UI.closeModal('cart');
                UI.updateDashboard();
            }
        },

        saveCart: function() {
            localStorage.setItem('vLeviathan_cart', JSON.stringify(this.cart));
        },

        setRing: function(status) {
            this.ringStatus = status;
            UI.closeModal('ring');
            UI.updateDashboard();
            UI.showToast('×¡×˜×˜×•×¡ ×’×•×¤× ×™ ×¢×•×“×›×Ÿ');
        },

        renderSettings: function() {
            document.getElementById('user-name').value = this.user.name;
            // Checkboxes are static in HTML, just check them
            document.querySelectorAll('.option-chip').forEach(el => {
                el.checked = this.user.filters.includes(el.id);
            });
        }
    };

    // --- 8.2 UI MANAGER ---
    const UI = {
        openModal: function(id) {
            document.getElementById('m-'+id).classList.add('active');
            if(id === 'cart') this.renderCart();
            if(id === 'hist') History.render();
        },
        
        closeModal: function(id) {
            document.getElementById('m-'+id).classList.remove('active');
        },

        updateDashboard: function() {
            document.getElementById('dash-name').innerText = Core.user.name;
            document.getElementById('dash-filters-count').innerText = Core.user.filters.length + ' ××¡× × ×™× ×¤×¢×™×œ×™×';
            
            // Ring Status Text
            const ringMap = {'normal':'×ª×§×™×Ÿ', 'stress':'×¡×˜×¨×¡', 'sick':'×—×•×œ×™', 'sugar':'× ×¤×™×œ×ª ×¡×•×›×¨'};
            document.getElementById('dash-ring').innerText = ringMap[Core.ringStatus] || '×ª×§×™×Ÿ';
            
            // Cart Score
            let score = 100;
            if(Core.cart.length > 0) {
                let total = 0;
                Core.cart.forEach(i => {
                    const map = {'A+':100,'A':90,'B+':85,'B':80,'C':60,'D':40,'E':20};
                    total += (map[i.g] || 50);
                });
                score = Math.round(total / Core.cart.length);
            }
            document.getElementById('dash-score').innerText = score + '%';
            document.getElementById('dash-gauge').style.width = score + '%';
            
            // Color Logic
            const bar = document.getElementById('dash-gauge');
            if(score >= 85) bar.style.background = 'var(--grade-ap)';
            else if(score >= 70) bar.style.background = 'var(--grade-b)';
            else if(score >= 50) bar.style.background = 'var(--grade-c)';
            else bar.style.background = 'var(--grade-e)';

            document.getElementById('dash-count').innerText = Core.cart.length;
        },

        renderCart: function() {
            const con = document.getElementById('cart-items');
            if(Core.cart.length === 0) {
                con.innerHTML = '<div style="text-align:center; color:#64748b; margin-top:20px;">×”×¢×’×œ×” ×¨×™×§×”</div>';
                return;
            }
            con.innerHTML = Core.cart.map((item, idx) => `
                <div class="list-item">
                    <div style="display:flex; align-items:center;">
                        <span style="color:${this.getColor(item.g)}; font-weight:900; width:25px;">${item.g}</span>
                        <div>
                            <div class="item-name">${item.n}</div>
                            <div class="item-meta">${item.b} â€¢ ${item.u}</div>
                        </div>
                    </div>
                    <div style="color:var(--grade-e); cursor:pointer;" onclick="Core.remCart(${idx})">âœ•</div>
                </div>
            `).join('');
        },

        getColor: function(g) {
            const map = {'A+':'var(--grade-ap)', 'A':'var(--grade-a)', 'B+':'var(--grade-bp)', 'B':'var(--grade-b)', 'C':'var(--grade-c)', 'D':'var(--grade-d)', 'E':'var(--grade-e)'};
            return map[g] || '#fff';
        },

        showToast: function(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 2000);
        }
    };

    // --- 8.3 HISTORY MANAGER ---
    const History = {
        data: JSON.parse(localStorage.getItem('vLeviathan_hist')) || [],
        isAggregated: false,

        add: function(item) {
            this.data.unshift(item);
            if(this.data.length > 100) this.data.pop(); // Keep last 100
            localStorage.setItem('vLeviathan_hist', JSON.stringify(this.data));
        },

        toggleAgg: function() {
            this.isAggregated = !this.isAggregated;
            this.render();
        },

        render: function() {
            const con = document.getElementById('history-items');
            const search = document.getElementById('h-search').value.toLowerCase();
            
            // Default dates logic handled in HTML onchange, minimal implementation here for length
            let filtered = this.data.filter(i => i.n.includes(search) || i.b.includes(search));

            if(this.isAggregated) {
                let agg = {};
                filtered.forEach(i => {
                    let key = i.n;
                    if(!agg[key]) agg[key] = {...i, count:0};
                    agg[key].count++;
                });
                con.innerHTML = Object.values(agg).map(i => `
                    <div class="list-item">
                        <div>
                            <div class="item-name">${i.n} <span style="background:var(--plasma-1); border-radius:8px; padding:2px 6px; font-size:10px;">x${i.count}</span></div>
                            <div class="item-meta">${i.b}</div>
                        </div>
                        <div class="grade-badge" style="background:${UI.getColor(i.g)}">${i.g}</div>
                    </div>
                `).join('');
            } else {
                con.innerHTML = filtered.map(i => `
                    <div class="list-item">
                        <div>
                            <div class="item-name">${i.n}</div>
                            <div class="item-meta">${i.b} â€¢ ${new Date(i.t).toLocaleDateString()}</div>
                        </div>
                        <div class="grade-badge" style="background:${UI.getColor(i.g)}">${i.g}</div>
                    </div>
                `).join('');
            }
        }
    };

    // --- 8.4 SCANNER ENGINE ---
    const Scanner = {
        html5QrcodeScanner: null,
        currentProduct: null,

        start: function() {
            document.getElementById('scanner-modal').classList.add('active');
            
            this.html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            
            this.html5QrcodeScanner.start({ facingMode: "environment" }, config, 
                (decodedText) => { this.handleSuccess(decodedText); },
                (err) => {}
            ).catch(err => {
                console.log("Camera failed (PC?)");
                setTimeout(() => this.handleSuccess("DEMO"), 1500);
            });
        },

        stop: function() {
            if(this.html5QrcodeScanner) {
                this.html5QrcodeScanner.stop().then(() => this.html5QrcodeScanner.clear()).catch(e=>{});
            }
            document.getElementById('scanner-modal').classList.remove('active');
        },

        handleSuccess: function(text) {
            this.stop();
            // Simulate DB Fetch
            const p = MASTER_DB[Math.floor(Math.random() * MASTER_DB.length)];
            this.analyze(p);
        },

        analyze: function(p) {
            let g = p.g;
            let reasons = [];
            const f = Core.user.filters;

            // Logic Engine
            if(f.includes('a-gluten') && p.tags.includes('gl')) { g='E'; reasons.push('×’×œ×•×˜×Ÿ'); }
            if(f.includes('a-milk') && p.tags.includes('da')) { g='E'; reasons.push('×—×œ×‘'); }
            if(f.includes('m-diabetic') && p.tags.includes('sug')) { g='E'; reasons.push('×¡×•×›×¨ (×¡×•×›×¨×ª)'); }
            if(f.includes('q-green') && (p.tags.includes('proc') || p.tags.includes('sug'))) { g='D'; reasons.push('××™× ×• ×ª×• ×™×¨×•×§'); }
            
            // Ring
            if(g !== 'E') {
                if(Core.ringStatus === 'stress' && p.tags.includes('sug')) { g='D'; reasons.push('×¡×•×›×¨ (×¡×˜×¨×¡)'); }
                if(Core.ringStatus === 'sugar' && p.tags.includes('sug')) { 
                    reasons.push('××¢×œ×” ×¡×•×›×¨ (××•××œ×¥)');
                    if(g=='C') g='B'; else if(g=='B') g='A';
                }
            }

            this.currentProduct = { ...p, g: g };
            
            // Render Result
            document.getElementById('res-grade').innerText = g;
            document.getElementById('res-grade').style.color = UI.getColor(g);
            document.getElementById('res-grade').style.boxShadow = `0 0 60px ${UI.getColor(g)}`;
            
            document.getElementById('res-name').innerText = p.n;
            document.getElementById('res-brand').innerText = p.b;
            
            const rEl = document.getElementById('res-reasons');
            if(reasons.length > 0) {
                rEl.innerHTML = reasons.map(r => `<div style="color:#ffaaaa; margin-bottom:4px;">âš ï¸ ${r}</div>`).join('');
            } else {
                rEl.innerHTML = '<div style="color:#aaffaa; font-weight:bold;">âœ… ××•×¦×¨ ×ª×•×× ×œ×¤×¨×•×¤×™×œ</div>';
            }

            UI.openModal('result');
        }
    };

    // --- 9. HELPERS ---
    function toggleAcc(el) { el.nextElementSibling.classList.toggle('show'); }
    
    // Init App
    Core.init();

</script>
</body>
</html>
