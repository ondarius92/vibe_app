<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Vibe OS 60.0 - God Mode</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { 
            --primary: #00e676; --warn: #ffca28; --danger: #ff5252; --bg: #000000; 
            --surface: #111111; --surface-soft: #1e1e1e; --text: #ffffff; --radius: 16px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding-bottom: 160px; user-select: none; }
        
        /* HEADER */
        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.95); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #333; backdrop-filter: blur(10px); }
        .brand { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; background: linear-gradient(90deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-icons { display: flex; gap: 15px; }
        .icon-btn { font-size: 22px; cursor: pointer; position: relative; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--primary); color: black; font-size: 10px; font-weight: 900; padding: 2px 5px; border-radius: 10px; border: 2px solid var(--bg); }

        /* DASHBOARD */
        .bento-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; padding: 15px; }
        .bento-card { background: var(--surface); padding: 15px; border-radius: var(--radius); border: 1px solid #222; position: relative; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
        .bento-val { font-size: 28px; font-weight: 800; margin-top: 5px; }
        .bento-lbl { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .progress-container { width: 100%; height: 6px; background: #333; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--warn), var(--primary)); transition: width 0.6s ease; }

        /* FILTERS */
        .filter-sec { padding: 0 20px 40px 20px; }
        .sec-head { font-size: 11px; color: var(--primary); font-weight: 800; text-transform: uppercase; margin: 30px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .acc { margin-bottom: 8px; background: var(--surface); border-radius: 12px; border: 1px solid #222; overflow: hidden; transition: 0.2s; }
        .acc-head { padding: 16px; font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; border-right: 4px solid transparent; cursor: pointer; background: var(--surface-soft); }
        .acc-body { display: none; padding: 15px; background: #000; flex-wrap: wrap; gap: 8px; border-top: 1px solid #222; }
        .acc-body.open { display: flex; }
        
        .c-red .acc-head { border-color: var(--danger); }
        .c-blue .acc-head { border-color: var(--primary); }
        .c-gold .acc-head { border-color: var(--gold); }
        .c-purple .acc-head { border-color: #d500f9; }

        .chip { display: none; }
        .lbl { padding: 8px 14px; background: #1f1f1f; border: 1px solid #333; border-radius: 50px; font-size: 13px; color: #aaa; transition: 0.2s; cursor: pointer; display: flex; align-items: center; gap: 6px; flex-grow: 1; justify-content: center; }
        .chip:checked + .lbl { background: #eee; color: #000; font-weight: 800; border-color: #fff; transform: scale(1.02); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .danger .chip:checked + .lbl { background: rgba(255, 82, 82, 0.2); color: var(--danger); border-color: var(--danger); }
        .safe .chip:checked + .lbl { background: rgba(0, 230, 118, 0.2); color: var(--primary); border-color: var(--primary); }

        /* SCANNER */
        #scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .scan-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 80px; pointer-events: none; }
        .close-cam { pointer-events: auto; background: rgba(30,30,30,0.9); color: white; padding: 15px 40px; border-radius: 50px; border: 1px solid #555; margin: 0 auto; font-weight: bold; backdrop-filter: blur(10px); cursor: pointer; }

        /* BOTTOM BAR */
        .action-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(30,30,30,0.95); padding: 10px; border-radius: 100px; display: flex; justify-content: space-between; border: 1px solid #444; z-index: 300; backdrop-filter: blur(20px); box-shadow: 0 10px 40px rgba(0,0,0,0.7); }
        .bar-btn { width: 50px; height: 50px; border: none; background: transparent; font-size: 24px; cursor: pointer; color: #888; display: flex; align-items: center; justify-content: center; }
        .scan-btn { width: 70px; height: 70px; background: white; border-radius: 25px; margin-top: -30px; border: none; box-shadow: 0 5px 30px rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; color: black; transition: 0.2s; }
        .scan-btn:active { transform: scale(0.95); }

        /* RESULTS SHEET */
        #sheet-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; pointer-events: none; opacity: 0; transition: 0.3s; }
        .active-sheet { opacity: 1 !important; pointer-events: auto !important; }
        #sheet-bg { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        #bottom-sheet { position: absolute; bottom: 0; width: 100%; background: #161616; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-top: 1px solid #333; max-height: 85vh; overflow-y: auto; }
        .active-sheet #bottom-sheet { transform: translateY(0); }

        .prod-header { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .prod-thumb { width: 90px; height: 90px; background: white; border-radius: 20px; object-fit: contain; padding: 5px; }
        .editable-name { background: transparent; border: none; border-bottom: 1px dashed #555; color: white; font-size: 20px; font-weight: 800; width: 100%; font-family: inherit; margin-bottom: 5px; padding: 5px 0; border-radius: 0; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .info-tag { padding: 8px 14px; border-radius: 10px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .tag-neutral { background: rgba(255, 202, 40, 0.1); color: var(--warn); border: 1px solid rgba(255, 202, 40, 0.3); } 
        .tag-good { background: rgba(0, 230, 118, 0.1); color: var(--primary); border: 1px solid rgba(0, 230, 118, 0.3); } 
        .tag-danger { background: rgba(255, 82, 82, 0.1); color: var(--danger); border: 1px solid rgba(255, 82, 82, 0.3); } 

        .analysis-box { background: #222; padding: 15px; border-radius: 16px; margin: 15px 0; font-size: 14px; line-height: 1.6; color: #ddd; border: 1px solid #333; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .sheet-btn { padding: 16px; border-radius: 16px; border: 1px solid #333; font-weight: 700; cursor: pointer; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 6px; background: #222; color: white; transition: 0.2s; }
        .sheet-btn.primary { background: var(--primary); color: black; border-color: var(--primary); grid-column: span 2; }

        .grade-badge { font-size: 40px; font-weight: 900; }
        .grade-A { color: #00e676; } .grade-B { color: #cddc39; } .grade-C { color: #ffca28; } .grade-D { color: #ff9800; } .grade-E { color: #ff5252; }
        
        .quality-warning { background: rgba(255,82,82,0.15); border: 1px solid var(--danger); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: none; align-items: center; gap: 10px; font-size: 13px; color: #ff8a80; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 600; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: flex-end; }
        .modal.open { opacity: 1; pointer-events: auto; }
        .modal-content { width: 100%; background: #161616; border-radius: 30px 30px 0 0; max-height: 90vh; overflow-y: auto; border-top: 1px solid #333; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; }
        .modal.open .modal-content { transform: translateY(0); }
        .modal-header { padding: 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; background: #161616; position: sticky; top: 0; z-index: 10; }
        .modal-body { padding: 25px; }

        .aisle-header { font-size: 13px; color: var(--primary); font-weight: 900; text-transform: uppercase; margin: 25px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; letter-spacing: 1px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; background: #1f1f1f; padding: 15px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #333; }
        .clean-inp { width: 100%; background: #252525; border: 1px solid #444; color: white; padding: 16px; border-radius: 14px; font-size: 16px; margin-bottom: 15px; text-align: center; font-weight: 500; }
        
        .goal-btn { flex: 1; padding: 15px; background: #222; border: 1px solid #444; color: #888; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .goal-btn.active { background: var(--primary); color: black; border-color: var(--primary); box-shadow: 0 0 15px rgba(0,230,118,0.3); }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #222; color: white; padding: 12px 24px; border-radius: 50px; border: 1px solid #444; z-index: 1000; transition: 0.3s; font-weight: bold; display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="header">
        <div class="brand">Vibe OS 60.0</div>
        <div class="nav-icons">
            <div class="icon-btn" onclick="toggleModal('history-modal')">ğŸ“œ</div>
            <div class="icon-btn" onclick="toggleModal('settings-modal')">âš™ï¸</div>
            <div class="icon-btn" onclick="toggleModal('cart-modal')">ğŸ›’ <span class="badge" id="badge">0</span></div>
        </div>
    </div>

    <div class="bento-grid">
        <div class="bento-card wide">
            <div style="display:flex; justify-content:space-between;">
                <div class="bento-lbl" id="goal-display">××˜×¨×”: ×›×œ×œ×™</div>
                <div class="bento-lbl" id="score-text" style="color:var(--primary);">0%</div>
            </div>
            <div class="progress-container"><div class="progress-fill" id="basket-score-bar" style="width: 0%;"></div></div>
            <div style="font-size:11px; color:#666; margin-top:5px;">××“×“ ××™×›×•×ª ×”×¡×œ (××‘×•×¡×¡ ×¢×œ ×¢×¨×›×™× ×ª×–×•× ×ª×™×™×)</div>
        </div>
        <div class="bento-card"><div class="bento-lbl">×¦×¨×™×›×” (BMR)</div><div class="bento-val" id="d-tdee">--</div></div>
        <div class="bento-card"><div class="bento-lbl">×¤×¨×™×˜×™×</div><div class="bento-val" id="d-cart">0</div></div>
    </div>

    <div class="filter-sec">
        <div class="sec-head">×¤×¨×•×¤×™×œ ×ª×–×•× ×ª×™</div>
        
        <div class="acc c-red"><div class="acc-head" onclick="tog(this)">âš ï¸ ××œ×¨×’×™×•×ª (×¦×™×•×Ÿ 0) <span>â–¾</span></div><div class="acc-body danger">
            <input type="checkbox" id="a-milk" class="chip save"><label for="a-milk" class="lbl">ğŸ¥› ×—×œ×‘</label>
            <input type="checkbox" id="a-gluten" class="chip save"><label for="a-gluten" class="lbl">ğŸ ×’×œ×•×˜×Ÿ</label>
            <input type="checkbox" id="a-nuts" class="chip save"><label for="a-nuts" class="lbl">ğŸŒ° ××’×•×–×™×</label>
            <input type="checkbox" id="a-peanuts" class="chip save"><label for="a-peanuts" class="lbl">ğŸ¥œ ×‘×•×˜× ×™×</label>
            <input type="checkbox" id="a-soy" class="chip save"><label for="a-soy" class="lbl">ğŸ¥¢ ×¡×•×™×”</label>
            <input type="checkbox" id="a-sesame" class="chip save"><label for="a-sesame" class="lbl">ğŸ¥¯ ×©×•××©×•×</label>
            <input type="checkbox" id="a-eggs" class="chip save"><label for="a-eggs" class="lbl">ğŸ¥š ×‘×™×¦×™×</label>
            <input type="checkbox" id="a-fish" class="chip save"><label for="a-fish" class="lbl">ğŸŸ ×“×’×™×</label>
            <input type="checkbox" id="a-sulfites" class="chip save"><label for="a-sulfites" class="lbl">ğŸ· ×¡×•×œ×¤×™×˜×™×</label>
        </div></div>

        <div class="acc c-red"><div class="acc-head" onclick="tog(this)">ğŸ¥ × ×™×”×•×œ ×¨×¤×•××™ <span>â–¾</span></div><div class="acc-body danger">
            <input type="checkbox" id="d-diabetic" class="chip save"><label for="d-diabetic" class="lbl">ğŸ’‰ ×¡×•×›×¨×ª</label>
            <input type="checkbox" id="d-heart" class="chip save"><label for="d-heart" class="lbl">ğŸ«€ ×œ×‘/× ×ª×¨×Ÿ</label>
            <input type="checkbox" id="d-cholesterol" class="chip save"><label for="d-cholesterol" class="lbl">ğŸ” ×›×•×œ×¡×˜×¨×•×œ</label>
            <input type="checkbox" id="d-celiac" class="chip save"><label for="d-celiac" class="lbl">ğŸŒ¾ ×¦×œ×™××§</label>
            <input type="checkbox" id="d-gout" class="chip save"><label for="d-gout" class="lbl">ğŸ¦¶ ×’××•×˜</label>
            <input type="checkbox" id="d-kidney" class="chip save"><label for="d-kidney" class="lbl">ğŸ©º ×›×œ×™×•×ª</label>
            <input type="checkbox" id="d-reflux" class="chip save"><label for="d-reflux" class="lbl">ğŸ”¥ ×¦×¨×‘×ª</label>
            <input type="checkbox" id="d-ibs" class="chip save"><label for="d-ibs" class="lbl">ğŸˆ ××¢×™ ×¨×’×™×–</label>
            <input type="checkbox" id="d-anemia" class="chip save"><label for="d-anemia" class="lbl">ğŸ©¸ ×× ××™×”</label>
        </div></div>

        <div class="acc c-purple"><div class="acc-head" onclick="tog(this)">ğŸ‘¶ ×™×œ×“×™× ×•×¨×’×™×©×•×™×•×ª <span>â–¾</span></div><div class="acc-body danger">
            <input type="checkbox" id="x-kids" class="chip save"><label for="x-kids" class="lbl">ğŸ§¸ ×œ×œ× ×¦×‘×¢×™ ×××›×œ ××–×™×§×™× (E)</label>
            <input type="checkbox" id="x-preg" class="chip save"><label for="x-preg" class="lbl">ğŸ¤° ×”×¨×™×•×Ÿ</label>
            <input type="checkbox" id="x-baby" class="chip save"><label for="x-baby" class="lbl">ğŸ¼ ×ª×™× ×•×§×•×ª</label>
            <input type="checkbox" id="x-elderly" class="chip save"><label for="x-elderly" class="lbl">ğŸ‘´ ×’×™×œ ×©×œ×™×©×™</label>
        </div></div>

        <div class="acc c-blue"><div class="acc-head" onclick="tog(this)">ğŸ¥— ×“×™××˜×” ×•×œ×™×™×£ ×¡×˜×™×™×œ <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="l-vegan" class="chip save"><label for="l-vegan" class="lbl">ğŸŒ± ×˜×‘×¢×•× ×™</label>
            <input type="checkbox" id="l-vegetarian" class="chip save"><label for="l-vegetarian" class="lbl">ğŸ§€ ×¦××—×•× ×™</label>
            <input type="checkbox" id="l-keto" class="chip save"><label for="l-keto" class="lbl">ğŸ¥‘ ×§×˜×•</label>
            <input type="checkbox" id="l-paleo" class="chip save"><label for="l-paleo" class="lbl">ğŸ– ×¤×œ×™××•</label>
            <input type="checkbox" id="l-lowcarb" class="chip save"><label for="l-lowcarb" class="lbl">ğŸ“‰ ×“×œ ×¤×—××™××”</label>
            <input type="checkbox" id="c-clean" class="chip save"><label for="c-clean" class="lbl">ğŸ§ª ×ª×•×•×™×ª × ×§×™×™×”</label>
            <input type="checkbox" id="c-sugar" class="chip save"><label for="c-sugar" class="lbl">ğŸ­ ×œ×œ× ×¡×•×›×¨</label>
            <input type="checkbox" id="c-organic" class="chip save"><label for="c-organic" class="lbl">ğŸ‚ ××•×¨×’× ×™</label>
        </div></div>

        <div class="acc c-gold"><div class="acc-head" onclick="tog(this)">âœ¡ï¸ ×“×ª ×•××¡×•×¨×ª <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="k-kosher" class="chip save"><label for="k-kosher" class="lbl">ğŸ“œ ×›×©×¨</label>
            <input type="checkbox" id="k-badatz" class="chip save"><label for="k-badatz" class="lbl">âœ¨ ×‘×“"×¥</label>
            <input type="checkbox" id="k-parve" class="chip save"><label for="k-parve" class="lbl">ğŸ ×¤×¨×•×•×”</label>
            <input type="checkbox" id="k-halal" class="chip save"><label for="k-halal" class="lbl">â˜ªï¸ ×—×œ××œ</label>
            <input type="checkbox" id="k-passover" class="chip save"><label for="k-passover" class="lbl">ğŸš« ×œ×¤×¡×—</label>
        </div></div>

        <div class="acc c-blue"><div class="acc-head" onclick="tog(this)">âš¡ ×¡×¤×•×¨×˜ ×•×—×™×˜×•×‘ <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="p-protein" class="chip save"><label for="p-protein" class="lbl">ğŸ’ª ×—×œ×‘×•×Ÿ ×’×‘×•×”</label>
            <input type="checkbox" id="p-bulk" class="chip save"><label for="p-bulk" class="lbl">ğŸ¦ ××¡×”</label>
            <input type="checkbox" id="p-cut" class="chip save"><label for="p-cut" class="lbl">âœ‚ï¸ ×—×™×˜×•×‘</label>
            <input type="checkbox" id="p-energy" class="chip save"><label for="p-energy" class="lbl">ğŸ”‹ ×× ×¨×’×™×”</label>
        </div></div>
        
        <div class="acc c-blue"><div class="acc-head" onclick="tog(this)">ğŸŒ ×¢×¨×›×™× <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="b-israel" class="chip save" checked><label for="b-israel" class="lbl">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</label>
            <input type="checkbox" id="b-fairtrade" class="chip save"><label for="b-fairtrade" class="lbl">ğŸ¤ ×¡×—×¨ ×”×•×’×Ÿ</label>
        </div></div>
    </div>

    <div id="scanner-overlay">
        <div id="reader"></div>
        <button class="close-cam" onclick="stopCamera()">×¡×’×•×¨ ××¦×œ××”</button>
    </div>

    <div class="action-bar">
        <button class="bar-btn" onclick="manualSearch()">âŒ¨ï¸</button>
        <button class="scan-btn" onclick="startCamera()">
            <svg viewBox="0 0 24 24" width="30" height="30"><path d="M4 6h2v12H4zm14 0h2v12h-2zm-4 0h2v12h-2zm-4 0h2v12h-2z" fill="black"/><path d="M2 4v16h20V4H2zm18 14H4V6h16v12z" fill="none" stroke="black" stroke-width="2"/></svg>
        </button>
        <button class="bar-btn" onclick="toggleModal('history-modal')">ğŸ“œ</button>
    </div>

    <div id="sheet-wrapper">
        <div id="sheet-bg" onclick="closeSheet()"></div>
        <div class="modal-content" id="bottom-sheet">
            <div style="width:40px;height:4px;background:#333;margin:0 auto 20px auto;border-radius:10px;"></div>
            <div style="padding:25px;">
                <div class="prod-header">
                    <img id="p-img" class="prod-thumb" src="" onerror="this.style.display='none'">
                    <div style="flex:1;">
                        <div id="p-brand" style="font-size:11px;color:#888;font-weight:700;"></div>
                        <input type="text" id="p-name" class="editable-name" value="..." oninput="updateName(this.value)">
                        <div style="font-size:10px;color:#666;">âœ ×œ×—×¥ ×œ×ª×™×§×•×Ÿ ×©× ×œ×¦×•×¨×š ×”×©×•×•××”</div>
                    </div>
                    <div style="text-align:center;">
                        <div id="grade-display" class="grade-badge"></div>
                        <div style="font-size:10px;color:#888;">Nutri-Score</div>
                    </div>
                </div>

                <div id="quality-warning" class="quality-warning">âš ï¸ ×”××•×¦×¨ ×—×•×¨×’ ××˜×•×•×— ×”××™×›×•×ª ×©×‘×—×¨×ª (A-B)</div>

                <div id="tags-area" class="tags-container"></div>
                <div id="bio-res" class="analysis-box"></div>

                <div class="action-grid">
                    <button class="sheet-btn" onclick="comparePrecise()">ğŸ” ×”×©×•×•××ª ××—×™×¨<br><span style="font-size:10px;opacity:0.6;">×‘×™×©×¨××œ</span></button>
                    <button class="sheet-btn" onclick="findAlternatives()">ğŸ’¡ ×—×œ×•×¤×” ×–×•×œ×”<br><span style="font-size:10px;opacity:0.6;">×œ×œ× ××•×ª×’</span></button>
                    <button class="sheet-btn primary" onclick="addToCart()">ğŸ›’ ×”×•×¡×£ ×œ×¡×œ ×©×‘×•×¢×™</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×”×’×“×¨×•×ª ×¤×¨×•×¤×™×œ</h2><button onclick="closeModal('settings-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body">
                
                <div style="margin-bottom:20px;">
                    <label style="color:#888; font-size:11px; font-weight:bold;">××™×Ÿ (×œ×—×™×©×•×‘ BMR)</label>
                    <div style="display:flex; gap:10px;">
                        <button class="goal-btn" id="gen-male" onclick="setGender('male')">×’×‘×¨</button>
                        <button class="goal-btn" id="gen-female" onclick="setGender('female')">××™×©×”</button>
                    </div>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="color:#888; font-size:11px; font-weight:bold;">××˜×¨×”</label>
                    <div style="display:flex; gap:10px;">
                        <button class="goal-btn" id="goal-cut" onclick="setGoal('cut')">×—×™×˜×•×‘</button>
                        <button class="goal-btn" id="goal-main" onclick="setGoal('maintain')">×©××™×¨×”</button>
                        <button class="goal-btn" id="goal-bulk" onclick="setGoal('bulk')">××¡×”</button>
                    </div>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="color:#888; font-size:11px; font-weight:bold;">×‘×§×¨×ª ××™×›×•×ª (×”×ª×¨××” ×‘×¦×™×•×Ÿ × ××•×š)</label>
                    <select id="u-grade-limit" class="clean-inp">
                        <option value="E">×œ×œ× ×¡×™× ×•×Ÿ (×”×›×œ)</option>
                        <option value="C">×”×¡×¨ ××•×¦×¨×™× ×’×¨×•×¢×™× (A-C)</option>
                        <option value="B">××™×›×•×ª×™ ×‘×œ×‘×“ (A-B)</option>
                        <option value="A">××¦×•×™×Ÿ ×‘×œ×‘×“ (A)</option>
                    </select>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="color:#888; font-size:11px; font-weight:bold;">× ×ª×•× ×™× ×•××©×§×œ ×—×›×</label>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="number" id="u-w" class="clean-inp" placeholder="××©×§×œ (×§×’)">
                        <input type="number" id="u-h" class="clean-inp" placeholder="×’×•×‘×” (×¡×)">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="u-age" class="clean-inp" placeholder="×’×™×œ">
                        <button onclick="manualSync()" class="clean-inp" style="background:#333;">ğŸ”— ×¡× ×›×¨×•×Ÿ BMR</button>
                    </div>
                </div>

                <button onclick="saveProfile()" class="clean-inp" style="background:white; color:black; font-weight:bold;">×©××•×¨ ×”×’×“×¨×•×ª</button>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×¡×œ ×§× ×™×•×ª ×©×‘×•×¢×™</h2><button onclick="closeModal('cart-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body">
                <textarea id="import-area" class="clean-inp" style="height:80px; text-align:right;" placeholder="×”×“×‘×§ ×›××Ÿ ×¨×©×™××” ××”×¤×ª×§×™×..."></textarea>
                <button onclick="importList()" class="clean-inp" style="background:#333; margin-bottom:15px;">ğŸ“¥ ×¡× ×›×¨×•×Ÿ ×•×¡×™×“×•×¨ ××•×˜×•××˜×™</button>
                <div id="cart-body"></div>
            </div>
            <div style="padding:20px; text-align:center; border-top:1px solid #333;"><button onclick="shareCart()" class="clean-inp" style="background:var(--primary); color:black; font-weight:bold;">×•×•××˜×¡××¤ ğŸ“¤</button></div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×”×™×¡×˜×•×¨×™×”</h2><button onclick="closeModal('history-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body" id="history-list"></div>
            <div style="padding:20px;"><button onclick="clearHistory()" class="clean-inp" style="background:var(--danger);color:white;">× ×§×” ×”×›×œ</button></div>
        </div>
    </div>

    <script>
        // --- VIBE OS 60.0 CORE LOGIC ---
        
        let cart=[], history=[], user={gender:'male', goal:'maintain', w:75, h:175, age:30, tdee:2000, minGrade:'E'};
        try {
            cart = JSON.parse(localStorage.getItem('vibeCart60')) || [];
            history = JSON.parse(localStorage.getItem('vibeHistory')) || [];
            user = JSON.parse(localStorage.getItem('vibeUser60')) || user;
        } catch(e){ localStorage.clear(); }

        let currentItem = { name: '', code: '', brand: '', category: 'other' };

        // --- ISRAELI BRANDS & PREFIXES FOR CLEANING ---
        const prefixes = ['×©×œ','××‘×™×ª','×‘×˜×¢×','×¡×•×’','×ª×•×¦×¨×ª','××¤×¢×œ','×§×™×‘×•×¥'];
        const ilBrands = ['××¡×','×ª× ×•×‘×”','×©×˜×¨××•×¡','×¢×œ×™×ª','×ª×œ××”','×§× ×•×¨','×¡×•×’×ª','×•×™×¡×•×¦×§×™','×˜×¨×”','×’×“','×¤×¨×™×’×ª','× ×‘×™×¢×•×ª','××™ ×¢×“×Ÿ','×©×•×•×¤×¡','×§×•×§×” ×§×•×œ×”','×¤×¤×¡×™','× ×¡×˜×œ×”','×™×•×¤×œ×”','×“× ×•× ×”','××™×œ×§×™','×§×¨×œ×•','×‘××‘×”','×‘×™×¡×œ×™','×ª×¤×•×¦×™×¤×¡','×¤×¨×™× ×’×œ×¡','××—×œ×”','×¦×‘×¨','×©××™×¨','××¢×“× ×•×ª','×˜×‘×¢×•×œ','×–×•×’×œ×•×‘×§','×™×—×™×¢×','×˜×™×¨×ª ×¦×‘×™','×¢×•×£ ×˜×•×‘','×¡× ×¤×¨×•×¡×˜','×•×™×œ×™ ×¤×•×“','×¨××™ ×œ×•×™','×©×•×¤×¨×¡×œ','××•×©×¨ ×¢×“','×•×™×§×˜×•×¨×™','×”×™×™× ×¥','×”×œ×× ×¡','×× ×”','×××¡×˜×¨ ×©×£','×¡××™ ×‘×•×¨×§×¡','××¢×•×œ×”','×™×©','×¡× ×•','× ×™×§×•×œ','×—×•×’×œ×”','×œ×™×œ×™','×¤×¨×¡×™×œ','××¨×™××œ','×¡×•×“','×¤×™× ×™×©','×§×•×œ×’×™×™×˜','××•×¨×‘×™×˜'];
        const brandRegex = new RegExp(`(${ilBrands.join('|')}|${prefixes.join('|')})`, 'gi');

        // --- DICTIONARY ---
        const dict = {
            'milk':{he:'×—×œ×‘',c:'fridge'},'cheese':{he:'×’×‘×™× ×”',c:'fridge'},'yogurt':{he:'×™×•×’×•×¨×˜',c:'fridge'},'butter':{he:'×—×××”',c:'fridge'},'cream':{he:'×©×× ×ª',c:'fridge'},'cottage':{he:'×§×•×˜×’',c:'fridge'},'labane':{he:'×œ×‘× ×”',c:'fridge'},
            'bread':{he:'×œ×—×',c:'pantry'},'pita':{he:'×¤×™×ª×”',c:'pantry'},'bun':{he:'×œ×—×× ×™×”',c:'pantry'},'pasta':{he:'×¤×¡×˜×”',c:'pantry'},'rice':{he:'××•×¨×–',c:'pantry'},'flour':{he:'×§××—',c:'pantry'},'sugar':{he:'×¡×•×›×¨',c:'pantry'},'salt':{he:'××œ×—',c:'pantry'},'oil':{he:'×©××Ÿ',c:'pantry'},'couscous':{he:'×§×•×¡×§×•×¡',c:'pantry'},'ptitim':{he:'×¤×ª×™×ª×™×',c:'pantry'},
            'tomato':{he:'×¢×’×‘× ×™×”',c:'veg'},'cucumber':{he:'××œ×¤×¤×•×Ÿ',c:'veg'},'apple':{he:'×ª×¤×•×—',c:'veg'},'banana':{he:'×‘× × ×”',c:'veg'},'lemon':{he:'×œ×™××•×Ÿ',c:'veg'},'pepper':{he:'×¤×œ×¤×œ',c:'veg'},'potato':{he:'×ª×¤×•×— ××“××”',c:'veg'},'onion':{he:'×‘×¦×œ',c:'veg'},'garlic':{he:'×©×•×',c:'veg'},'avocado':{he:'××‘×•×§×“×•',c:'veg'},'lettuce':{he:'×—×¡×”',c:'veg'},
            'chicken':{he:'×¢×•×£',c:'meat'},'beef':{he:'×‘×§×¨',c:'meat'},'fish':{he:'×“×’',c:'meat'},'tuna':{he:'×˜×•× ×”',c:'pantry'},'egg':{he:'×‘×™×¦×™×',c:'fridge'},'salami':{he:'× ×§× ×™×§',c:'meat'},'sausage':{he:'× ×§× ×™×§×™×”',c:'meat'},
            'water':{he:'××™×',c:'pantry'},'juice':{he:'××™×¥',c:'fridge'},'soda':{he:'××©×§×”',c:'pantry'},'cola':{he:'×§×•×œ×”',c:'pantry'},'coffee':{he:'×§×¤×”',c:'pantry'},'tea':{he:'×ª×”',c:'pantry'},
            'chips':{he:'×—×˜×™×£',c:'pantry'},'bamba':{he:'×‘××‘×”',c:'pantry'},'bisli':{he:'×‘×™×¡×œ×™',c:'pantry'},'chocolate':{he:'×©×•×§×•×œ×“',c:'pantry'},'cookie':{he:'×¢×•×’×™×”',c:'pantry'},'cracker':{he:'×§×¨×§×¨',c:'pantry'},
            'shampoo':{he:'×©××¤×•',c:'home'},'soap':{he:'×¡×‘×•×Ÿ',c:'home'},'bleach':{he:'××§×•× ×•××™×§×”',c:'home'},'paper':{he:'× ×™×™×¨ ×˜×•××œ×˜',c:'home'},'wipes':{he:'××’×‘×•× ×™×',c:'home'},'diaper':{he:'×—×™×ª×•×œ×™×',c:'home'}
        };
        const aisles = {'veg':'ğŸ¥¦ ×™×¨×§×•×ª','fridge':'â„ï¸ ××§×¨×¨','meat':'ğŸ¥© ×‘×©×¨','pantry':'ğŸ ××–×•×•×”','home':'ğŸ§´ ×‘×™×ª','other':'ğŸ›’ ×›×œ×œ×™'};

        window.onload=()=>{ renderCart(); renderHistory(); loadChecks(); applySettingsUI(); calculateTDEE(); };

        // --- UI CORE ---
        function tog(h){h.nextElementSibling.classList.toggle('open')}
        function toggleModal(id){document.getElementById(id).classList.toggle('open')}
        function closeModal(id){document.getElementById(id).classList.remove('open')}
        function closeSheet(){document.getElementById('sheet-wrapper').classList.remove('active-sheet')}
        function updateName(val){ currentItem.name=val; }
        const chk=(id)=>document.getElementById(id).checked;
        function showToast(msg){ const t=document.getElementById('toast'); t.innerHTML=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
        function loadChecks(){ document.querySelectorAll('.save').forEach(el=>{ if(localStorage.getItem(el.id)==='true') el.checked=true; el.addEventListener('change',()=>localStorage.setItem(el.id,el.checked)); }); }

        // --- SETTINGS ---
        function setGender(g){ user.gender=g; applySettingsUI(); }
        function setGoal(g){ user.goal=g; applySettingsUI(); }
        
        function applySettingsUI(){
            document.querySelectorAll('.goal-btn').forEach(b=>b.classList.remove('active'));
            if(user.gender) document.getElementById('gen-'+user.gender).classList.add('active');
            if(user.goal) {
                if(user.goal==='cut') document.getElementById('goal-cut').classList.add('active');
                if(user.goal==='maintain') document.getElementById('goal-main').classList.add('active');
                if(user.goal==='bulk') document.getElementById('goal-bulk').classList.add('active');
            }
            document.getElementById('u-grade-limit').value = user.minGrade || 'E';
            document.getElementById('u-w').value = user.w;
            document.getElementById('u-h').value = user.h;
            document.getElementById('u-age').value = user.age;
            
            const goalMap = {cut:'×—×™×˜×•×‘', maintain:'×©××™×¨×”', bulk:'××¡×”'};
            document.getElementById('goal-display').innerText = "××˜×¨×”: " + (goalMap[user.goal] || "×œ× ×”×•×’×“×¨×”");
        }

        function calculateTDEE(){
            if(!user.w || !user.h || !user.age) return;
            // Mifflin-St Jeor
            let s = (user.gender==='male' ? 5 : -161);
            let bmr = (10*user.w) + (6.25*user.h) - (5*user.age) + s;
            let tdee = bmr * 1.375;
            
            if(user.goal==='cut') tdee -= 500;
            if(user.goal==='bulk') tdee += 300;
            
            user.tdee = Math.round(tdee);
            document.getElementById('d-tdee').innerText = user.tdee;
        }

        function manualSync(){
            let val = prompt("×”×–×Ÿ BMR ××”××©×§×œ ×”×—×›×:", user.tdee);
            if(val && !isNaN(val)) { user.tdee = Math.round(Number(val)); document.getElementById('d-tdee').innerText = user.tdee; showToast("âœ… ×¡×•× ×›×¨×Ÿ ×™×“× ×™×ª"); saveProfile(); }
        }

        function saveProfile(){
            user.minGrade = document.getElementById('u-grade-limit').value;
            user.w = Number(document.getElementById('u-w').value);
            user.h = Number(document.getElementById('u-h').value);
            user.age = Number(document.getElementById('u-age').value);
            calculateTDEE();
            localStorage.setItem('vibeUser60', JSON.stringify(user));
            closeModal('settings-modal'); showToast("×”×¤×¨×•×¤×™×œ × ×©××¨");
            applySettingsUI();
        }

        // --- ANALYSIS CORE ---
        async function analyze(code){
            document.getElementById('sheet-wrapper').classList.add('active-sheet');
            document.getElementById('p-name').value="×˜×•×¢×Ÿ...";
            document.getElementById('tags-area').innerHTML="";
            document.getElementById('quality-warning').style.display='none';
            document.getElementById('grade-display').innerText = "--";
            
            try {
                const res=await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
                const data=await res.json();
                if(data.status!==1) throw new Error();
                const p=data.product;
                
                let name=p.product_name_he||p.product_name||"";
                let cat='other';
                let lowName=name.toLowerCase();
                for(const [k,v] of Object.entries(dict)){
                    if(lowName.includes(k)){
                        if(!p.product_name_he) name=v.he+" "+(p.brands||"");
                        cat=v.c; break;
                    }
                }
                
                currentItem={name:name, code:code, brand:p.brands||"", category:cat};
                document.getElementById('p-name').value=name;
                document.getElementById('p-brand').innerText=p.brands||"";
                document.getElementById('p-img').src=p.image_front_small_url||"";

                const n=p.nutriments||{};
                const txt=(JSON.stringify(p.ingredients_text)+JSON.stringify(p.labels)).toLowerCase();
                const add=(p.additives_tags||[]).join(" ");
                let tags="";
                let score=100;

                // --- LOGIC ---
                // Helper
                const check = (id, k, t, pen) => { if(chk(id)){ for(let w of k) if(txt.includes(w)){ tags+=`<div class="info-tag tag-danger">â›” ${t}</div>`; score-=pen; return; } } };

                check('a-milk',['milk','lait','×—×œ×‘','whey'],'×—×œ×‘',50);
                check('a-gluten',['gluten','wheat','×—×™×˜×”','barley','rye'],'×’×œ×•×˜×Ÿ',50);
                check('a-nuts',['nut','almond','××’×•×–','cashew','pecan'],'××’×•×–×™×',50);
                check('a-peanuts',['peanut','×‘×•×˜× ×™×'],'×‘×•×˜× ×™×',50);
                check('a-soy',['soy','×¡×•×™×”'],'×¡×•×™×”',50);
                check('a-sesame',['sesame','×©×•××©×•×'],'×©×•××©×•×',50);
                check('a-eggs',['egg','oeuf','×‘×™×¦×™×'],'×‘×™×¦×™×',50);
                check('a-fish',['fish','×“×’'],'×“×’×™×/×™×•×“',50);
                check('a-sulfites',['sulfite','e220','e224'],'×¡×•×œ×¤×™×˜×™×',50);

                if(chk('d-diabetic')&&(n.sugars_100g>5||n.carbohydrates_100g>50)) {tags+=`<div class="info-tag tag-neutral">ğŸ¬ ×¡×•×›×¨ ×’×‘×•×”</div>`; score-=30;}
                if(chk('d-heart')&&(n.salt_100g>1||n['saturated-fat_100g']>4)) {tags+=`<div class="info-tag tag-neutral">ğŸ§‚ × ×ª×¨×Ÿ ×’×‘×•×”</div>`; score-=30;}
                if(chk('d-cholesterol')&&n.cholesterol_100g>0.05) {tags+=`<div class="info-tag tag-neutral">ğŸ” ×›×•×œ×¡×˜×¨×•×œ</div>`; score-=20;}
                if(chk('d-gout')&&(txt.includes('liver')||txt.includes('yeast'))) {tags+=`<div class="info-tag tag-neutral">ğŸ¦µ ×¤×•×¨×™× ×™×</div>`; score-=20;}
                if(chk('d-kidney')&&(n.potassium_100g>0.3||add.includes('phosphate'))) tags+=`<div class="info-tag tag-neutral">ğŸ©º ××©×œ×’×Ÿ</div>`;
                if(chk('d-reflux')&&(txt.includes('spice')||txt.includes('citrus'))) tags+=`<div class="info-tag tag-neutral">ğŸ”¥ ×—×•××¦×™×•×ª</div>`;
                if(chk('d-ibs')&&(txt.includes('onion')||txt.includes('garlic'))) tags+=`<div class="info-tag tag-neutral">ğŸˆ FODMAP</div>`;
                if(chk('d-anemia')&&(txt.includes('tea')||txt.includes('coffee'))) tags+=`<div class="info-tag tag-neutral">ğŸ©¸ ××¢×›×‘ ×‘×¨×–×œ</div>`;

                if(chk('x-preg')&&(txt.includes('caffeine')||txt.includes('alcohol'))) tags+=`<div class="info-tag tag-danger">â›” ×§×¤××™×Ÿ/××œ×›×•×”×•×œ</div>`;
                
                // KIDS (Southampton 6)
                if(chk('x-kids')){
                    if(txt.includes('e102')||txt.includes('e110')||txt.includes('e122')||txt.includes('e124')||txt.includes('e129')||txt.includes('e104')) {
                        tags+=`<div class="info-tag tag-danger">â˜ ï¸ ×¦×‘×¢ ×××›×œ ××–×™×§ ×œ×™×œ×“×™×</div>`; score-=50;
                    }
                }

                if(chk('k-parve')&&(txt.includes('milk')||txt.includes('meat'))) tags+=`<div class="info-tag tag-neutral">âŒ ×œ× ×¤×¨×•×•×”</div>`;
                if(chk('l-vegan')&&(txt.includes('milk')||txt.includes('egg')||txt.includes('honey'))) tags+=`<div class="info-tag tag-neutral">âŒ ×œ× ×˜×‘×¢×•× ×™</div>`;
                if(chk('c-clean')&&(add.length>5)) tags+=`<div class="info-tag tag-neutral">ğŸ§ª ×ª×•×¡×¤×™× ××œ××›×•×ª×™×™×</div>`;
                if(chk('b-israel')&&code.startsWith('729')) tags+=`<div class="info-tag tag-good">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</div>`;

                if(user.goal==='cut' && n['energy-kcal_100g']>300) tags+=`<div class="info-tag tag-neutral">âš ï¸ ×¦×¤×•×£ ×§×œ×•×¨×™×ª</div>`;
                if(user.goal==='bulk' && n.proteins_100g>15) tags+=`<div class="info-tag tag-good">ğŸ’ª ×—×œ×‘×•×Ÿ ×œ××¡×”</div>`;

                if(score<0) score=0; if(score>100) score=100;

                // Grade Logic
                let grade = (p.nutriscore_grade || 'e').toUpperCase();
                if(!p.nutriscore_grade) {
                    if(n.sugars_100g>10 || n['saturated-fat_100g']>5) grade='D';
                    else if(n.proteins_100g>15) grade='A';
                    else grade='C';
                }

                // Check Quality Gate
                const grades = ['E','D','C','B','A'];
                const limit = grades.indexOf(user.minGrade || 'E');
                const curr = grades.indexOf(grade);
                if(curr < limit) {
                    document.getElementById('quality-warning').style.display='flex';
                    if(navigator.vibrate) navigator.vibrate([200,100,200]);
                }

                document.getElementById('grade-display').innerText = grade;
                document.getElementById('grade-display').className = `grade-badge grade-${grade}`;
                document.getElementById('tags-area').innerHTML = tags || `<div class="info-tag tag-good">âœ¨ ×œ×œ× ××–×”×¨×•×ª</div>`;
                document.getElementById('bio-res').innerText = `${n['energy-kcal_100g']||0} ×§×œ×•×¨×™×•×ª | ${n.proteins_100g||0}g ×—×œ×‘×•×Ÿ`;

                history.unshift({name:name,code:code,date:new Date().toLocaleDateString()});
                if(history.length>20) history.pop();
                localStorage.setItem('vibeHistory',JSON.stringify(history));
                renderHistory();

            } catch(e) {
                document.getElementById('p-name').value="×œ× × ××¦× (×”×§×œ×“ ×©×)";
                currentItem.code=code;
            }
        }

        // --- CART & IMPORT ---
        function importList(){
            const text = document.getElementById('import-area').value;
            if(!text) return;
            // Clean emojis and split
            const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '');
            const lines = cleanText.split(/\n|,/);
            
            lines.forEach(line => {
                let cl = line.trim();
                if(cl){
                    let cat = 'other';
                    for(const [k,v] of Object.entries(dict)){ if(cl.includes(k)||cl.includes(v.he)) cat=v.c; }
                    if(cl.includes('××§×•× ×•××™×§×”')||cl.includes('× ×™×™×¨')) cat='home';
                    cart.push({name:cl, category:cat});
                }
            });
            renderCart();
            document.getElementById('import-area').value = "";
            showToast("×¨×©×™××” ×™×•×‘××”");
        }

        function addToCart(){ cart.push(currentItem); renderCart(); closeSheet(); showToast("âœ… × ×•×¡×£ ×œ×¡×œ"); }
        function renderCart(){
            const b=document.getElementById('cart-body'); b.innerHTML="";
            const grouped={};
            cart.forEach(i=>{ if(!grouped[i.category]) grouped[i.category]=[]; grouped[i.category].push(i); });
            const order=['veg','fridge','meat','pantry','home','other'];
            
            let s=50; cart.forEach(i=>{ if(i.category==='veg') s+=5; if(i.category==='fridge') s+=2; });
            s=Math.min(100,Math.max(0,s));
            document.getElementById('basket-score-bar').style.width=s+"%";
            document.getElementById('score-text').innerText = s + "%";

            order.forEach(cat=>{
                if(grouped[cat]){
                    b.innerHTML+=`<div class="aisle-header">${aisles[cat]}</div>`;
                    grouped[cat].forEach(item=>{
                        const idx=cart.indexOf(item);
                        b.innerHTML+=`<div class="cart-item"><span>${item.name}</span><span onclick="del(${idx})" style="color:red;cursor:pointer;">âœ•</span></div>`;
                    });
                }
            });
            document.getElementById('d-cart').innerText=cart.length;
            localStorage.setItem('vibeCart60',JSON.stringify(cart));
        }
        function del(i){cart.splice(i,1); renderCart();}
        function shareCart(){window.open(`https://wa.me/?text=×¨×©×™××ª ×§× ×™×•×ª:%0A${cart.map(i=>"- "+i.name).join('%0A')}`,'_blank');}
        
        function clearHistory(){history=[]; localStorage.removeItem('vibeHistory'); renderHistory();}
        function renderHistory(){
            const l=document.getElementById('history-list'); l.innerHTML="";
            history.forEach(i=>{l.innerHTML+=`<div class="cart-item" onclick="analyze('${i.code}')"><span>${i.name}</span><small>${i.date}</small></div>`});
        }

        // --- CAMERA ---
        let html5QrCode;
        try { html5QrCode = new Html5Qrcode("reader"); } catch(e){}

        function startCamera(){
            if(!html5QrCode) { alert("×¨×›×™×‘ ×”××¦×œ××” ×œ× × ×˜×¢×Ÿ"); return; }
            document.getElementById('scanner-overlay').style.display='block';
            html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},(txt)=>{ stopCamera(); analyze(txt); }).catch(()=>{alert("××™×Ÿ ×’×™×©×” ×œ××¦×œ××”"); stopCamera();});
        }
        function stopCamera(){
            if(html5QrCode) html5QrCode.stop().then(()=>document.getElementById('scanner-overlay').style.display='none').catch(()=>document.getElementById('scanner-overlay').style.display='none');
        }
        function manualSearch(){const c=prompt("×‘×¨×§×•×“:"); if(c) analyze(c);}

        // --- DE-BRANDING SEARCH ---
        function findAlternatives(){
            let name = document.getElementById('p-name').value;
            // Clean Brands using Regex
            name = name.replace(brandRegex, '').trim();
            // Clean current brand if exists
            if(currentItem.brand) name = name.replace(new RegExp(currentItem.brand, 'gi'), '').trim();
            if(name.length < 2) name = document.getElementById('p-name').value; // Fallback
            window.open(`https://www.google.com/search?q=${encodeURIComponent(name+" ×§× ×™×™×” ×‘×–×•×œ site:.il")}`,'_blank');
        }
        function comparePrecise(){
            let q=currentItem.code;
            if(document.getElementById('p-name').value!==currentItem.name) q=document.getElementById('p-name').value+" ××—×™×¨ site:.il";
            window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`,'_blank');
        }
    </script>
</body>
</html>
