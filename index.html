<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Vibe OS X</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* --- MASTERPIECE DESIGN SYSTEM --- */
        :root { 
            --primary: #00e676; 
            --primary-dim: rgba(0, 230, 118, 0.15);
            --bg: #000000;
            --surface: #111111;
            --card: #1c1c1e;
            --text: #ffffff;
            --border: #333333;
            --danger: #ff453a;
            --warning: #ffd60a;
            
            /* GRADES COLORS */
            --g-a-plus: #00e676; --g-a: #32d74b;
            --g-b-plus: #a4e400; --g-b: #c0eb34;
            --g-c-plus: #ffd60a; --g-c: #ffce00;
            --g-d: #ff9f0a; --g-e: #ff453a;
            
            --radius: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding-bottom: 140px; min-height: 100vh; overflow-x: hidden; }

        /* HEADER */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        .logo { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; background: linear-gradient(90deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-icons { display: flex; gap: 12px; }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; position: relative; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); background: #333; }
        .badge { position: absolute; top: -2px; right: -2px; background: var(--primary); color: #000; font-size: 10px; font-weight: 900; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* DASHBOARD */
        .dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; padding: 20px; }
        .card { background: var(--card); border-radius: var(--radius); padding: 18px; border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: space-between; }
        .card.main { grid-column: span 2; background: linear-gradient(145deg, #1c1c1e, #0a0a0a); }
        .card-label { font-size: 11px; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; }
        .card-val { font-size: 32px; font-weight: 800; margin-top: 5px; letter-spacing: -1px; }
        .progress-track { width: 100%; height: 6px; background: #333; border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: var(--primary); transition: width 1s ease; box-shadow: 0 0 10px var(--primary-dim); }

        /* FILTERS ACCORDION */
        .filter-sec { padding: 0 20px 30px 20px; }
        .sec-title { font-size: 12px; color: var(--primary); font-weight: 900; margin: 30px 0 15px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .acc { background: var(--surface); border-radius: 14px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 10px; }
        .acc-head { padding: 18px; font-weight: 700; font-size: 15px; display: flex; justify-content: space-between; cursor: pointer; background: #181818; }
        .acc-body { display: none; padding: 15px; background: #000; flex-wrap: wrap; gap: 8px; border-top: 1px solid #333; }
        .acc-body.open { display: flex; }
        
        .c-red .acc-head { border-right: 4px solid var(--danger); }
        .c-blue .acc-head { border-right: 4px solid var(--primary); }
        .c-gold .acc-head { border-right: 4px solid var(--warning); }

        /* CHIPS */
        .chip { display: none; }
        .chip-lbl { padding: 10px 16px; background: #1a1a1a; border: 1px solid #333; border-radius: 50px; font-size: 13px; color: #888; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .chip:checked + .chip-lbl { background: #eee; color: #000; font-weight: 800; border-color: #fff; transform: scale(1.05); }
        .danger .chip:checked + .chip-lbl { background: rgba(255, 69, 58, 0.2); color: var(--danger); border-color: var(--danger); }
        .safe .chip:checked + .chip-lbl { background: var(--primary-dim); color: var(--primary); border-color: var(--primary); }

        /* SCANNER & UI */
        #scanner-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .close-cam { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.9); color: white; padding: 15px 40px; border-radius: 50px; border: 1px solid #555; font-weight: bold; cursor: pointer; }

        /* BOTTOM NAV */
        .dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: rgba(20,20,20,0.95); backdrop-filter: blur(25px); border-radius: 100px; border: 1px solid rgba(255,255,255,0.15); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 400; box-shadow: 0 10px 40px rgba(0,0,0,0.7); }
        .dock-btn { font-size: 24px; background: none; border: none; cursor: pointer; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .scan-fab { width: 80px; height: 80px; background: #fff; border-radius: 28px; margin-top: -40px; border: none; box-shadow: 0 5px 30px rgba(255,255,255,0.25); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .scan-fab:active { transform: scale(0.92); }

        /* RESULTS SHEET */
        #sheet-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 600; pointer-events: none; opacity: 0; transition: 0.3s; }
        #sheet-wrap.active { opacity: 1; pointer-events: auto; }
        .backdrop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .sheet { position: absolute; bottom: 0; width: 100%; background: #161616; border-radius: 35px 35px 0 0; padding: 30px; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-top: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        #sheet-wrap.active .sheet { transform: translateY(0); }

        .prod-grid { display: flex; gap: 15px; margin-bottom: 25px; align-items: flex-start; }
        .thumb { width: 90px; height: 90px; background: white; border-radius: 20px; object-fit: contain; padding: 5px; }
        .prod-info { flex: 1; }
        .p-brand { font-size: 11px; color: #888; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .p-edit { background: transparent; border: none; border-bottom: 1px dashed #444; color: white; font-size: 22px; font-weight: 800; width: 100%; font-family: inherit; }
        
        .grade-badge { font-size: 48px; font-weight: 900; line-height: 1; }
        .g-A_PLUS { color: var(--g-a-plus); text-shadow: 0 0 20px var(--g-a-plus); }
        .g-A { color: var(--g-a); } .g-B_PLUS { color: var(--g-b-plus); } .g-B { color: var(--g-b); }
        .g-C_PLUS { color: var(--g-c-plus); } .g-C { color: var(--g-c); }
        .g-D { color: var(--g-d); } .g-E { color: var(--g-e); text-shadow: 0 0 20px var(--g-e); }

        /* ALERTS & TAGS */
        .alert-box { background: rgba(255, 69, 58, 0.1); border: 1px solid var(--danger); padding: 15px; border-radius: 14px; margin-bottom: 20px; display: none; }
        .alert-head { color: var(--danger); font-weight: 800; font-size: 13px; display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .alert-body { color: #ff8a80; font-size: 12px; margin: 0; padding-right: 20px; line-height: 1.4; }

        .tags-area { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .tag { padding: 8px 14px; border-radius: 10px; font-size: 12px; font-weight: 700; }
        .t-bad { background: rgba(255,69,58,0.15); color: var(--danger); border: 1px solid rgba(255,69,58,0.3); }
        .t-mid { background: rgba(255,214,10,0.15); color: var(--warning); border: 1px solid rgba(255,214,10,0.3); }
        .t-good { background: var(--primary-dim); color: var(--primary); border: 1px solid var(--primary-dim); }

        .analysis { background: #222; padding: 15px; border-radius: 16px; margin-bottom: 20px; font-size: 13px; color: #ccc; line-height: 1.5; border: 1px solid #333; }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .act-btn { padding: 18px; background: #222; border: 1px solid #333; border-radius: 16px; color: white; font-weight: 700; cursor: pointer; text-align: center; font-size: 14px; transition: 0.2s; }
        .act-btn:active { transform: scale(0.98); background: #333; }
        .act-btn.primary { background: var(--primary); color: black; border-color: var(--primary); grid-column: span 2; font-size: 16px; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 800; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; flex-direction: column; justify-content: flex-end; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-body { width: 100%; height: 95%; background: #161616; border-radius: 30px 30px 0 0; border-top: 1px solid #333; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal.active .modal-body { transform: translateY(0); }
        .m-head { padding: 25px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: 900; }
        .m-content { padding: 25px; overflow-y: auto; flex: 1; }

        /* SETTINGS UI */
        .grade-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px; }
        .g-btn { padding: 14px 0; background: #222; border: 1px solid #444; border-radius: 12px; color: #666; font-weight: 900; text-align: center; cursor: pointer; transition: 0.2s; }
        .g-btn.active { color: #000; border: none; transform: scale(1.05); }
        .g-btn[data-g="A+"].active { background: var(--g-a-plus); }
        .g-btn[data-g="A"].active { background: var(--g-a); }
        .g-btn[data-g="B+"].active { background: var(--g-b-plus); }
        .g-btn[data-g="B"].active { background: var(--g-b); }
        .g-btn[data-g="C+"].active { background: var(--g-c-plus); }
        .g-btn[data-g="C"].active { background: var(--g-c); }
        .g-btn[data-g="D"].active { background: var(--g-d); }
        .g-btn[data-g="E"].active { background: var(--g-e); }

        .inp { width: 100%; background: #252525; border: 1px solid #444; color: white; padding: 16px; border-radius: 14px; font-size: 16px; text-align: center; font-weight: 600; margin-bottom: 10px; }
        .row { display: flex; gap: 10px; margin-bottom: 20px; }
        .toggle { flex: 1; padding: 14px; background: #222; border: 1px solid #444; border-radius: 12px; color: #888; font-weight: 700; text-align: center; cursor: pointer; }
        .toggle.active { background: var(--primary); color: black; border-color: var(--primary); box-shadow: 0 0 15px var(--primary-dim); }

        /* CART & HISTORY */
        .aisle { margin-bottom: 20px; }
        .aisle-h { font-size: 12px; color: var(--primary); font-weight: 900; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .item { display: flex; justify-content: space-between; align-items: center; background: #1f1f1f; padding: 16px; border-radius: 14px; margin-bottom: 8px; border: 1px solid #333; }
        .item-g { font-weight: 900; font-size: 18px; width: 45px; text-align: center; }

        /* TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translate(-50%, -100px); background: #222; border: 1px solid #444; color: white; padding: 14px 28px; border-radius: 50px; font-weight: bold; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.6); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; }
        #toast.show { transform: translate(-50%, 0); }

        /* MANUAL INPUT MODAL */
        #manual-modal { z-index: 900; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="app-header">
        <div class="logo">Vibe OS X</div>
        <div class="header-icons">
            <div class="icon-btn" onclick="openModal('history')">ğŸ“œ</div>
            <div class="icon-btn" onclick="openModal('settings')">âš™ï¸</div>
            <div class="icon-btn" onclick="openModal('cart')">ğŸ›’ <div class="badge" id="badge">0</div></div>
        </div>
    </div>

    <div class="dashboard">
        <div class="card main">
            <div class="card-label"><span>××™×›×•×ª ×”×¡×œ</span> <span id="goal-txt" style="color:var(--primary);">...</span></div>
            <div class="progress-track"><div class="progress-bar" id="score-bar"></div></div>
            <div style="font-size:11px;color:#666;margin-top:10px;">××“×“ ××©×•×§×œ×œ ×‘×–××Ÿ ×××ª</div>
        </div>
        <div class="card">
            <div class="card-label">BMR</div>
            <div class="card-val" id="val-bmr">--</div>
        </div>
        <div class="card">
            <div class="card-label">×¤×¨×™×˜×™×</div>
            <div class="card-val" id="val-count">0</div>
        </div>
    </div>

    <div class="filter-sec">
        <div class="sec-title">×¤×¨×•×¤×™×œ ××™×©×™</div>
        
        <div class="acc c-red"><div class="acc-head" onclick="tog(this)">âš ï¸ ××œ×¨×’×™×•×ª (×—×•×‘×”) <span>â–¼</span></div><div class="acc-body danger">
            <input type="checkbox" id="a-milk" class="chip save"><label for="a-milk" class="chip-lbl">ğŸ¥› ×—×œ×‘</label>
            <input type="checkbox" id="a-gluten" class="chip save"><label for="a-gluten" class="chip-lbl">ğŸ ×’×œ×•×˜×Ÿ</label>
            <input type="checkbox" id="a-nuts" class="chip save"><label for="a-nuts" class="chip-lbl">ğŸŒ° ××’×•×–×™×</label>
            <input type="checkbox" id="a-peanuts" class="chip save"><label for="a-peanuts" class="chip-lbl">ğŸ¥œ ×‘×•×˜× ×™×</label>
            <input type="checkbox" id="a-sesame" class="chip save"><label for="a-sesame" class="chip-lbl">ğŸ¥¯ ×©×•××©×•×</label>
            <input type="checkbox" id="a-soy" class="chip save"><label for="a-soy" class="chip-lbl">ğŸ¥¢ ×¡×•×™×”</label>
            <input type="checkbox" id="a-eggs" class="chip save"><label for="a-eggs" class="chip-lbl">ğŸ¥š ×‘×™×¦×™×</label>
            <input type="checkbox" id="a-fish" class="chip save"><label for="a-fish" class="chip-lbl">ğŸŸ ×“×’×™×</label>
            <input type="checkbox" id="a-sulfites" class="chip save"><label for="a-sulfites" class="chip-lbl">ğŸ· ×¡×•×œ×¤×™×˜×™×</label>
            <input type="checkbox" id="a-mustard" class="chip save"><label for="a-mustard" class="chip-lbl">ğŸŒ­ ×—×¨×“×œ</label>
        </div></div>

        <div class="acc c-red"><div class="acc-head" onclick="tog(this)">ğŸ¥ ×¨×¤×•××™ <span>â–¼</span></div><div class="acc-body danger">
            <input type="checkbox" id="d-diabetic" class="chip save"><label for="d-diabetic" class="chip-lbl">ğŸ’‰ ×¡×•×›×¨×ª</label>
            <input type="checkbox" id="d-heart" class="chip save"><label for="d-heart" class="chip-lbl">ğŸ«€ ×œ×‘/× ×ª×¨×Ÿ</label>
            <input type="checkbox" id="d-cholesterol" class="chip save"><label for="d-cholesterol" class="chip-lbl">ğŸ” ×›×•×œ×¡×˜×¨×•×œ</label>
            <input type="checkbox" id="d-celiac" class="chip save"><label for="d-celiac" class="chip-lbl">ğŸŒ¾ ×¦×œ×™××§</label>
            <input type="checkbox" id="d-gout" class="chip save"><label for="d-gout" class="chip-lbl">ğŸ¦¶ ×’××•×˜</label>
            <input type="checkbox" id="d-kidney" class="chip save"><label for="d-kidney" class="chip-lbl">ğŸ©º ×›×œ×™×•×ª</label>
            <input type="checkbox" id="d-reflux" class="chip save"><label for="d-reflux" class="chip-lbl">ğŸ”¥ ×¦×¨×‘×ª</label>
            <input type="checkbox" id="d-ibs" class="chip save"><label for="d-ibs" class="chip-lbl">ğŸˆ ××¢×™ ×¨×’×™×–</label>
        </div></div>

        <div class="acc c-purple"><div class="acc-head" onclick="tog(this)">ğŸ‘¶ ×™×œ×“×™× ×•×¨×’×™×©×•×™×•×ª <span>â–¼</span></div><div class="acc-body danger">
            <input type="checkbox" id="x-kids" class="chip save"><label for="x-kids" class="chip-lbl">ğŸ§¸ ×¦×‘×¢ ×××›×œ ××–×™×§</label>
            <input type="checkbox" id="x-preg" class="chip save"><label for="x-preg" class="chip-lbl">ğŸ¤° ×”×¨×™×•×Ÿ</label>
            <input type="checkbox" id="x-baby" class="chip save"><label for="x-baby" class="chip-lbl">ğŸ¼ ×ª×™× ×•×§×•×ª</label>
            <input type="checkbox" id="x-elderly" class="chip save"><label for="x-elderly" class="chip-lbl">ğŸ‘´ ×’×™×œ ×©×œ×™×©×™</label>
        </div></div>

        <div class="acc c-blue"><div class="acc-head" onclick="tog(this)">ğŸ¥— ×“×™××˜×” <span>â–¼</span></div><div class="acc-body safe">
            <input type="checkbox" id="l-vegan" class="chip save"><label for="l-vegan" class="chip-lbl">ğŸŒ± ×˜×‘×¢×•× ×™</label>
            <input type="checkbox" id="l-keto" class="chip save"><label for="l-keto" class="chip-lbl">ğŸ¥‘ ×§×˜×•</label>
            <input type="checkbox" id="l-paleo" class="chip save"><label for="l-paleo" class="chip-lbl">ğŸ– ×¤×œ×™××•</label>
            <input type="checkbox" id="c-sugar" class="chip save"><label for="c-sugar" class="chip-lbl">ğŸ­ ×œ×œ× ×¡×•×›×¨</label>
            <input type="checkbox" id="c-clean" class="chip save"><label for="c-clean" class="chip-lbl">ğŸ§ª ×ª×•×•×™×ª × ×§×™×™×”</label>
            <input type="checkbox" id="b-israel" class="chip save" checked><label for="b-israel" class="chip-lbl">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</label>
        </div></div>

        <div class="acc c-gold"><div class="acc-head" onclick="tog(this)">âœ¡ï¸ ×›×©×¨×•×ª <span>â–¼</span></div><div class="acc-body safe">
            <input type="checkbox" id="k-kosher" class="chip save"><label for="k-kosher" class="chip-lbl">ğŸ“œ ×›×©×¨</label>
            <input type="checkbox" id="k-badatz" class="chip save"><label for="k-badatz" class="chip-lbl">âœ¨ ×‘×“"×¥</label>
            <input type="checkbox" id="k-parve" class="chip save"><label for="k-parve" class="chip-lbl">ğŸ ×¤×¨×•×•×”</label>
        </div></div>
    </div>

    <div id="scanner-ui">
        <div id="reader"></div>
        <div class="close-cam" onclick="stopCam()">×¡×’×•×¨ ××¦×œ××”</div>
    </div>

    <div class="dock">
        <button class="dock-btn" onclick="openModal('manual')">âŒ¨ï¸</button>
        <button class="scan-fab" onclick="startCam()">
            <svg width="32" height="32" viewBox="0 0 24 24"><path d="M4 6h2v12H4zm14 0h2v12h-2zm-4 0h2v12h-2zm-4 0h2v12h-2z" fill="black"/><path d="M2 4v16h20V4H2zm18 14H4V6h16v12z" fill="none" stroke="black" stroke-width="2"/></svg>
        </button>
        <button class="dock-btn" onclick="openModal('history')">ğŸ“œ</button>
    </div>

    <div id="sheet-wrap">
        <div class="backdrop" onclick="closeSheet()"></div>
        <div class="sheet">
            <div style="width:40px;height:4px;background:#333;margin:0 auto 20px auto;border-radius:10px;"></div>
            
            <div class="prod-grid">
                <img id="p-img" class="thumb">
                <div class="prod-info">
                    <div id="p-brand" class="p-brand"></div>
                    <input type="text" id="p-name" class="p-edit" oninput="liveUp(this.value)">
                    <div style="font-size:10px;color:#666;margin-top:2px;">âœ ×œ×—×¥ ×œ×¢×¨×™×›×”</div>
                </div>
                <div style="text-align:center;">
                    <div id="p-grade" class="grade-badge">--</div>
                    <div style="font-size:9px;color:#888;">Nutri-Score</div>
                </div>
            </div>

            <div id="fail-box" class="alert-box">
                <div class="alert-head">âš ï¸ ×”××•×¦×¨ × ×“×—×”:</div>
                <ul id="fail-list" class="alert-body"></ul>
            </div>

            <div id="tags-box" class="tags-area"></div>
            <div id="bio-txt" class="analysis"></div>

            <div class="actions">
                <div class="act-btn" onclick="comp()">ğŸ” ×”×©×•×•××”<br><span style="font-size:10px;opacity:0.6;">××—×™×¨ ×‘×™×©×¨××œ</span></div>
                <div class="act-btn" onclick="alt()">ğŸ’¡ ×—×œ×•×¤×”<br><span style="font-size:10px;opacity:0.6;">×œ×œ× ××•×ª×’</span></div>
                <div class="act-btn primary" onclick="add()">ğŸ›’ ×”×•×¡×£ ×œ×¡×œ</div>
            </div>
        </div>
    </div>

    <div id="modal-manual" class="modal">
        <div class="backdrop" onclick="closeModal('manual')"></div>
        <div class="modal-body" style="height:auto;padding-bottom:40px;">
            <div class="m-head">×—×™×¤×•×© ×™×“× ×™ <span onclick="closeModal('manual')">âœ•</span></div>
            <div style="padding:25px;">
                <input id="manual-code" class="inp" type="number" placeholder="×”×§×œ×“ ×‘×¨×§×•×“">
                <button class="act-btn primary" style="width:100%;margin-top:10px;" onclick="runManual()">×—×¤×© ××•×¦×¨</button>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="modal">
        <div class="backdrop" onclick="closeModal('settings')"></div>
        <div class="modal-body">
            <div class="m-head">×”×’×“×¨×•×ª <span onclick="closeModal('settings')">âœ•</span></div>
            <div class="m-content">
                <div class="set-group">
                    <span style="font-size:11px;color:#888;font-weight:900;display:block;margin-bottom:10px;">×‘×§×¨×ª ××™×›×•×ª (×¡××Ÿ ×¦×™×•× ×™× ××•×ª×¨×™×)</span>
                    <div class="grade-grid">
                        <div class="g-btn" data-g="A+" onclick="togG('A+')">A+</div>
                        <div class="g-btn" data-g="A" onclick="togG('A')">A</div>
                        <div class="g-btn" data-g="B+" onclick="togG('B+')">B+</div>
                        <div class="g-btn" data-g="B" onclick="togG('B')">B</div>
                        <div class="g-btn" data-g="C+" onclick="togG('C+')">C+</div>
                        <div class="g-btn" data-g="C" onclick="togG('C')">C</div>
                        <div class="g-btn" data-g="D" onclick="togG('D')">D</div>
                        <div class="g-btn" data-g="E" onclick="togG('E')">E</div>
                    </div>
                </div>

                <div class="row">
                    <div class="toggle" id="g-male" onclick="setGen('male')">×’×‘×¨</div>
                    <div class="toggle" id="g-female" onclick="setGen('female')">××™×©×”</div>
                </div>
                <div class="row">
                    <div class="toggle" id="t-cut" onclick="setGoal('cut')">×—×™×˜×•×‘</div>
                    <div class="toggle" id="t-main" onclick="setGoal('maintain')">×©××™×¨×”</div>
                    <div class="toggle" id="t-bulk" onclick="setGoal('bulk')">××¡×”</div>
                </div>

                <div class="row">
                    <input type="number" id="u-w" class="inp" placeholder="××©×§×œ">
                    <input type="number" id="u-h" class="inp" placeholder="×’×•×‘×”">
                    <input type="number" id="u-a" class="inp" placeholder="×’×™×œ">
                </div>
                <button class="act-btn primary" style="width:100%;" onclick="saveSet()">×©××•×¨ ×”×’×“×¨×•×ª</button>
            </div>
        </div>
    </div>

    <div id="modal-cart" class="modal">
        <div class="backdrop" onclick="closeModal('cart')"></div>
        <div class="modal-body">
            <div class="m-head">×¡×œ ×§× ×™×•×ª <span onclick="closeModal('cart')">âœ•</span></div>
            <div class="m-content">
                <textarea id="imp-box" class="inp" style="height:70px;text-align:right;" placeholder="×”×“×‘×§ ×¨×©×™××” ××”×¤×ª×§×™×..."></textarea>
                <button class="act-btn" style="width:100%;margin-bottom:20px;" onclick="doImp()">ğŸ“¥ ×¡× ×›×¨×•×Ÿ ×¨×©×™××”</button>
                <div id="cart-list"></div>
            </div>
            <div style="padding:20px;border-top:1px solid #333;">
                <button class="act-btn primary" style="width:100%;" onclick="share()">×©×œ×— ×œ×•×•××˜×¡××¤ ğŸ“¤</button>
            </div>
        </div>
    </div>

    <div id="modal-history" class="modal">
        <div class="backdrop" onclick="closeModal('history')"></div>
        <div class="modal-body">
            <div class="m-head">×”×™×¡×˜×•×¨×™×” <span onclick="closeModal('history')">âœ•</span></div>
            <div class="m-content" id="hist-list"></div>
            <div style="padding:20px;"><button class="act-btn" style="width:100%;color:var(--danger);border-color:var(--danger);" onclick="clrHist()">× ×§×” ×”×›×œ</button></div>
        </div>
    </div>

    <script>
        /* --- VIBE OS X CORE --- */
        
        // STATE
        let s = {
            u: JSON.parse(localStorage.getItem('vx_u')) || { w:75, h:175, a:30, g:'male', t:'maintain', ok:['A+','A','B+','B','C+','C','D','E'] },
            c: JSON.parse(localStorage.getItem('vx_c')) || [],
            h: JSON.parse(localStorage.getItem('vx_h')) || [],
            curr: null
        };

        // DATA
        const BLK = ['××¡×','×ª× ×•×‘×”','×©×˜×¨××•×¡','×¢×œ×™×ª','×ª×œ××”','×§× ×•×¨','×¡×•×’×ª','×•×™×¡×•×¦×§×™','×˜×¨×”','×’×“','×¤×¨×™×’×ª','× ×‘×™×¢×•×ª','××™ ×¢×“×Ÿ','×©×•×•×¤×¡','×§×•×§×” ×§×•×œ×”','×¤×¤×¡×™','× ×¡×˜×œ×”','×™×•×¤×œ×”','×“× ×•× ×”','××™×œ×§×™','×§×¨×œ×•','×‘××‘×”','×‘×™×¡×œ×™','×ª×¤×•×¦×™×¤×¡','×¤×¨×™× ×’×œ×¡','××—×œ×”','×¦×‘×¨','×©××™×¨','××¢×“× ×•×ª','×˜×‘×¢×•×œ','×–×•×’×œ×•×‘×§','×™×—×™×¢×','×˜×™×¨×ª ×¦×‘×™','×¢×•×£ ×˜×•×‘','×¡× ×¤×¨×•×¡×˜','×•×™×œ×™ ×¤×•×“','×¨××™ ×œ×•×™','×©×•×¤×¨×¡×œ','××•×©×¨ ×¢×“','×•×™×§×˜×•×¨×™','×”×™×™× ×¥','×”×œ×× ×¡','×× ×”','×¡×•×“','×¤×¨×¡×™×œ','× ×™×§×•×œ','×¡× ×•','×§×•×œ×’×™×™×˜','××•×¨×‘×™×˜'];
        const REG = new RegExp(`(${BLK.join('|')})`, 'gi');
        const DIC = {
            'milk':{h:'×—×œ×‘',c:'fridge'},'cheese':{h:'×’×‘×™× ×”',c:'fridge'},'yogurt':{h:'×™×•×’×•×¨×˜',c:'fridge'},'butter':{h:'×—×××”',c:'fridge'},
            'bread':{h:'×œ×—×',c:'pantry'},'pasta':{h:'×¤×¡×˜×”',c:'pantry'},'rice':{h:'××•×¨×–',c:'pantry'},'flour':{h:'×§××—',c:'pantry'},'sugar':{h:'×¡×•×›×¨',c:'pantry'},
            'tomato':{h:'×¢×’×‘× ×™×”',c:'veg'},'cucumber':{h:'××œ×¤×¤×•×Ÿ',c:'veg'},'apple':{h:'×ª×¤×•×—',c:'veg'},'chicken':{h:'×¢×•×£',c:'meat'},'beef':{h:'×‘×§×¨',c:'meat'},
            'shampoo':{h:'×©××¤×•',c:'home'},'soap':{h:'×¡×‘×•×Ÿ',c:'home'},'bleach':{h:'××§×•× ×•××™×§×”',c:'home'}
        };
        const AIS = {'veg':'ğŸ¥¦ ×™×¨×§×•×ª','fridge':'â„ï¸ ××§×¨×¨','meat':'ğŸ¥© ×‘×©×¨','pantry':'ğŸ ××–×•×•×”','home':'ğŸ§´ ×‘×™×ª','other':'ğŸ›’ ×›×œ×œ×™'};

        // INIT
        window.onload=()=>{ renDash(); renSet(); resChk(); };

        // LOGIC
        async function run(code){
            document.getElementById('sheet-wrap').classList.add('active');
            uiReset();
            
            try {
                // Fallback for demo if offline or invalid code
                if(code.length < 3) throw "Invalid";
                
                const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
                const d = await res.json();
                if(d.status!==1) throw "Not found";
                
                const p = d.product;
                let name = p.product_name_he || p.product_name || "××•×¦×¨ ×œ× ××–×•×”×”";
                let cat = 'other';
                
                // Smart Cat
                for(const [k,v] of Object.entries(DIC)){ if(name.toLowerCase().includes(k)||name.includes(v.h)){ cat=v.c; if(!p.product_name_he) name=v.h; break; } }

                s.curr = { n:name, c:code, b:p.brands||"", cat:cat };
                uiUpd(p);

                // ENGINE
                const n = p.nutriments||{};
                const tx = (JSON.stringify(p.ingredients_text)+JSON.stringify(p.labels)).toLowerCase();
                let score = 100;
                let fails = [];
                let tags = "";

                // CHECKER
                const c = (id,k,m,pen) => {
                    const el = document.getElementById(id);
                    if(el && el.checked){
                        for(let w of k) if(tx.includes(w)){ tags+=tag(m,'bad'); score-=pen; fails.push(m); return; }
                    }
                };

                // MAP ALL BUTTONS
                c('a-milk',['milk','lait','×—×œ×‘'], '×—×œ×‘', 100);
                c('a-gluten',['gluten','wheat','×—×™×˜×”'], '×’×œ×•×˜×Ÿ', 100);
                c('a-nuts',['nut','almond','××’×•×–'], '××’×•×–×™×', 100);
                c('a-peanuts',['peanut','×‘×•×˜× ×™×'], '×‘×•×˜× ×™×', 100);
                c('a-sesame',['sesame','×©×•××©×•×'], '×©×•××©×•×', 100);
                c('a-soy',['soy','×¡×•×™×”'], '×¡×•×™×”', 100);
                c('a-eggs',['egg','oeuf','×‘×™×¦×™×'], '×‘×™×¦×™×', 100);
                c('a-fish',['fish','×“×’'], '×“×’×™×', 100);
                c('a-sulfites',['sulfite','e220'], '×¡×•×œ×¤×™×˜×™×', 100);
                c('a-mustard',['mustard','×—×¨×“×œ'], '×—×¨×“×œ', 100);

                if(document.getElementById('x-kids').checked && (tx.includes('e102')||tx.includes('e129'))) { tags+=tag('×¦×‘×¢ ×××›×œ','bad'); score-=50; fails.push('×¦×‘×¢ ×××›×œ ××–×™×§'); }
                if(document.getElementById('d-diabetic').checked && n.sugars_100g>5) { tags+=tag('×¡×•×›×¨ ×’×‘×•×”','mid'); score-=30; fails.push('×¢×¨×›×™ ×¡×•×›×¨'); }
                
                if(score<0) score=0; if(score>100) score=100;

                // GRADE
                let g='E';
                if(score>=95) g='A+'; else if(score>=85) g='A'; else if(score>=80) g='B+'; else if(score>=70) g='B';
                else if(score>=65) g='C+'; else if(score>=55) g='C'; else if(score>=40) g='D';

                // FAIL ANALYSIS
                if(!s.u.ok.includes(g)) {
                    document.getElementById('fail-box').style.display='block';
                    if(navigator.vibrate) navigator.vibrate(200);
                    if(fails.length===0) fails.push("×¦×™×•×Ÿ ××™×›×•×ª × ××•×š (" + g + ")");
                    document.getElementById('fail-list').innerHTML = fails.map(f=>`<li>${f}</li>`).join('');
                }

                document.getElementById('tags-box').innerHTML = tags || tag('×œ×œ× ××–×”×¨×•×ª','good');
                document.getElementById('bio-txt').innerText = `${n['energy-kcal_100g']||0} ×§×œ×•×¨×™×•×ª | ${n.proteins_100g||0}g ×—×œ×‘×•×Ÿ`;
                
                const ge = document.getElementById('p-grade');
                ge.innerText=g; ge.className=`grade-badge g-${g.replace('+','_PLUS')}`;

                s.h.unshift({n:name, g:g, c:code});
                localStorage.setItem('vx_h',JSON.stringify(s.h));

            } catch(e) { 
                document.getElementById('p-name').value="×œ× × ××¦× (×”×§×œ×“ ×©×)"; 
                s.curr={n:"", c:code, b:""};
            }
        }

        // --- HELPERS ---
        function tag(t,c) { return `<div class="tag t-${c}">${t}</div>`; }
        function uiReset() {
            document.getElementById('p-name').value="...";
            document.getElementById('fail-box').style.display='none';
            document.getElementById('tags-box').innerHTML="";
        }
        function uiUpd(p) {
            document.getElementById('p-name').value = s.curr.n;
            document.getElementById('p-brand').innerText = s.curr.b;
            document.getElementById('p-img').src = p.image_front_small_url || "";
        }

        // --- CAMERA ---
        let cam;
        function startCam(){
            document.getElementById('scanner-ui').style.display='flex';
            cam = new Html5Qrcode("reader");
            cam.start({facingMode:"environment"},{fps:10,qrbox:250},(txt)=>{ stopCam(); run(txt); }).catch(()=>{ alert("Camera Error"); stopCam(); });
        }
        function stopCam(){ if(cam) cam.stop().then(()=>document.getElementById('scanner-ui').style.display='none'); }
        function runManual(){ const v=document.getElementById('manual-code').value; if(v) { closeModal('manual'); run(v); } }

        // --- SETTINGS ---
        function togG(g){ const i=s.u.ok.indexOf(g); if(i>-1) s.u.ok.splice(i,1); else s.u.ok.push(g); renSet(); }
        function setGen(v){ s.u.g=v; renSet(); }
        function setGoal(v){ s.u.t=v; renSet(); }
        function saveSet(){
            s.u.w=Number(document.getElementById('u-w').value);
            s.u.h=Number(document.getElementById('u-h').value);
            s.u.a=Number(document.getElementById('u-a').value);
            // BMR Calc
            let m = s.u.g==='male'?5:-161;
            let bmr = (10*s.u.w)+(6.25*s.u.h)-(5*s.u.a)+m;
            s.u.bmr = Math.round(bmr*1.2);
            localStorage.setItem('vx_u',JSON.stringify(s.u));
            renDash(); closeModal('settings'); toast("×”×’×“×¨×•×ª × ×©××¨×•");
        }
        function renSet(){
            document.querySelectorAll('.g-btn').forEach(b=>{ if(s.u.ok.includes(b.dataset.g)) b.classList.add('active'); else b.classList.remove('active'); });
            ['male','female'].forEach(k=>document.getElementById('g-'+k).className = s.u.g===k?'toggle active':'toggle');
            ['cut','main','bulk'].forEach(k=>document.getElementById('t-'+k).className = s.u.t===k?'toggle active':'toggle');
            document.getElementById('u-w').value=s.u.w; document.getElementById('u-h').value=s.u.h; document.getElementById('u-a').value=s.u.a;
        }

        // --- CART ---
        function add(){ s.c.push(s.curr); upCart(); closeSheet(); toast("× ×•×¡×£ ×œ×¡×œ"); }
        function doImp(){
            const t = document.getElementById('imp-box').value;
            if(t) {
                t.split(/\n|,/).forEach(l=>{
                    let cl=l.trim(); if(cl) {
                        let c='other'; for(const [k,v] of Object.entries(DIC)) if(cl.includes(k)||cl.includes(v.h)) c=v.c;
                        s.c.push({n:cl, cat:c});
                    }
                });
                upCart(); document.getElementById('imp-box').value=""; toast("×™×•×‘× ×‘×”×¦×œ×—×”");
            }
        }
        function upCart(){
            localStorage.setItem('vx_c',JSON.stringify(s.c));
            renDash();
            // Render List
            const d = document.getElementById('cart-list'); d.innerHTML="";
            const gr = {}; s.c.forEach(i=>{ if(!gr[i.cat]) gr[i.cat]=[]; gr[i.cat].push(i); });
            ['veg','fridge','meat','pantry','home','other'].forEach(k=>{
                if(gr[k]){
                    d.innerHTML+=`<div class="aisle"><div class="aisle-h">${AIS[k]}</div>${gr[k].map(i=>`<div class="item"><span>${i.n}</span><span style="color:red" onclick="del('${i.n}')">âœ•</span></div>`).join('')}</div>`;
                }
            });
        }
        function del(n){ const i=s.c.findIndex(x=>x.n===n); if(i>-1) s.c.splice(i,1); upCart(); }
        function share(){ window.open(`https://wa.me/?text=${s.c.map(i=>"- "+i.n).join('%0A')}`,'_blank'); }

        // --- DASHBOARD ---
        function renDash(){
            const map={cut:'×—×™×˜×•×‘',maintain:'×©××™×¨×”',bulk:'××¡×”'};
            document.getElementById('goal-txt').innerText = map[s.u.t];
            document.getElementById('val-bmr').innerText = s.u.bmr || "--";
            document.getElementById('val-count').innerText = s.c.length;
            document.getElementById('badge').innerText = s.c.length;
            // Fake score logic for demo
            let sc = 50 + (s.c.filter(x=>x.cat==='veg').length*5);
            if(sc>100) sc=100;
            document.getElementById('score-bar').style.width = sc+"%";
        }

        // --- SYSTEM ---
        function tog(el){ el.nextElementSibling.classList.toggle('open'); }
        function openModal(id){ document.getElementById('modal-'+id).classList.add('active'); if(id==='cart') upCart(); if(id==='history') renHist(); }
        function closeModal(id){ document.getElementById('modal-'+id).classList.remove('active'); }
        function closeSheet(){ document.getElementById('sheet-wrap').classList.remove('active'); }
        function toast(m){ const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
        function manualSearch(){ openModal('manual'); }
        function liveUp(v){ s.curr.n=v; }
        
        function resChk(){ document.querySelectorAll('.save').forEach(e=>{ if(localStorage.getItem(e.id)==='true') e.checked=true; e.addEventListener('change',()=>localStorage.setItem(e.id,e.checked)); }); }
        
        function renHist(){
            const d=document.getElementById('hist-list'); d.innerHTML="";
            s.h.forEach(x=>{ d.innerHTML+=`<div class="hist-item" onclick="closeModal('history');run('${x.c}')"><span>${x.n}</span><span class="grade-badge g-${x.g.replace('+','_PLUS')}" style="font-size:18px;">${x.g}</span></div>`; });
        }
        function clrHist(){ s.h=[]; localStorage.removeItem('vx_h'); renHist(); }

        function comp(){ let q=s.curr.c; if(document.getElementById('p-name').value!==s.curr.n) q=document.getElementById('p-name').value+" ××—×™×¨ site:.il"; window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`,'_blank'); }
        function alt(){ 
            let n=document.getElementById('p-name').value.replace(REG,'').trim();
            if(s.curr.b) n=n.replace(new RegExp(s.curr.b,'gi'),'').trim();
            window.open(`https://www.google.com/search?q=${encodeURIComponent(n+" ×§× ×™×™×” ×‘×–×•×œ site:.il")}`,'_blank'); 
        }

    </script>
</body>
</html>
