<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Vibe OS 46.0 - Platinum</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- SYSTEM CORE --- */
        :root { 
            --primary: #00e676; --warn: #ffca28; --danger: #ff5252; --bg: #050505; 
            --surface: #141414; --surface-soft: #1f1f1f; --text: #ffffff; --radius: 18px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding-bottom: 140px; user-select: none; }
        
        /* HEADER */
        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(5,5,5,0.95); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; backdrop-filter: blur(12px); }
        .brand { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; background: linear-gradient(90deg, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-icons { display: flex; gap: 12px; }
        .icon-btn { font-size: 20px; width: 40px; height: 40px; background: var(--surface-soft); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); }
        .badge { position: absolute; top: 5px; right: 5px; background: var(--primary); color: black; font-size: 9px; font-weight: 900; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; }

        /* DASHBOARD */
        .bento-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; padding: 15px; }
        .bento-card { background: var(--surface); padding: 15px; border-radius: var(--radius); border: 1px solid #222; position: relative; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
        .bento-val { font-size: 24px; font-weight: 800; margin-top: 5px; }
        .bento-lbl { font-size: 10px; color: #888; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        
        .progress-container { width: 100%; height: 6px; background: #333; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; width: 50%; background: linear-gradient(90deg, var(--warn), var(--primary)); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* FILTERS */
        .filter-sec { padding: 0 20px 40px 20px; }
        .sec-head { font-size: 11px; color: #666; font-weight: 800; text-transform: uppercase; margin: 25px 0 10px 0; letter-spacing: 1px; }
        .acc { margin-bottom: 8px; background: var(--surface); border-radius: 14px; border: 1px solid #222; overflow: hidden; transition: 0.2s; }
        .acc-head { padding: 16px; font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; border-right: 4px solid transparent; cursor: pointer; background: var(--surface-soft); }
        .acc-body { display: none; padding: 15px; background: #0a0a0a; flex-wrap: wrap; gap: 8px; border-top: 1px solid #222; }
        .acc-body.open { display: flex; }
        
        .c-red .acc-head { border-color: var(--danger); }
        .c-blue .acc-head { border-color: var(--primary); }
        .c-gold .acc-head { border-color: var(--gold); }
        
        .chip { display: none; }
        .lbl { padding: 8px 14px; background: #1f1f1f; border: 1px solid #333; border-radius: 50px; font-size: 12px; color: #aaa; transition: 0.2s; cursor: pointer; display: flex; align-items: center; gap: 6px; flex-grow: 1; justify-content: center; }
        .chip:checked + .lbl { background: #eee; color: #000; font-weight: 800; border-color: #fff; transform: scale(1.05); }
        .danger .chip:checked + .lbl { background: rgba(255, 82, 82, 0.2); color: var(--danger); border-color: var(--danger); }
        .safe .chip:checked + .lbl { background: rgba(0, 230, 118, 0.2); color: var(--primary); border-color: var(--primary); }

        /* SCANNER OVERLAY */
        #scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .close-cam { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.9); color: white; padding: 12px 30px; border-radius: 50px; border: 1px solid #444; margin: 0 auto; font-weight: bold; backdrop-filter: blur(10px); z-index: 502; cursor: pointer; }

        /* BOTTOM BAR */
        .action-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(30,30,30,0.95); padding: 8px; border-radius: 100px; display: flex; justify-content: space-between; border: 1px solid #444; z-index: 300; backdrop-filter: blur(15px); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .bar-btn { width: 50px; height: 50px; border: none; background: transparent; font-size: 24px; cursor: pointer; color: #888; display: flex; align-items: center; justify-content: center; }
        .scan-btn { width: 65px; height: 65px; background: white; border-radius: 22px; margin-top: -20px; border: none; box-shadow: 0 5px 25px rgba(255,255,255,0.25); display: flex; align-items: center; justify-content: center; cursor: pointer; color: black; transition: 0.2s; }
        .scan-btn:active { transform: scale(0.95); }

        /* RESULTS SHEET */
        #sheet-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; pointer-events: none; opacity: 0; transition: 0.3s; }
        .active-sheet { opacity: 1 !important; pointer-events: auto !important; }
        #sheet-bg { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        #bottom-sheet { position: absolute; bottom: 0; width: 100%; background: #161616; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-top: 1px solid #333; max-height: 85vh; overflow-y: auto; }
        .active-sheet #bottom-sheet { transform: translateY(0); }

        .prod-header { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .prod-thumb { width: 80px; height: 80px; background: white; border-radius: 16px; object-fit: contain; padding: 5px; }
        .editable-name { background: transparent; border: none; border-bottom: 1px dashed #555; color: white; font-size: 18px; font-weight: 800; width: 100%; font-family: inherit; margin-bottom: 5px; padding: 5px 0; border-radius: 0; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .info-tag { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .tag-neutral { background: rgba(255, 202, 40, 0.15); color: var(--warn); border: 1px solid rgba(255, 202, 40, 0.3); } 
        .tag-good { background: rgba(0, 230, 118, 0.15); color: var(--primary); border: 1px solid rgba(0, 230, 118, 0.3); } 
        .tag-danger { background: rgba(255, 82, 82, 0.15); color: var(--danger); border: 1px solid rgba(255, 82, 82, 0.3); } 

        .grade-badge { font-size: 32px; font-weight: 900; }
        .grade-A { color: #00e676; } .grade-B { color: #cddc39; } .grade-C { color: #ffca28; } .grade-D { color: #ff9800; } .grade-E { color: #ff5252; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .sheet-btn { padding: 15px; border-radius: 14px; border: 1px solid #333; font-weight: 700; cursor: pointer; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 6px; background: #222; color: white; transition: 0.2s; }
        .sheet-btn.primary { background: rgba(0,230,118,0.15); border-color: var(--primary); color: var(--primary); grid-column: span 2; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 600; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: flex-end; }
        .modal.open { opacity: 1; pointer-events: auto; }
        .modal-content { width: 100%; background: #161616; border-radius: 30px 30px 0 0; max-height: 85vh; overflow-y: auto; border-top: 1px solid #333; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; }
        .modal.open .modal-content { transform: translateY(0); }
        .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; background: #161616; position: sticky; top: 0; z-index: 10; }
        .modal-body { padding: 20px; }

        .aisle-header { font-size: 12px; color: var(--primary); font-weight: 800; text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; letter-spacing: 1px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #2a2a2a; }
        .clean-inp { width: 100%; background: #1c1c1e; border: 1px solid #333; color: white; padding: 15px; border-radius: 12px; font-size: 16px; margin-bottom: 10px; text-align: center; }
        
        .goal-btn { flex:1; padding:12px; background:#222; border:1px solid #444; color:#888; border-radius:10px; font-weight:bold; cursor:pointer; }
        .goal-btn.active { background:var(--primary); color:black; border-color:var(--primary); }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #222; color: white; padding: 12px 24px; border-radius: 50px; border: 1px solid #444; z-index: 1000; transition: 0.3s; font-weight: bold; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="header">
        <div class="brand">Vibe OS 46.0</div>
        <div class="nav-icons">
            <div class="icon-btn" onclick="toggleModal('history-modal')">ğŸ“œ</div>
            <div class="icon-btn" onclick="toggleModal('settings-modal')">âš™ï¸</div>
            <div class="icon-btn" onclick="toggleModal('cart-modal')">ğŸ›’ <span class="badge" id="badge">0</span></div>
        </div>
    </div>

    <div class="bento-grid">
        <div class="bento-card wide">
            <div style="display:flex; justify-content:space-between;">
                <div class="bento-lbl" id="goal-display">××˜×¨×”: ×˜×¨× ×”×•×’×“×¨×”</div>
                <div class="bento-lbl" id="score-text" style="color:var(--primary);">0%</div>
            </div>
            <div class="progress-container"><div class="progress-fill" id="basket-score-bar" style="width: 0%;"></div></div>
            <div style="font-size:11px; color:#666; margin-top:5px;">××“×“ ××™×›×•×ª ×”×¡×œ ×”×©×‘×•×¢×™ (A-E)</div>
        </div>
        <div class="bento-card"><div class="bento-lbl">×¦×¨×™×›×” ×™×•××™×ª (BMR)</div><div class="bento-val" id="d-tdee">--</div></div>
        <div class="bento-card"><div class="bento-lbl">×¤×¨×™×˜×™×</div><div class="bento-val" id="d-cart">0</div></div>
    </div>

    <div class="filter-sec">
        <div class="sec-head">×”×¢×“×¤×•×ª ×ª×–×•× ×”</div>
        <div class="acc c-red"><div class="acc-head" onclick="tog(this)">âš ï¸ ××œ×¨×’×™×•×ª (×—×•×‘×”) <span>â–¾</span></div><div class="acc-body danger">
            <input type="checkbox" id="a-milk" class="chip save"><label for="a-milk" class="lbl">ğŸ¥› ×—×œ×‘</label>
            <input type="checkbox" id="a-gluten" class="chip save"><label for="a-gluten" class="lbl">ğŸ ×’×œ×•×˜×Ÿ</label>
            <input type="checkbox" id="a-nuts" class="chip save"><label for="a-nuts" class="lbl">ğŸŒ° ××’×•×–×™×</label>
            <input type="checkbox" id="a-peanuts" class="chip save"><label for="a-peanuts" class="lbl">ğŸ¥œ ×‘×•×˜× ×™×</label>
            <input type="checkbox" id="a-fish" class="chip save"><label for="a-fish" class="lbl">ğŸŸ ×“×’×™×</label>
        </div></div>

        <div class="acc c-blue"><div class="acc-head" onclick="tog(this)">ğŸ¥— ×¡×’× ×•×Ÿ ×ª×–×•× ×” <span>â–¾</span></div><div class="acc-body safe">
            <input type="checkbox" id="l-vegan" class="chip save"><label for="l-vegan" class="lbl">ğŸŒ± ×˜×‘×¢×•× ×™</label>
            <input type="checkbox" id="l-keto" class="chip save"><label for="l-keto" class="lbl">ğŸ¥‘ ×§×˜×•</label>
            <input type="checkbox" id="c-sugar" class="chip save"><label for="c-sugar" class="lbl">ğŸ­ ×œ×œ× ×¡×•×›×¨</label>
            <input type="checkbox" id="b-israel" class="chip save" checked><label for="b-israel" class="lbl">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</label>
        </div></div>
    </div>

    <div id="scanner-overlay">
        <div id="reader"></div>
        <button class="close-cam" onclick="stopCamera()">×¡×’×•×¨ ××¦×œ××”</button>
    </div>

    <div class="action-bar">
        <button class="bar-btn" onclick="manualSearch()">âŒ¨ï¸</button>
        <button class="scan-btn" onclick="startCamera()">
            <svg viewBox="0 0 24 24" width="30" height="30"><path d="M4 6h2v12H4zm14 0h2v12h-2zm-4 0h2v12h-2zm-4 0h2v12h-2z" fill="black"/><path d="M2 4v16h20V4H2zm18 14H4V6h16v12z" fill="none" stroke="black" stroke-width="2"/></svg>
        </button>
        <button class="bar-btn" onclick="toggleModal('history-modal')">ğŸ“œ</button>
    </div>

    <div id="sheet-wrapper">
        <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);" onclick="closeSheet()"></div>
        <div class="modal-content" id="bottom-sheet">
            <div style="width:40px;height:4px;background:#333;margin:0 auto 20px auto;border-radius:10px;"></div>
            <div style="padding:25px;">
                <div class="prod-header">
                    <img id="p-img" class="prod-thumb" src="" onerror="this.style.display='none'">
                    <div style="flex:1;">
                        <div id="p-brand" style="font-size:11px;color:#888;font-weight:700;"></div>
                        <input type="text" id="p-name" class="editable-name" value="..." oninput="updateName(this.value)">
                        <div style="font-size:10px;color:#666;">âœ ×©× ×”××•×¦×¨ (× ×™×ª×Ÿ ×œ×¢×¨×™×›×”)</div>
                    </div>
                    <div style="text-align:center;">
                        <div id="grade-display" class="grade-badge"></div>
                        <div style="font-size:10px;color:#888;">Nutri-Score</div>
                    </div>
                </div>

                <div id="quality-warning" style="background:rgba(255,82,82,0.1); color:#ff5252; padding:10px; border-radius:8px; font-size:12px; margin-bottom:15px; display:none; border:1px solid #ff5252;">âš ï¸ ×”××•×¦×¨ ×—×•×¨×’ ××˜×•×•×— ×”××™×›×•×ª ×©×‘×—×¨×ª (A-B)</div>

                <div id="tags-area" class="tags-container"></div>
                <div id="bio-res" style="background:#222; padding:15px; border-radius:12px; margin:15px 0; font-size:13px; line-height:1.5; color:#ccc;"></div>

                <div class="action-grid">
                    <button class="sheet-btn" onclick="comparePrecise()">ğŸ” ××—×™×¨ ×‘×™×©×¨××œ</button>
                    <button class="sheet-btn" onclick="findAlternatives()">ğŸ’¡ ×—×œ×•×¤×” ×œ×œ× ××•×ª×’</button>
                    <button class="sheet-btn primary" onclick="addToCart()">ğŸ›’ ×”×•×¡×£ ×œ×¡×œ ×©×‘×•×¢×™</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×”×’×“×¨×•×ª</h2><button onclick="closeModal('settings-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body">
                
                <div style="margin-bottom:20px;">
                    <label style="color:#888; font-size:11px; font-weight:bold;">××’×“×¨ (×œ×—×™×©×•×‘ BMR)</label>
                    <div style="display:flex; gap:10px;">
                        <button class="goal-btn" id="gen-male" onclick="setGender('male')">×’×‘×¨</button>
                        <button class="goal-btn" id="gen-female" onclick="setGender('female')">××™×©×”</button>
                    </div>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="color:#888; font-size:11px; font-weight:bold;">××˜×¨×”</label>
                    <div style="display:flex; gap:10px;">
                        <button class="goal-btn" id="goal-cut" onclick="setGoal('cut')">×—×™×˜×•×‘</button>
                        <button class="goal-btn" id="goal-main" onclick="setGoal('maintain')">×©××™×¨×”</button>
                        <button class="goal-btn" id="goal-bulk" onclick="setGoal('bulk')">××¡×”</button>
                    </div>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="color:#888; font-size:11px; font-weight:bold;">×‘×§×¨×ª ××™×›×•×ª (×”×ª×¨××” ×‘×¦×™×•×Ÿ × ××•×š)</label>
                    <select id="u-grade-limit" class="clean-inp">
                        <option value="E">×œ×œ× ×¡×™× ×•×Ÿ (×”×›×œ)</option>
                        <option value="C">×‘×™× ×•× ×™ ×•××¢×œ×” (A-C)</option>
                        <option value="B">××™×›×•×ª×™ ×‘×œ×‘×“ (A-B)</option>
                        <option value="A">××¦×•×™×Ÿ ×‘×œ×‘×“ (A)</option>
                    </select>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="color:#888; font-size:11px; font-weight:bold;">× ×ª×•× ×™× ×¤×™×–×™×™×</label>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="number" id="u-w" class="clean-inp" placeholder="××©×§×œ (×§×’)">
                        <input type="number" id="u-h" class="clean-inp" placeholder="×’×•×‘×” (×¡×)">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="u-age" class="clean-inp" placeholder="×’×™×œ">
                        <button onclick="manualSync()" class="clean-inp" style="background:#333;">ğŸ”— ×¡× ×›×¨×•×Ÿ ××©×§×œ ×—×›×</button>
                    </div>
                </div>

                <button onclick="saveProfile()" class="clean-inp" style="background:white; color:black; font-weight:bold;">×©××•×¨ ×”×’×“×¨×•×ª</button>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×¡×œ ×§× ×™×•×ª ×©×‘×•×¢×™</h2><button onclick="closeModal('cart-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body">
                <textarea id="import-area" class="clean-inp" style="height:60px; text-align:right;" placeholder="×”×“×‘×§ ×›××Ÿ ×¨×©×™××” ××”×¤×ª×§×™×..."></textarea>
                <button onclick="importList()" class="clean-inp" style="background:#333; margin-bottom:15px;">ğŸ“¥ ×¡× ×›×¨×•×Ÿ ×¨×©×™××” ××”×œ×•×—</button>
                <div id="cart-body"></div>
            </div>
            <div style="padding:20px; text-align:center; border-top:1px solid #333;"><button onclick="shareCart()" class="clean-inp" style="background:var(--primary); color:black; font-weight:bold;">×•×•××˜×¡××¤ ğŸ“¤</button></div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>×”×™×¡×˜×•×¨×™×”</h2><button onclick="closeModal('history-modal')" style="background:none;border:none;color:white;font-size:24px;">&times;</button></div>
            <div class="modal-body" id="history-list"></div>
            <div style="padding:20px;"><button onclick="clearHistory()" class="clean-inp" style="background:var(--danger);color:white;">× ×§×” ×”×›×œ</button></div>
        </div>
    </div>

    <script>
        // --- VIBE OS 46.0 LOGIC ---
        
        // 1. DATA SAFE LOAD
        let cart=[], history=[], user={gender:'male', goal:'maintain', w:75, h:175, age:30, tdee:0, minGrade:'E'};
        try {
            cart = JSON.parse(localStorage.getItem('vibeCart46')) || [];
            history = JSON.parse(localStorage.getItem('vibeHistory')) || [];
            user = JSON.parse(localStorage.getItem('vibeUser46')) || user;
        } catch(e){ localStorage.clear(); }

        let currentItem = { name: '', code: '', brand: '', category: 'other' };

        // 2. ISRAELI BRANDS CLEANER (REGEX)
        const ilBrands = ['××¡×','×ª× ×•×‘×”','×©×˜×¨××•×¡','×¢×œ×™×ª','×ª×œ××”','×§× ×•×¨','×¡×•×’×ª','×•×™×¡×•×¦×§×™','×˜×¨×”','×’×“','×¤×¨×™×’×ª','× ×‘×™×¢×•×ª','××™ ×¢×“×Ÿ','×©×•×•×¤×¡','×§×•×§×” ×§×•×œ×”','×¤×¤×¡×™','× ×¡×˜×œ×”','×™×•×¤×œ×”','×“× ×•× ×”','××™×œ×§×™','×§×¨×œ×•','×‘××‘×”','×‘×™×¡×œ×™','×ª×¤×•×¦×™×¤×¡','×¤×¨×™× ×’×œ×¡','××—×œ×”','×¦×‘×¨','×©××™×¨','××¢×“× ×•×ª','×˜×‘×¢×•×œ','×–×•×’×œ×•×‘×§','×™×—×™×¢×','×˜×™×¨×ª ×¦×‘×™','×¢×•×£ ×˜×•×‘','×¡× ×¤×¨×•×¡×˜','×•×™×œ×™ ×¤×•×“','×¨××™ ×œ×•×™','×©×•×¤×¨×¡×œ','××•×©×¨ ×¢×“','×•×™×§×˜×•×¨×™','×¡× ×•','× ×™×§×•×œ','×—×•×’×œ×”','×œ×™×œ×™','×¤×¨×¡×™×œ','××¨×™××œ','×¡×•×“','×¤×™× ×™×©','×§×•×œ×’×™×™×˜','××•×¨×‘×™×˜'];
        const brandRegex = new RegExp(ilBrands.join('|'), 'gi');

        // 3. DICTIONARY (MAPPED)
        const dict = {
            'milk':{he:'×—×œ×‘',c:'fridge'},'cheese':{he:'×’×‘×™× ×”',c:'fridge'},'yogurt':{he:'×™×•×’×•×¨×˜',c:'fridge'},'butter':{he:'×—×××”',c:'fridge'},
            'bread':{he:'×œ×—×',c:'pantry'},'pasta':{he:'×¤×¡×˜×”',c:'pantry'},'rice':{he:'××•×¨×–',c:'pantry'},'flour':{he:'×§××—',c:'pantry'},'sugar':{he:'×¡×•×›×¨',c:'pantry'},'salt':{he:'××œ×—',c:'pantry'},'oil':{he:'×©××Ÿ',c:'pantry'},
            'tomato':{he:'×¢×’×‘× ×™×”',c:'veg'},'cucumber':{he:'××œ×¤×¤×•×Ÿ',c:'veg'},'apple':{he:'×ª×¤×•×—',c:'veg'},'banana':{he:'×‘× × ×”',c:'veg'},
            'chicken':{he:'×¢×•×£',c:'meat'},'beef':{he:'×‘×§×¨',c:'meat'},'fish':{he:'×“×’',c:'meat'},'tuna':{he:'×˜×•× ×”',c:'pantry'},'egg':{he:'×‘×™×¦×™×',c:'fridge'},
            'shampoo':{he:'×©××¤×•',c:'home'},'soap':{he:'×¡×‘×•×Ÿ',c:'home'},'cleaner':{he:'×—×•××¨ × ×™×§×•×™',c:'home'},'paper':{he:'× ×™×™×¨',c:'home'},'bleach':{he:'××§×•× ×•××™×§×”',c:'home'}
        };
        const aisles = {'veg':'ğŸ¥¦ ×™×¨×§×•×ª','fridge':'â„ï¸ ××§×¨×¨','meat':'ğŸ¥© ×‘×©×¨','pantry':'ğŸ ××–×•×•×”','home':'ğŸ§´ ×‘×™×ª','other':'ğŸ›’ ×›×œ×œ×™'};

        window.onload=()=>{ renderCart(); renderHistory(); loadChecks(); applySettingsUI(); calculateTDEE(); };

        // UI ACTIONS
        function tog(h){h.nextElementSibling.classList.toggle('open')}
        function toggleModal(id){document.getElementById(id).classList.toggle('open')}
        function closeModal(id){document.getElementById(id).classList.remove('open')}
        function closeSheet(){document.getElementById('sheet-wrapper').classList.remove('active-sheet')}
        function updateName(val){ currentItem.name=val; }
        const chk=(id)=>document.getElementById(id).checked;
        function showToast(msg){ const t=document.getElementById('toast'); t.innerHTML=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
        function loadChecks(){ document.querySelectorAll('.save').forEach(el=>{ if(localStorage.getItem(el.id)==='true') el.checked=true; el.addEventListener('change',()=>localStorage.setItem(el.id,el.checked)); }); }

        // SETTINGS & BMR
        function setGender(g){ user.gender=g; applySettingsUI(); }
        function setGoal(g){ user.goal=g; applySettingsUI(); }
        
        function applySettingsUI(){
            document.querySelectorAll('.goal-btn').forEach(b=>b.classList.remove('active'));
            if(user.gender) document.getElementById('gen-'+user.gender).classList.add('active');
            if(user.goal) {
                if(user.goal==='cut') document.getElementById('goal-cut').classList.add('active');
                if(user.goal==='maintain') document.getElementById('goal-main').classList.add('active');
                if(user.goal==='bulk') document.getElementById('goal-bulk').classList.add('active');
            }
            document.getElementById('u-grade-limit').value = user.minGrade || 'E';
            document.getElementById('u-w').value = user.w;
            document.getElementById('u-h').value = user.h;
            document.getElementById('u-age').value = user.age;
            
            const goalMap = {cut:'×—×™×˜×•×‘', maintain:'×©××™×¨×”', bulk:'××¡×”'};
            document.getElementById('goal-display').innerText = "××˜×¨×”: " + (goalMap[user.goal] || "×œ× ×”×•×’×“×¨×”");
        }

        function calculateTDEE(){
            if(!user.w || !user.h || !user.age) return;
            // Mifflin-St Jeor Formula
            let s = (user.gender==='male' ? 5 : -161);
            let bmr = (10*user.w) + (6.25*user.h) - (5*user.age) + s;
            // Activity Factor 1.2 (Sedentary/Light) as baseline
            user.tdee = Math.round(bmr * 1.2);
            document.getElementById('d-tdee').innerText = user.tdee;
        }

        function manualSync(){
            let val = prompt("×”×–×Ÿ BMR ××”××©×§×œ ×”×—×›×:", user.tdee);
            if(val && !isNaN(val)) { 
                user.tdee = Math.round(Number(val)); 
                document.getElementById('d-tdee').innerText = user.tdee; 
                saveProfile();
                showToast("âœ… ×¡×•× ×›×¨×Ÿ ×™×“× ×™×ª"); 
            }
        }

        function saveProfile(){
            user.minGrade = document.getElementById('u-grade-limit').value;
            user.w = Number(document.getElementById('u-w').value);
            user.h = Number(document.getElementById('u-h').value);
            user.age = Number(document.getElementById('u-age').value);
            calculateTDEE();
            localStorage.setItem('vibeUser46', JSON.stringify(user));
            closeModal('settings-modal'); showToast("×”×¤×¨×•×¤×™×œ × ×©××¨");
            applySettingsUI();
        }

        // --- ANALYSIS ---
        async function analyze(code){
            document.getElementById('sheet-wrapper').classList.add('active-sheet');
            document.getElementById('p-name').value="×˜×•×¢×Ÿ...";
            document.getElementById('tags-area').innerHTML="";
            document.getElementById('grade-warning').style.display='none';
            document.getElementById('grade-display').innerText = "--";
            
            try {
                const res=await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
                const data=await res.json();
                if(data.status!==1) throw new Error();
                const p=data.product;
                
                let name=p.product_name_he||p.product_name||"";
                let cat='other';
                let lowName=name.toLowerCase();
                
                // Smart Category
                for(const [k,v] of Object.entries(dict)){
                    if(lowName.includes(k)){
                        if(!p.product_name_he) name=v.he+" "+(p.brands||"");
                        cat=v.c; break;
                    }
                }
                
                currentItem={name:name, code:code, brand:p.brands||"", category:cat};
                document.getElementById('p-name').value=name;
                document.getElementById('p-brand').innerText=p.brands||"";
                document.getElementById('p-img').src=p.image_front_small_url||"";

                const n=p.nutriments||{};
                const txt=(JSON.stringify(p.ingredients_text)+JSON.stringify(p.labels)).toLowerCase();
                let tags="";
                let score=100;

                // --- 65 FILTER LOGIC ---
                if(chk('a-milk') && txt.includes('milk')) {tags+=`<div class="info-tag tag-danger">â›” ×—×œ×‘</div>`; score=0;}
                if(chk('a-gluten') && txt.includes('gluten')) {tags+=`<div class="info-tag tag-danger">â›” ×’×œ×•×˜×Ÿ</div>`; score=0;}
                if(chk('a-nuts') && (txt.includes('nut')||txt.includes('almond'))) {tags+=`<div class="info-tag tag-danger">â›” ××’×•×–×™×</div>`; score=0;}
                if(chk('a-peanuts') && txt.includes('peanut')) {tags+=`<div class="info-tag tag-danger">â›” ×‘×•×˜× ×™×</div>`; score=0;}
                if(chk('a-fish') && txt.includes('fish')) {tags+=`<div class="info-tag tag-danger">â›” ×“×’×™×</div>`; score=0;}

                // Diet Logic
                if(chk('l-vegan') && (txt.includes('milk')||txt.includes('egg')||txt.includes('meat'))) {tags+=`<div class="info-tag tag-danger">âŒ ×œ× ×˜×‘×¢×•× ×™</div>`; score-=40;}
                if(chk('c-sugar') && n.sugars_100g > 1) {tags+=`<div class="info-tag tag-neutral">ğŸ­ ××›×™×œ ×¡×•×›×¨</div>`; score-=20;}
                
                // Nutri-Score Logic
                let grade = (p.nutriscore_grade || 'e').toUpperCase();
                if(!p.nutriscore_grade) {
                    // Local Calculation Fallback
                    if(n.sugars_100g > 10 || n['saturated-fat_100g'] > 5) grade = 'D';
                    else if(n.proteins_100g > 10) grade = 'A';
                    else grade = 'C';
                }

                // Goal Adjustments
                if(user.goal==='cut' && n['energy-kcal_100g']>300) tags+=`<div class="info-tag tag-neutral">âš ï¸ ×¦×¤×•×£ ×§×œ×•×¨×™×ª</div>`;
                if(user.goal==='bulk' && n.proteins_100g>15) tags+=`<div class="info-tag tag-good">ğŸ’ª ×—×œ×‘×•×Ÿ ×œ××¡×”</div>`;
                if(chk('b-israel') && code.startsWith('729')) tags+=`<div class="info-tag tag-good">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</div>`;

                // Quality Gate Check
                const grades = ['E','D','C','B','A']; // Index 0 is worst, 4 is best
                const userLimitIdx = grades.indexOf(user.minGrade || 'E');
                const prodGradeIdx = grades.indexOf(grade);
                
                if(prodGradeIdx < userLimitIdx) {
                    document.getElementById('quality-warning').style.display='block';
                    if(navigator.vibrate) navigator.vibrate([200,100,200]);
                }

                const gEl = document.getElementById('grade-display');
                gEl.innerText=grade; gEl.className=`grade-badge grade-${grade}`;

                document.getElementById('tags-area').innerHTML = tags || `<div class="info-tag tag-good">âœ¨ ×œ×œ× ××–×”×¨×•×ª</div>`;
                document.getElementById('bio-res').innerText = `${n['energy-kcal_100g']||0} ×§×œ×•×¨×™×•×ª | ${n.proteins_100g||0}g ×—×œ×‘×•×Ÿ`;

                history.unshift({name:name,code:code,date:new Date().toLocaleDateString()});
                localStorage.setItem('vibeHistory',JSON.stringify(history));
                renderHistory();

            } catch(e) {
                document.getElementById('p-name').value="×œ× × ××¦× (×”×§×œ×“ ×©×)";
            }
        }

        // --- CART & IMPORT ---
        function importList(){
            const text = document.getElementById('import-area').value;
            if(!text) return;
            // Split by newline or comma
            const lines = text.split(/\n|,/);
            lines.forEach(line => {
                let clean = line.trim();
                if(clean){
                    let cat = 'other';
                    for(const [k,v] of Object.entries(dict)){ if(clean.includes(k)||clean.includes(v.he)) cat=v.c; }
                    // Manual overrides
                    if(clean.includes('××§×•× ×•××™×§×”')||clean.includes('× ×™×™×¨')) cat='home';
                    cart.push({name:clean, category:cat});
                }
            });
            renderCart();
            document.getElementById('import-area').value = "";
            showToast("×¨×©×™××” ×™×•×‘××”");
        }

        function addToCart(){ cart.push(currentItem); renderCart(); closeSheet(); showToast("âœ… × ×•×¡×£ ×œ×¡×œ"); }
        
        function renderCart(){
            const b=document.getElementById('cart-body'); b.innerHTML="";
            const grouped={};
            cart.forEach(i=>{ if(!grouped[i.category]) grouped[i.category]=[]; grouped[i.category].push(i); });
            const order=['veg','fridge','meat','pantry','home','other'];
            
            // Score Logic
            let s=50; 
            cart.forEach(i=>{ 
                if(i.category==='veg') s+=5; 
                if(i.category==='fridge') s+=2;
                // Penalty for unclassified junk could go here
            });
            s=Math.min(100,Math.max(0,s));
            document.getElementById('basket-score-bar').style.width=s+"%";
            document.getElementById('score-text').innerText = s + "%";

            // Render Aisles
            order.forEach(cat=>{
                if(grouped[cat]){
                    b.innerHTML+=`<div class="aisle-header">${aisles[cat]}</div>`;
                    grouped[cat].forEach(item=>{
                        // Find true index to delete correct item
                        const idx=cart.indexOf(item);
                        b.innerHTML+=`<div class="cart-item"><span>${item.name}</span><span onclick="del(${idx})" style="color:red;cursor:pointer;">âœ•</span></div>`;
                    });
                }
            });
            
            document.getElementById('d-cart').innerText=cart.length;
            localStorage.setItem('vibeCart46',JSON.stringify(cart));
        }
        function del(i){cart.splice(i,1); renderCart();}
        function shareCart(){window.open(`https://wa.me/?text=×¨×©×™××ª ×§× ×™×•×ª:%0A${cart.map(i=>"- "+i.name).join('%0A')}`,'_blank');}
        
        function clearHistory(){history=[]; localStorage.removeItem('vibeHistory'); renderHistory();}
        function renderHistory(){
            const l=document.getElementById('history-list'); l.innerHTML="";
            history.forEach(i=>{l.innerHTML+=`<div class="cart-item" onclick="analyze('${i.code}')"><span>${i.name}</span><small>${i.date}</small></div>`});
        }

        // --- CAMERA ---
        let html5QrCode;
        try { html5QrCode = new Html5Qrcode("reader"); } catch(e){}

        function startCamera(){
            if(!html5QrCode) { alert("×¨×›×™×‘ ×”××¦×œ××” ×œ× × ×˜×¢×Ÿ. × ×¡×” ×œ×¨×¢× ×Ÿ."); return; }
            document.getElementById('scanner-overlay').style.display='block';
            html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},(txt)=>{ stopCamera(); analyze(txt); }).catch(()=>{alert("××™×Ÿ ×’×™×©×” ×œ××¦×œ××”"); stopCamera();});
        }
        function stopCamera(){
            if(html5QrCode) html5QrCode.stop().then(()=>document.getElementById('scanner-overlay').style.display='none').catch(()=>document.getElementById('scanner-overlay').style.display='none');
        }
        function manualSearch(){const c=prompt("×‘×¨×§×•×“:"); if(c) analyze(c);}

        // --- SMART ACTIONS ---
        function findAlternatives(){
            let name = document.getElementById('p-name').value;
            // Clean Brands using Regex
            name = name.replace(brandRegex, '').trim();
            // Clean current brand just in case
            if(currentItem.brand) name = name.replace(currentItem.brand, '').trim();
            
            if(name.length < 2) name = document.getElementById('p-name').value; // Fallback
            window.open(`https://www.google.com/search?q=${encodeURIComponent(name+" ×§× ×™×™×” ×‘×–×•×œ site:.il")}`,'_blank');
        }
        function comparePrecise(){
            let q=currentItem.code;
            if(document.getElementById('p-name').value!==currentItem.name) q=document.getElementById('p-name').value+" ××—×™×¨ site:.il";
            window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`,'_blank');
        }
    </script>
</body>
</html>
