<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Vibe OS 23.0</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- VARIABLES --- */
        :root { 
            --primary: #00e676; 
            --danger: #ff3d00;
            --gold: #ffd600;
            --purple: #d500f9;
            --bg: #000000;
            --surface: #111111;
            --surface-soft: #1c1c1e;
            --text: #ffffff;
            --text-muted: #8e8e93;
            --radius: 22px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding-bottom: 160px; user-select: none;
        }
        
        /* HEADER */
        .header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            position: sticky; top: 0; z-index: 100; border-bottom: 0.5px solid #222;
        }
        .brand { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; color: white; }
        .icon-btn { 
            width: 40px; height: 40px; border-radius: 50%; background: var(--surface-soft); 
            display: flex; align-items: center; justify-content: center; font-size: 18px; 
            border: 1px solid #333; cursor: pointer; transition: 0.2s;
        }

        /* BENTO DASHBOARD */
        .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 20px; }
        .bento-card { 
            background: var(--surface); padding: 20px; border-radius: var(--radius); 
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden; border: 1px solid #222;
        }
        .bento-card.wide { grid-column: span 2; background: linear-gradient(135deg, #1a1a1a, #0a0a0a); }
        .bento-val { font-size: 32px; font-weight: 800; margin-top: 5px; letter-spacing: -1px; }
        .bento-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }

        /* FILTERS */
        .filter-section { padding: 0 20px; }
        .acc { margin-bottom: 10px; background: var(--surface); border-radius: 16px; overflow: hidden; border: 1px solid #222; }
        .acc-head { 
            padding: 16px; font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; align-items: center;
            border-right: 3px solid transparent; transition: background 0.2s;
        }
        .acc-head:active { background: #222; }
        .acc-body { display: none; padding: 15px; background: #080808; flex-wrap: wrap; gap: 8px; border-top: 1px solid #222; }
        .acc-body.open { display: flex; }

        /* Colors */
        .c-red .acc-head { border-right-color: var(--danger); }
        .c-blue .acc-head { border-right-color: var(--primary); }
        .c-purple .acc-head { border-right-color: var(--purple); }
        .c-gold .acc-head { border-right-color: var(--gold); }
        .c-green .acc-head { border-right-color: var(--primary); }

        /* Chips */
        .chip { display: none; }
        .lbl {
            padding: 8px 16px; background: #1a1a1a; border: 1px solid #333; border-radius: 100px; 
            font-size: 12px; color: #888; transition: 0.2s; font-weight: 500;
        }
        .chip:checked + .lbl { background: #eee; color: #000; border-color: #fff; font-weight: 700; transform: scale(1.05); }
        .danger .chip:checked + .lbl { background: var(--danger); color: white; border-color: var(--danger); }
        .safe .chip:checked + .lbl { background: var(--primary); color: black; border-color: var(--primary); }

        /* SCANNER OVERLAY */
        #scanner-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 500; display: none;
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .scan-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 40px 20px;
        }
        .scan-frame {
            width: 260px; height: 260px; border: 2px solid rgba(255,255,255,0.3); border-radius: 20px;
            margin: auto; position: relative; box-shadow: 0 0 0 1000px rgba(0,0,0,0.8);
        }
        .scan-frame::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--primary); box-shadow: 0 0 10px var(--primary);
            animation: scanMove 2s infinite ease-in-out;
        }
        @keyframes scanMove { 0% {top:0; opacity:0;} 50% {opacity:1;} 100% {top:100%; opacity:0;} }
        .close-cam {
            pointer-events: auto; background: rgba(50,50,50,0.8); border: none; color: white;
            padding: 10px 20px; border-radius: 100px; font-weight: bold; margin: 0 auto; backdrop-filter: blur(10px);
        }

        /* SETTINGS LAYER */
        #settings-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 400; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); overflow-y: auto;
            padding: 20px 20px 100px 20px;
        }
        .settings-active #settings-layer { transform: translateY(0); }
        
        .set-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; margin-top: 10px; }
        .set-title { font-size: 24px; font-weight: 800; }
        .set-close { font-size: 14px; color: var(--text-muted); padding: 10px; cursor: pointer; }
        .set-group { margin-bottom: 25px; }
        .set-lbl { font-size: 11px; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .set-row { display: flex; gap: 10px; }
        .clean-inp { width: 100%; background: var(--surface-soft); border: 1px solid #333; color: white; padding: 16px; border-radius: 12px; font-size: 16px; text-align: center; }

        /* ACTION BAR */
        .action-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(20,20,20,0.9); backdrop-filter: blur(15px);
            padding: 8px; border-radius: 100px; display: flex; justify-content: space-between; 
            border: 1px solid #333; z-index: 300; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .bar-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: transparent; color: #888; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .scan-trigger {
            width: 65px; height: 65px; background: var(--text); color: black; border-radius: 24px;
            display: flex; align-items: center; justify-content: center; margin-top: -15px;
            box-shadow: 0 5px 20px rgba(255,255,255,0.2); cursor: pointer; border: none; transition: 0.2s;
        }
        .scan-trigger:active { transform: scale(0.95); }
        .svg-icon { width: 24px; height: 24px; fill: currentColor; }
        .svg-scan { width: 32px; height: 32px; fill: currentColor; }

        /* RESULTS SHEET */
        #sheet-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            pointer-events: none; opacity: 0; transition: 0.3s;
        }
        #sheet-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); }
        #bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%; background: #161616; 
            border-radius: 32px 32px 0 0; padding: 30px 25px 50px 25px; transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); border-top: 1px solid #333;
            max-height: 90vh; overflow-y: auto; pointer-events: auto;
        }
        .active-sheet { opacity: 1 !important; pointer-events: auto !important; }
        .active-sheet #bottom-sheet { transform: translateY(0); }

        .prod-header { display: flex; gap: 15px; margin-bottom: 25px; }
        .prod-thumb { width: 80px; height: 80px; background: #fff; border-radius: 20px; object-fit: contain; padding: 5px; }
        .score-circle {
            width: 60px; height: 60px; border-radius: 50%; border: 4px solid #333; 
            display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 800;
        }
        .analysis-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; font-size: 14px; line-height: 1.5; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px; }
        .sheet-btn { padding: 15px; border-radius: 14px; border: none; font-weight: 700; font-size: 13px; cursor: pointer; }

    </style>
</head>
<body id="app-body">

    <div class="header">
        <div class="brand">Vibe OS <span class="ver">23.0</span></div>
        <div class="icon-btn" onclick="toggleSettings()">
            <svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
        </div>
    </div>

    <div class="bento-grid">
        <div class="bento-card wide">
            <div class="bento-label">×ª×§×¦×™×‘ ×§×œ×•×¨×™ (TDEE)</div>
            <div class="bento-val" id="d-cals">...</div>
        </div>
        <div class="bento-card">
            <div class="bento-label">××˜×¨×”</div>
            <div class="bento-val" id="d-goal">...</div>
        </div>
        <div class="bento-card">
            <div class="bento-label">×¤×¨×™×˜×™× ×‘×¡×œ</div>
            <div class="bento-val" id="d-cart">0</div>
        </div>
    </div>

    <div class="filter-section">
        <div style="font-size:11px; color:#555; margin:15px 0 10px 0; font-weight:800; text-transform:uppercase;">×”×’×“×¨×•×ª ×¡×™× ×•×Ÿ</div>
        
        <div class="acc c-red">
            <div class="acc-head" onclick="tog('f1')">âš ï¸ ××œ×¨×’×™×•×ª (×¦×™×•×Ÿ 0) <span>â–¾</span></div>
            <div id="f1" class="acc-body danger">
                <input type="checkbox" id="a-milk" class="chip save"><label for="a-milk" class="lbl">ğŸ¥› ×—×œ×‘</label>
                <input type="checkbox" id="a-gluten" class="chip save"><label for="a-gluten" class="lbl">ğŸ ×’×œ×•×˜×Ÿ</label>
                <input type="checkbox" id="a-nuts" class="chip save"><label for="a-nuts" class="lbl">ğŸŒ° ××’×•×–×™×</label>
                <input type="checkbox" id="a-peanuts" class="chip save"><label for="a-peanuts" class="lbl">ğŸ¥œ ×‘×•×˜× ×™×</label>
                <input type="checkbox" id="a-soy" class="chip save"><label for="a-soy" class="lbl">ğŸ¥¢ ×¡×•×™×”</label>
                <input type="checkbox" id="a-sesame" class="chip save"><label for="a-sesame" class="lbl">ğŸ¥¯ ×©×•××©×•×</label>
                <input type="checkbox" id="a-eggs" class="chip save"><label for="a-eggs" class="lbl">ğŸ¥š ×‘×™×¦×™×</label>
                <input type="checkbox" id="a-fish" class="chip save"><label for="a-fish" class="lbl">ğŸŸ ×“×’×™×</label>
                <input type="checkbox" id="a-sulfites" class="chip save"><label for="a-sulfites" class="lbl">ğŸ· ×¡×•×œ×¤×™×˜×™×</label>
            </div>
        </div>

        <div class="acc c-red">
            <div class="acc-head" onclick="tog('f2')">ğŸ¥ ×¨×¤×•××™ ×•××—×œ×•×ª <span>â–¾</span></div>
            <div id="f2" class="acc-body danger">
                <input type="checkbox" id="d-diabetic" class="chip save"><label for="d-diabetic" class="lbl">ğŸ’‰ ×¡×•×›×¨×ª</label>
                <input type="checkbox" id="d-heart" class="chip save"><label for="d-heart" class="lbl">ğŸ«€ ×œ×‘</label>
                <input type="checkbox" id="d-celiac" class="chip save"><label for="d-celiac" class="lbl">ğŸŒ¾ ×¦×œ×™××§</label>
                <input type="checkbox" id="d-gout" class="chip save"><label for="d-gout" class="lbl">ğŸ¦¶ ×’××•×˜</label>
                <input type="checkbox" id="d-kidney" class="chip save"><label for="d-kidney" class="lbl">ğŸ©º ×›×œ×™×•×ª</label>
                <input type="checkbox" id="d-reflux" class="chip save"><label for="d-reflux" class="lbl">ğŸ”¥ ×¦×¨×‘×ª</label>
            </div>
        </div>

        <div class="acc c-purple">
            <div class="acc-head" onclick="tog('f3')">ğŸ‘¶ ×¨×’×™×©×•×™×•×ª ××™×•×—×“×•×ª <span>â–¾</span></div>
            <div id="f3" class="acc-body danger">
                <input type="checkbox" id="x-preg" class="chip save"><label for="x-preg" class="lbl">ğŸ¤° ×”×¨×™×•×Ÿ</label>
                <input type="checkbox" id="x-baby" class="chip save"><label for="x-baby" class="lbl">ğŸ¼ ×ª×™× ×•×§×•×ª</label>
                <input type="checkbox" id="x-elderly" class="chip save"><label for="x-elderly" class="lbl">ğŸ‘´ ×’×™×œ ×©×œ×™×©×™</label>
            </div>
        </div>

        <div class="acc c-blue">
            <div class="acc-head" onclick="tog('f4')">âš¡ ×¡×¤×•×¨×˜ ×•×‘×™×¦×•×¢×™× <span>â–¾</span></div>
            <div id="f4" class="acc-body safe">
                <input type="checkbox" id="p-protein" class="chip save"><label for="p-protein" class="lbl">ğŸ’ª ×—×œ×‘×•×Ÿ ×’×‘×•×”</label>
                <input type="checkbox" id="p-bulk" class="chip save"><label for="p-bulk" class="lbl">ğŸ¦ ××¡×”</label>
                <input type="checkbox" id="p-cut" class="chip save"><label for="p-cut" class="lbl">âœ‚ï¸ ×—×™×˜×•×‘</label>
                <input type="checkbox" id="p-energy" class="chip save"><label for="p-energy" class="lbl">ğŸ”‹ ×× ×¨×’×™×”</label>
            </div>
        </div>

        <div class="acc c-gold">
            <div class="acc-head" onclick="tog('f5')">âœ¡ï¸ ×“×ª ×•×›×©×¨×•×ª <span>â–¾</span></div>
            <div id="f5" class="acc-body safe">
                <input type="checkbox" id="k-kosher" class="chip save"><label for="k-kosher" class="lbl">ğŸ“œ ×›×©×¨</label>
                <input type="checkbox" id="k-badatz" class="chip save"><label for="k-badatz" class="lbl">âœ¨ ×‘×“"×¥</label>
                <input type="checkbox" id="k-parve" class="chip save"><label for="k-parve" class="lbl">ğŸ ×¤×¨×•×•×”</label>
                <input type="checkbox" id="k-dairy" class="chip save"><label for="k-dairy" class="lbl">ğŸ¥› ×—×œ×‘×™</label>
                <input type="checkbox" id="k-meat" class="chip save"><label for="k-meat" class="lbl">ğŸ¥© ×‘×©×¨×™</label>
                <input type="checkbox" id="k-halal" class="chip save"><label for="k-halal" class="lbl">â˜ªï¸ ×—×œ××œ</label>
                <input type="checkbox" id="k-passover" class="chip save"><label for="k-passover" class="lbl">ğŸš« ×œ×¤×¡×—</label>
            </div>
        </div>

        <div class="acc c-green">
            <div class="acc-head" onclick="tog('f6')">ğŸ¥— ×¢×¨×›×™× ×•×¡×’× ×•×Ÿ ×—×™×™× <span>â–¾</span></div>
            <div id="f6" class="acc-body safe">
                <input type="checkbox" id="b-israel" class="chip save" checked><label for="b-israel" class="lbl">ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥</label>
                <input type="checkbox" id="l-vegan" class="chip save"><label for="l-vegan" class="lbl">ğŸŒ± ×˜×‘×¢×•× ×™</label>
                <input type="checkbox" id="l-keto" class="chip save"><label for="l-keto" class="lbl">ğŸ¥‘ ×§×˜×•</label>
                <input type="checkbox" id="l-paleo" class="chip save"><label for="l-paleo" class="lbl">ğŸ– ×¤×œ×™××•</label>
                <input type="checkbox" id="c-clean" class="chip save"><label for="c-clean" class="lbl">ğŸ§ª ×ª×•×•×™×ª × ×§×™×™×”</label>
                <input type="checkbox" id="c-sugar" class="chip save"><label for="c-sugar" class="lbl">ğŸ­ ×œ×œ× ×¡×•×›×¨</label>
            </div>
        </div>
    </div>

    <div id="scanner-overlay">
        <div id="reader"></div>
        <div class="scan-ui">
            <div style="text-align:center; color:white; margin-top:40px; font-weight:600;">×›×•×•×Ÿ ××ª ×”××¦×œ××” ×œ×‘×¨×§×•×“</div>
            <div class="scan-frame"></div>
            <button class="close-cam" onclick="stopCamera()">×¡×’×•×¨ ××¦×œ××”</button>
        </div>
    </div>

    <div class="action-bar">
        <button class="bar-btn" onclick="manualSearch()">
            <svg class="svg-icon" viewBox="0 0 24 24"><path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg>
        </button>
        <button class="scan-trigger" onclick="startCamera()">
            <svg class="svg-scan" viewBox="0 0 24 24"><path d="M17 3H21C21.5523 3 22 3.44772 22 4V8C22 8.55228 21.5523 9 21 9C20.4477 9 20 8.55228 20 8V5H17C16.4477 5 16 4.55228 16 4C16 3.44772 16.4477 3 17 3ZM7 3H3C2.44772 3 2 3.44772 2 4V8C2 8.55228 2.44772 9 3 9C3.55228 9 4 8.55228 4 8V5H7C7.55228 5 8 4.55228 8 4C8 3.44772 7.55228 3 7 3ZM17 21H21C21.5523 21 22 20.5523 22 20V16C22 15.4477 21.5523 15 21 15C20.4477 15 20 15.4477 20 16V19H17C16.4477 19 16 19.4477 16 20C16 20.5523 16.4477 21 17 21ZM7 21H3C2.44772 21 2 20.5523 2 20V16C2 15.4477 2.44772 15 3 15C3.55228 15 4 15.4477 4 16V19H7C7.55228 19 8 19.4477 8 20C8 20.5523 7.55228 21 7 21ZM2 12C2 11.4477 2.44772 11 3 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H3C2.44772 13 2 12.5523 2 12Z"/></svg>
        </button>
        <button class="bar-btn" onclick="alert('×”×™×¡×˜×•×¨×™×” ×‘×§×¨×•×‘')">
            <svg class="svg-icon" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
        </button>
    </div>

    <div id="settings-layer">
        <div class="set-header">
            <div class="set-title">×”×’×“×¨×•×ª</div>
            <div class="set-close" onclick="toggleSettings()">×¡×’×•×¨</div>
        </div>

        <div class="set-group">
            <div class="set-lbl">×¤×™×–×™×•×œ×•×’×™×”</div>
            <div class="set-row">
                <input type="number" id="u-w" class="clean-inp" placeholder="××©×§×œ">
                <input type="number" id="u-h" class="clean-inp" placeholder="×’×•×‘×”">
            </div>
            <div class="set-row" style="margin-top:10px;">
                <input type="number" id="u-age" class="clean-inp" placeholder="×’×™×œ">
                <select id="u-gender" class="clean-inp"><option value="male">×’×‘×¨</option><option value="female">××™×©×”</option></select>
            </div>
        </div>

        <div class="set-group">
            <div class="set-lbl">××“×“×™× ××ª×§×“××™×</div>
            <div class="set-row">
                <input type="number" id="u-fat" class="clean-inp" placeholder="% ×©×•××Ÿ">
                <input type="number" id="u-visceral" class="clean-inp" placeholder="×©×•××Ÿ ×‘×˜× ×™">
            </div>
            <input type="number" id="u-meta" class="clean-inp" placeholder="×’×™×œ ××˜×‘×•×œ×™" style="margin-top:10px;">
        </div>

        <div class="set-group">
            <div class="set-lbl">××˜×¨×” ×•×¤×¢×™×œ×•×ª</div>
            <select id="u-target" class="clean-inp" style="margin-bottom:10px;">
                <option value="maintain">×©××™×¨×” ×¢×œ ××©×§×œ</option>
                <option value="cut">×—×™×˜×•×‘ (×™×¨×™×“×”)</option>
                <option value="bulk">××¡×” (×¢×œ×™×™×”)</option>
            </select>
            <select id="u-activity" class="clean-inp">
                <option value="1.2">×™×•×©×‘× ×™</option>
                <option value="1.375">×¤×¢×™×œ ×§×œ</option>
                <option value="1.55">×¤×¢×™×œ ×‘×™× ×•× ×™</option>
                <option value="1.725">×¤×¢×™×œ ×××•×“</option>
            </select>
        </div>
        <button onclick="saveProfile()" class="clean-inp" style="background:var(--text); color:black; font-weight:800; margin-top:20px;">×©××•×¨ ×•×—×©×‘ ××—×“×©</button>
    </div>

    <div id="sheet-wrapper">
        <div id="sheet-overlay" onclick="closeSheet()"></div>
        <div id="bottom-sheet">
            <div style="width:40px; height:4px; background:#333; margin:0 auto 20px auto; border-radius:10px;"></div>
            
            <div class="prod-header">
                <img id="p-img" class="prod-thumb" src="" onerror="this.style.display='none'">
                <div style="flex:1">
                    <div id="p-brand" style="font-size:11px; color:#888; font-weight:700;"></div>
                    <div id="p-name" style="font-size:18px; font-weight:800; line-height:1.2;"></div>
                    <div id="p-meta" style="font-size:11px; color:#666; margin-top:5px;"></div>
                </div>
                <div id="p-score" class="score-circle">--</div>
            </div>

            <div id="bio-res" class="analysis-box"></div>
            <div id="filter-res"></div>

            <div class="action-grid">
                <button class="sheet-btn" style="background:#222; color:white;" onclick="runSniper()">ğŸ¯ ×”×©×•×•××ª ××—×™×¨</button>
                <button class="sheet-btn" style="background:rgba(0,230,118,0.2); color:#00e676;" onclick="addToCart()">ğŸ›’ ×”×•×¡×£ ×œ×¡×œ</button>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC VIBE 23.0 ---
        
        let user = { w: 75, h: 175, age: 30, gender: 'male', target: 'maintain', activity: 1.2, tdee: 2000, visceral: 5, metaAge: 30, fat: 18 };
        let currentProd = { exactQuery: '' };
        let cart = 0;

        window.onload = () => { loadUser(); };

        // UI Helpers
        function tog(id) { document.getElementById(id).classList.toggle('open'); }
        function toggleSettings() { document.body.classList.toggle('settings-active'); }
        function closeSheet() { document.getElementById('sheet-wrapper').classList.remove('active-sheet'); }
        const chk = (id) => document.getElementById(id).checked;
        
        // Persistence
        function loadUser() {
            const u = localStorage.getItem('vibe23_user');
            if(u) user = JSON.parse(u);
            updateDash();
            document.querySelectorAll('.save').forEach(el => {
                el.addEventListener('change', () => localStorage.setItem(el.id, el.checked));
                if(localStorage.getItem(el.id) === 'true') el.checked = true;
            });
        }
        
        function saveProfile() {
            const v = (id) => document.getElementById(id).value;
            if(v('u-w')) user.w = Number(v('u-w'));
            if(v('u-h')) user.h = Number(v('u-h'));
            if(v('u-age')) user.age = Number(v('u-age'));
            if(v('u-fat')) user.fat = Number(v('u-fat'));
            if(v('u-visceral')) user.visceral = Number(v('u-visceral'));
            if(v('u-meta')) user.metaAge = Number(v('u-meta'));
            
            user.gender = v('u-gender');
            user.target = v('u-target');
            user.activity = Number(v('u-activity'));
            
            let bmr = 10 * user.w + 6.25 * user.h - 5 * user.age;
            bmr += (user.gender === 'male') ? 5 : -161;
            let tdee = bmr * user.activity;
            if(user.metaAge < user.age) tdee += 100; 
            if(user.target === 'cut') tdee -= 500;
            if(user.target === 'bulk') tdee += 300;
            
            user.tdee = Math.round(tdee);
            localStorage.setItem('vibe23_user', JSON.stringify(user));
            updateDash();
            toggleSettings();
        }

        function updateDash() {
            document.getElementById('d-cals').innerText = user.tdee;
            const m = {cut:'×—×™×˜×•×‘', maintain:'×©××™×¨×”', bulk:'××¡×”'};
            document.getElementById('d-goal').innerText = m[user.target];
        }

        // --- CAMERA ENGINE ---
        const html5QrCode = new Html5Qrcode("reader");

        function startCamera() {
            document.getElementById('scanner-overlay').style.display = 'block';
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 15, qrbox: { width: 250, height: 250 } }, 
                (txt) => { stopCamera(); analyze(txt); }
            ).catch(e => {
                alert("×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ××¦×œ××”.");
                stopCamera();
            });
        }

        function stopCamera() {
            html5QrCode.stop().then(() => {
                document.getElementById('scanner-overlay').style.display = 'none';
            }).catch(() => {
                document.getElementById('scanner-overlay').style.display = 'none';
            });
        }

        function manualSearch() { const c = prompt("×‘×¨×§×•×“:"); if(c) analyze(c); }

        // --- ANALYSIS ENGINE ---
        async function analyze(code) {
            document.getElementById('sheet-wrapper').classList.add('active-sheet');
            document.getElementById('p-name').innerText = "×˜×•×¢×Ÿ...";
            document.getElementById('p-score').innerText = "--";
            
            try {
                const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
                const data = await res.json();
                if(data.status !== 1) throw new Error();
                
                const p = data.product;
                const name = p.product_name_he || p.product_name || "××•×¦×¨ ×›×œ×œ×™";
                const brand = p.brands || "";
                
                currentProd.exactQuery = `${brand} ${name} ${p.quantity || ''}`;
                
                document.getElementById('p-name').innerText = name;
                document.getElementById('p-brand').innerText = brand;
                document.getElementById('p-img').src = p.image_front_small_url || '';
                document.getElementById('p-meta').innerText = `${p.quantity || ''} | ${code}`;

                const n = p.nutriments || {};
                const txt = (p.ingredients_text || "") + (p.labels || "") + (p.categories || "");
                const lowTxt = txt.toLowerCase();
                const tags = (p._keywords || []).join(" ").toLowerCase();
                const additives = (p.additives_tags || []).join(" ");
                
                let score = 100;
                let flags = [];
                let info = [];
                
                const crit = (id, keys, msg) => {
                    if(chk(id)) {
                        for(let k of keys) if(lowTxt.includes(k) || tags.includes(k)) { score=0; flags.push(msg); return; }
                    }
                };
                
                // Allergies
                crit('a-milk', ['milk','lait','×—×œ×‘','whey'], 'â›” ×—×œ×‘');
                crit('a-gluten', ['gluten','wheat','×—×™×˜×”','barley'], 'â›” ×’×œ×•×˜×Ÿ');
                crit('a-nuts', ['nut','almond','××’×•×–','cashew'], 'â›” ××’×•×–×™×');
                crit('a-peanuts', ['peanut','×‘×•×˜× ×™×'], 'â›” ×‘×•×˜× ×™×');
                crit('a-soy', ['soy','×¡×•×™×”'], 'â›” ×¡×•×™×”');
                crit('a-sesame', ['sesame','×©×•××©×•×'], 'â›” ×©×•××©×•×');
                crit('a-eggs', ['egg','oeuf','×‘×™×¦×™×'], 'â›” ×‘×™×¦×™×');
                crit('a-fish', ['fish','×“×’'], 'â›” ×“×’×™×');
                crit('a-sulfites', ['sulfite','e220','e224'], 'â›” ×¡×•×œ×¤×™×˜×™×');

                // Med
                if(chk('d-diabetic') && (n.sugars_100g > 5 || n.carbohydrates_100g > 50)) { score-=50; flags.push("âš ï¸ ×¡×•×›×¨/×¤×—××™××” ×’×‘×•×”×”"); }
                if(chk('d-heart') && (n.salt_100g > 1 || n['saturated-fat_100g'] > 4)) { score-=40; flags.push("âš ï¸ × ×ª×¨×Ÿ/×©×•××Ÿ ×¨×•×•×™"); }
                if(chk('d-celiac') && (lowTxt.includes('wheat') || lowTxt.includes('gluten'))) { score=0; flags.push("â›” ×—×©×© ×’×œ×•×˜×Ÿ"); }
                if(chk('d-gout') && (lowTxt.includes('liver') || lowTxt.includes('yeast'))) { score=0; flags.push("â›” ×¤×•×¨×™× ×™× ×’×‘×•×”×™×"); }
                if(chk('d-kidney') && n.potassium_100g > 0.3) { score-=40; flags.push("âš ï¸ ××©×œ×’×Ÿ ×’×‘×•×”"); }
                if(chk('d-reflux') && (lowTxt.includes('spice') || lowTxt.includes('tomato'))) { score-=30; flags.push("âš ï¸ ×—×•××¦×™×•×ª/×—×¨×™×¤×•×ª"); }
                
                // Sensitive
                if(chk('x-preg') && (lowTxt.includes('caffeine') || lowTxt.includes('alcohol'))) { score=0; flags.push("â›” ×§×¤××™×Ÿ/××œ×›×•×”×•×œ"); }
                if(chk('x-baby') && (n.sugars_100g > 2 || n.salt_100g > 0.5)) { score=0; flags.push("â›” ×œ× ×œ×ª×™× ×•×§×•×ª"); }
                
                // Religion/Values
                if(chk('k-parve') && (lowTxt.includes('milk') || lowTxt.includes('meat'))) { score=0; flags.push("â›” ×œ× ×¤×¨×•×•×”"); }
                if(chk('k-halal') && (lowTxt.includes('pork') || lowTxt.includes('alcohol'))) { score=0; flags.push("â›” ×—×¨××"); }
                if(chk('l-vegan') && (lowTxt.includes('milk') || lowTxt.includes('egg') || lowTxt.includes('honey'))) { score=0; flags.push("â›” ×œ× ×˜×‘×¢×•× ×™"); }
                if(chk('l-paleo') && (lowTxt.includes('sugar') || lowTxt.includes('grain'))) { score=0; flags.push("â›” ×œ× ×¤×œ×™××•"); }
                if(chk('l-keto') && n.carbohydrates_100g > 10) { score=0; flags.push("â›” ×¤×—××™××” ×’×‘×•×”×” (×œ× ×§×˜×•)"); }
                
                if(chk('c-clean') && (additives.includes('e2') || additives.includes('e6'))) { score-=20; flags.push("ğŸ§ª ×ª×•×¡×¤×™× ××œ××›×•×ª×™×™×"); }
                if(chk('k-kosher') && !lowTxt.includes('kosher') && !lowTxt.includes('×›×©×¨')) { score-=10; flags.push("âš ï¸ ××™×Ÿ ×¡×™××•×Ÿ ×›×©×¨×•×ª"); }
                
                // Bio
                const cal = n['energy-kcal_100g'] || 0;
                if(user.target === 'cut' && cal > 280) { score-=30; flags.push(`ğŸ“‰ ×¦×¤×•×£ ×§×œ×•×¨×™×ª (${cal})`); }
                if(user.visceral > 9 && n['saturated-fat_100g'] > 3) { score-=25; flags.push("ğŸ©¸ ×©×•××Ÿ ×‘×˜× ×™ ×’×‘×•×”"); }
                if(user.target === 'bulk' && n.proteins_100g > 10) { score+=10; info.push("ğŸ’ª ×¢×©×™×¨ ×‘×—×œ×‘×•×Ÿ"); }

                // Israel
                if(chk('b-israel')) {
                    if(!code.startsWith('729')) { score-=10; flags.push("ğŸŒ ×™×‘×•×"); }
                    else { score+=5; info.push("ğŸ‡®ğŸ‡± ×ª×•×¦×¨×ª ×”××¨×¥"); }
                }

                if(score<0) score=0; if(score>100) score=100;
                
                // Render
                const el = document.getElementById('p-score');
                el.innerText = score + "%";
                el.style.borderColor = score > 70 ? 'var(--primary)' : (score > 40 ? 'var(--gold)' : 'var(--danger)');
                el.style.color = el.style.borderColor;
                
                document.getElementById('bio-res').innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-weight:700;">
                        <span>${cal} ×§×§"×œ</span>
                        <span>${n.proteins_100g || 0}g ×—×œ×‘×•×Ÿ</span>
                    </div>
                    <div style="font-size:12px; color:#888; margin-top:5px;">××”×•×•×” ${Math.round((cal/user.tdee)*100)}% ××”×ª×§×¦×™×‘ ×”×™×•××™</div>
                `;
                
                let html = "";
                if(flags.length) html += flags.map(f=>`<div style="color:#ff5555; margin-top:5px;">${f}</div>`).join('');
                if(info.length) html += info.map(i=>`<div style="color:#00e676; margin-top:5px;">${i}</div>`).join('');
                if(!html) html = `<div style="color:#00e676; margin-top:5px;">âœ¨ ××•×¦×¨ ×ª×•×× ××•×©×œ×</div>`;
                document.getElementById('filter-res').innerHTML = html;

            } catch(e) { alert("××•×¦×¨ ×œ× × ××¦×"); closeSheet(); }
        }

        function runSniper() {
            window.open(`https://www.google.com/search?tbm=shop&q=${encodeURIComponent(currentProd.exactQuery)}`, '_blank');
        }
        function addToCart() {
            cart++; document.getElementById('d-cart').innerText = cart;
            closeSheet();
        }
    </script>
</body>
</html>
