<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vibe OS TITAN II</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- CORE THEME (PLASMA INDIGO) --- */
        :root {
            --bg-deep: #0f172a;
            --indigo: #6366f1; --cyan: #06b6d4; --fuchsia: #d946ef;
            --grade-a-plus: #00ffaa; --grade-a: #22c55e; 
            --grade-b-plus: #84cc16; /* NEW B+ */
            --grade-b: #a3e635; 
            --grade-c: #facc15; --grade-d: #f97316; --grade-e: #ef4444;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; font-family: var(--font); }
        body { margin: 0; height: 100vh; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; color: #fff; }

        /* ANIMATED BACKGROUND */
        .plasma-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 50% 0%, #1e1b4b, #000); }
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; animation: float 10s infinite alternate; }
        .orb-1 { width: 300px; height: 300px; background: var(--indigo); top: -50px; left: -50px; }
        .orb-2 { width: 400px; height: 400px; background: var(--cyan); bottom: -100px; right: -100px; animation-delay: -5s; }
        @keyframes float { 0% {transform:translate(0,0);} 100% {transform:translate(30px, 50px);} }

        /* FRAME */
        #app-frame { width: 100%; max-width: 440px; height: 100%; max-height: 95vh; background: rgba(15,23,42,0.6); backdrop-filter: blur(30px); border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 60px rgba(99,102,241,0.2); position: relative; }
        @media (max-width: 480px) { #app-frame { max-height: 100vh; border-radius: 0; border: none; } }

        /* HEADER */
        .header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); }
        .logo { font-size: 20px; font-weight: 800; letter-spacing: 1px; }
        .logo span { background: linear-gradient(to right, var(--cyan), var(--indigo)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* CONTENT */
        #content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 140px; scrollbar-width: none; }
        
        /* CARDS */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 18px; display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; transition: 0.2s; cursor: pointer; }
        .card:active { transform: scale(0.98); background: rgba(255,255,255,0.07); }
        .card.full { grid-column: span 2; flex-direction: row; align-items: center; border-left: 4px solid var(--indigo); }
        .c-lbl { font-size: 11px; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .c-val { font-size: 26px; font-weight: 800; margin-top: 5px; }

        /* GAUGE */
        .gauge-wrap { margin-top: 10px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .gauge-bar { height: 100%; width: 100%; background: linear-gradient(90deg, var(--grade-e), var(--grade-a-plus)); transition: width 0.5s; }

        /* DOCK & FAB */
        .dock { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; height: 75px; background: rgba(15,23,42,0.9); backdrop-filter: blur(20px); border-radius: 28px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; padding: 0 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 500; }
        .dock-icon { font-size: 24px; color: #94a3b8; cursor: pointer; transition: 0.2s; }
        .dock-icon:active { color: #fff; transform: scale(0.9); }
        .scan-fab { width: 65px; height: 65px; border-radius: 20px; background: linear-gradient(135deg, var(--indigo), var(--cyan)); display: flex; align-items: center; justify-content: center; font-size: 28px; color: #fff; box-shadow: 0 10px 30px rgba(99,102,241,0.4); margin-top: -40px; cursor: pointer; border: 4px solid #0f172a; transform: rotate(45deg); transition: 0.2s; }
        .scan-fab span { transform: rotate(-45deg); display: block; }
        .scan-fab:active { transform: scale(0.95) rotate(45deg); }

        /* MODALS */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: flex-end; }
        .modal.open { display: flex; animation: fadeIn 0.3s; }
        .sheet { width: 100%; background: #0f172a; border-radius: 40px 40px 0 0; border-top: 1px solid rgba(255,255,255,0.1); max-height: 92vh; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.2, 1); }
        .modal.open .sheet { transform: translateY(0); }
        
        .sheet-head { padding: 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; background: rgba(15,23,42,0.95); z-index: 10; border-radius: 40px 40px 0 0; }
        .sheet-body { padding: 20px 25px; overflow-y: auto; padding-bottom: 100px; }
        .sheet-foot { padding: 20px; background: #0f172a; border-top: 1px solid rgba(255,255,255,0.05); }

        /* HISTORY ANALYTICS STYLES */
        .hist-controls { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .hist-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .hist-inp { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 10px; border-radius: 8px; font-size: 12px; }
        .hist-grades { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .grade-toggle { font-size: 11px; padding: 5px 8px; border-radius: 6px; border: 1px solid #333; cursor: pointer; color: #666; transition: 0.2s; }
        .grade-toggle.active { font-weight: bold; color: #000; border-color: transparent; }
        .agg-switch { display: flex; align-items: center; justify-content: space-between; font-size: 13px; color: var(--cyan); font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        .hist-list { display: flex; flex-direction: column; gap: 8px; }
        .hist-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 12px; border-left: 3px solid #333; }
        .hist-badge { font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; color: #000; margin-left: 8px; }
        .hist-meta { font-size: 10px; color: #666; margin-top: 2px; }
        .hist-count { background: var(--indigo); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 700; }

        /* SETTINGS CHIPS */
        .chip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .chip-lbl { padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; font-size: 13px; color: #94a3b8; cursor: pointer; border: 1px solid transparent; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        input:checked + .chip-lbl { background: rgba(99,102,241,0.15); border-color: var(--indigo); color: #fff; font-weight: 600; }

        /* BUTTONS */
        .btn { width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; margin-top: 8px; }
        .btn-prime { background: linear-gradient(90deg, var(--indigo), var(--cyan)); color: #fff; }
        .btn-sec { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; }

        /* SCANNER */
        #cam-ui { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:2000; display:none; flex-direction:column; }
        #cam-ui.active { display:flex; }
        .laser { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: var(--grade-e); box-shadow: 0 0 20px var(--grade-e); animation: scan 2s infinite; }
        @keyframes scan { 0%{top:20%} 50%{top:80%} 100%{top:20%} }

        /* HELPERS */
        .grade-a-plus { background: var(--grade-a-plus); }
        .grade-a { background: var(--grade-a); }
        .grade-b-plus { background: var(--grade-b-plus); }
        .grade-b { background: var(--grade-b); }
        .grade-c { background: var(--grade-c); }
        .grade-d { background: var(--grade-d); }
        .grade-e { background: var(--grade-e); }
        
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

<div class="plasma-bg"><div class="orb orb-1"></div><div class="orb orb-2"></div></div>

<div id="app-frame">
    <div class="header">
        <div class="logo">VIBE <span>TITAN II</span></div>
        <div onclick="openModal('m-settings')" style="cursor:pointer; padding:5px;">âš™ï¸</div>
    </div>

    <div id="content">
        <div class="dashboard">
            <div class="card full">
                <div>
                    <div class="c-lbl">××©×ª××©</div>
                    <div id="dash-name" class="c-val" style="font-size:22px;">××•×¨×—</div>
                </div>
                <div id="dash-filters" style="font-size:12px; color:var(--cyan); max-width:150px; text-align:left;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
            </div>
            
            <div class="card" onclick="openModal('m-ring')">
                <div class="c-lbl">Vibe Ring</div>
                <div id="dash-status" class="c-val" style="color:var(--grade-a);">×¨×’×™×œ</div>
            </div>

            <div class="card" onclick="openModal('m-cart')">
                <div style="display:flex; justify-content:space-between;">
                    <div class="c-lbl">×¦×™×•×Ÿ ×¡×œ</div>
                    <div id="dash-score" style="font-weight:800; font-size:18px;">100%</div>
                </div>
                <div class="gauge-wrap"><div id="score-bar" class="gauge-bar"></div></div>
                <div style="font-size:11px; color:#94a3b8; margin-top:5px;">×¤×¨×™×˜×™×: <span id="dash-count">0</span></div>
            </div>
        </div>

        <div style="text-align:center; color:#666; font-size:12px; margin-top:20px;">×”××¢×¨×›×ª ××•×›× ×” ×œ×¡×¨×™×§×”</div>
    </div>

    <div class="dock">
        <div class="dock-icon" onclick="openModal('m-cart')">ğŸ›’</div>
        <div class="scan-fab" onclick="startScanner()"><span>ğŸ“·</span></div>
        <div class="dock-icon" onclick="openHistory()">ğŸ“œ</div>
    </div>

    <div id="m-history" class="modal"><div class="sheet" style="height:90vh;">
        <div class="sheet-head"><div class="logo">×”×™×¡×˜×•×¨×™×” ×—×›××”</div><div onclick="closeModal('m-history')" style="cursor:pointer;">âœ•</div></div>
        <div class="sheet-body">
            <div class="hist-controls">
                <div class="hist-row">
                    <input type="date" id="hist-start" class="hist-inp" onchange="filterHistory()">
                    <input type="date" id="hist-end" class="hist-inp" onchange="filterHistory()">
                </div>
                <div class="hist-row">
                    <input type="text" id="hist-search" class="hist-inp" placeholder="×—×¤×© ××•×¦×¨ ××• ××•×ª×’..." onkeyup="filterHistory()">
                </div>
                <div class="hist-grades" id="hist-grade-filters">
                    </div>
                <div class="agg-switch" onclick="toggleAggregation()">
                    <span>ğŸ“‚ ×¦××¦× ×¤×¨×™×˜×™× ×–×”×™× (Aggregation)</span>
                    <span id="agg-status" style="color:#666;">OFF</span>
                </div>
            </div>
            
            <div id="hist-list" class="hist-list">
                </div>
        </div>
    </div></div>

    <div id="m-settings" class="modal"><div class="sheet">
        <div class="sheet-head"><div class="logo">×”×’×“×¨×•×ª ×¤×¨×•×¤×™×œ</div><div onclick="closeModal('m-settings')" style="cursor:pointer;">âœ•</div></div>
        <div class="sheet-body">
            <input type="text" id="user-name-inp" placeholder="×©×" style="width:100%; padding:15px; background:rgba(255,255,255,0.05); border:none; border-radius:12px; color:#fff; margin-bottom:20px;">
            
            <div style="color:var(--cyan); font-weight:700; margin:15px 0;">ğŸ… ×“×™×¨×•×’ ××™× ×™××œ×™ (××™×›×•×ª)</div>
            <div class="chip-grid">
                <input type="checkbox" id="q-aplus"><label for="q-aplus" class="chip-lbl">A+ ×‘×œ×‘×“</label>
                <input type="checkbox" id="q-green"><label for="q-green" class="chip-lbl">âœ… ×ª×• ×™×¨×•×§</label>
                <input type="checkbox" id="q-natural"><label for="q-natural" class="chip-lbl">ğŸƒ 100% ×˜×‘×¢×™</label>
            </div>

            <div style="color:var(--grade-e); font-weight:700; margin:15px 0;">âš ï¸ ××œ×¨×’×™×•×ª</div>
            <div class="chip-grid">
                <input type="checkbox" id="a-milk"><label for="a-milk" class="chip-lbl">×—×œ×‘</label>
                <input type="checkbox" id="a-gluten"><label for="a-gluten" class="chip-lbl">×’×œ×•×˜×Ÿ</label>
                <input type="checkbox" id="a-nuts"><label for="a-nuts" class="chip-lbl">××’×•×–×™×</label>
                <input type="checkbox" id="a-soy"><label for="a-soy" class="chip-lbl">×¡×•×™×”</label>
            </div>

            <div style="color:var(--indigo); font-weight:700; margin:15px 0;">ğŸ¥— ××•×¨×— ×—×™×™×</div>
            <div class="chip-grid">
                <input type="checkbox" id="l-vegan"><label for="l-vegan" class="chip-lbl">×˜×‘×¢×•× ×™</label>
                <input type="checkbox" id="l-keto"><label for="l-keto" class="chip-lbl">×§×˜×•</label>
            </div>
        </div>
        <div class="sheet-foot">
            <button class="btn btn-prime" onclick="saveSettings()">×©××•×¨ ×©×™× ×•×™×™×</button>
        </div>
    </div></div>

    <div id="cam-ui">
        <div id="reader" style="width:100%; height:100%; object-fit:cover;"></div>
        <div class="laser"></div>
        <div style="position:absolute; bottom:50px; width:100%; display:flex; justify-content:center;">
            <button onclick="stopScanner()" style="background:rgba(0,0,0,0.6); color:#fff; border:1px solid #fff; padding:10px 30px; border-radius:30px; font-weight:700; cursor:pointer;">×‘×™×˜×•×œ ×—×–×¨×”</button>
        </div>
    </div>

    <div id="m-result" class="modal"><div class="sheet">
        <div class="sheet-head"><div class="logo">×ª×•×¦××•×ª</div><div onclick="closeModal('m-result')" style="cursor:pointer;">âœ•</div></div>
        <div class="sheet-body" style="text-align:center;">
            <div style="font-size:12px; color:#888; text-transform:uppercase; letter-spacing:2px;">×¦×™×•×Ÿ ××©×•×§×œ×œ</div>
            <div id="res-grade" style="font-size:80px; font-weight:900; margin:10px 0; text-shadow:0 0 30px currentColor;">A+</div>
            <h2 id="res-name" style="margin:0;">×©× ××•×¦×¨</h2>
            <div id="res-brand" style="color:#888; margin-bottom:20px;">××•×ª×’</div>
            <div id="res-reasons" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; text-align:right;"></div>
        </div>
        <div class="sheet-foot" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn btn-prime" onclick="addToCart(true)">+ ×œ×‘×™×ª</button>
            <button class="btn btn-sec" onclick="addToCart(false)">+ ×œ×™</button>
        </div>
    </div></div>

    <div id="m-cart" class="modal"><div class="sheet">
        <div class="sheet-head"><div class="logo">×¢×’×œ×”</div><div onclick="closeModal('m-cart')" style="cursor:pointer;">âœ•</div></div>
        <div class="sheet-body" id="cart-list"></div>
        <div class="sheet-foot">
            <button class="btn btn-sec" onclick="clearCart()">×¨×•×§×Ÿ ×¢×’×œ×”</button>
        </div>
    </div></div>

    <div id="m-ring" class="modal"><div class="sheet">
        <div class="sheet-head"><div class="logo">Vibe Ring</div><div onclick="closeModal('m-ring')" style="cursor:pointer;">âœ•</div></div>
        <div class="sheet-body">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn btn-sec" onclick="setRing('normal')">ğŸŸ¢ ×¨×’×™×œ</button>
                <button class="btn btn-sec" onclick="setRing('stress')">ğŸ¤¯ ×¡×˜×¨×¡</button>
                <button class="btn btn-sec" onclick="setRing('sugar')">ğŸ©¸ ×¡×•×›×¨</button>
                <button class="btn btn-sec" onclick="setRing('sick')">ğŸ¤’ ×—×•×œ×™</button>
            </div>
        </div>
    </div></div>

</div>

<script>
    // --- 1. CONFIG & DB ENGINE ---
    const GRADES = ['A+', 'A', 'B+', 'B', 'C', 'D', 'E'];
    const G_COLORS = {'A+':'var(--grade-a-plus)', 'A':'var(--grade-a)', 'B+':'var(--grade-b-plus)', 'B':'var(--grade-b)', 'C':'var(--grade-c)', 'D':'var(--grade-d)', 'E':'var(--grade-e)'};
    
    // Simulating 1000+ Items via procedural generation for the demo
    const BASE_ITEMS = [
        {n:'×œ×—× ××œ×', cat:'bakery', g:'A', tags:['gl']}, {n:'×œ×—× ×œ×‘×Ÿ', cat:'bakery', g:'C', tags:['gl','sug']},
        {n:'×—×œ×‘ 3%', cat:'dairy', g:'B', tags:['da']}, {n:'×—×œ×‘ ×¡×•×™×”', cat:'dairy', g:'A', tags:['soy']},
        {n:'×§×•×˜×’\'', cat:'dairy', g:'A', tags:['da']}, {n:'×’×‘×™× ×” ×¦×”×•×‘×”', cat:'dairy', g:'D', tags:['da','proc']},
        {n:'××™×œ×§×™', cat:'dairy', g:'E', tags:['da','sug']}, {n:'×§×•×œ×”', cat:'drink', g:'E', tags:['sug','caff']},
        {n:'×§×•×œ×” ×–×™×¨×•', cat:'drink', g:'D', tags:['caff']}, {n:'×‘××‘×”', cat:'snack', g:'C', tags:['nut']},
        {n:'×©×•×§×•×œ×“', cat:'snack', g:'E', tags:['sug','da']}, {n:'××œ×¤×¤×•×Ÿ', cat:'fresh', g:'A+', tags:[]},
        {n:'×¢×’×‘× ×™×”', cat:'fresh', g:'A+', tags:[]}, {n:'×˜×•× ×” ×‘××™×', cat:'pantry', g:'A', tags:['fish']},
        {n:'×¤×¡×˜×”', cat:'pantry', g:'B', tags:['gl']}, {n:'× ×§× ×™×§×™×•×ª', cat:'frozen', g:'E', tags:['proc','meat']},
        {n:'×©× ×™×¦×œ ×ª×™×¨×¡', cat:'frozen', g:'C', tags:['gl','proc']}, {n:'×—×•××•×¡', cat:'pantry', g:'B+', tags:[]}
    ];
    const BRANDS = ['×ª× ×•×‘×”', '×©×˜×¨××•×¡', '××¡×', '×¢×œ×™×ª', '×˜×¨×”', '×¨××™ ×œ×•×™', '×©×•×¤×¨×¡×œ', '×’×“', '×•×™×¡×•×¦×§×™', '×˜×‘×¢×•×œ'];

    // --- 2. STATE ---
    let user = { name:'××•×¨×—', filters:[] };
    let cart = [];
    let history = [];
    let isAggregated = false;
    let selectedGrades = []; // for filtering history
    let scanner = null;
    let currentProduct = null;
    let ringStatus = 'normal';

    // --- 3. INIT ---
    window.onload = () => {
        loadData();
        if(history.length === 0) generateMockHistory(); // MOCK DATA FOR DEMO
        renderUI();
        initHistoryFilters();
    };

    function loadData() {
        const u = localStorage.getItem('vTitan2_user');
        if(u) user = JSON.parse(u);
        const c = localStorage.getItem('vTitan2_cart');
        if(c) cart = JSON.parse(c);
        const h = localStorage.getItem('vTitan2_hist');
        if(h) history = JSON.parse(h);
    }

    function saveData() {
        localStorage.setItem('vTitan2_user', JSON.stringify(user));
        localStorage.setItem('vTitan2_cart', JSON.stringify(cart));
        localStorage.setItem('vTitan2_hist', JSON.stringify(history));
        renderUI();
    }

    // --- 4. MOCK HISTORY GENERATOR (To show off analytics) ---
    function generateMockHistory() {
        const now = new Date();
        for(let i=0; i<50; i++) {
            const item = BASE_ITEMS[Math.floor(Math.random() * BASE_ITEMS.length)];
            const brand = BRANDS[Math.floor(Math.random() * BRANDS.length)];
            const daysBack = Math.floor(Math.random() * 180); // Last 6 months
            const date = new Date();
            date.setDate(now.getDate() - daysBack);
            
            history.push({
                n: item.n,
                b: brand,
                g: item.g, // Initial grade
                t: date.toISOString(),
                id: Date.now() + Math.random()
            });
        }
        history.sort((a,b) => new Date(b.t) - new Date(a.t)); // Sort new to old
        saveData();
    }

    // --- 5. RENDER UI ---
    function renderUI() {
        document.getElementById('dash-name').innerText = user.name;
        document.getElementById('dash-filters').innerText = user.filters.length + ' ×”×’×“×¨×•×ª ×¤×¢×™×œ×•×ª';
        document.getElementById('dash-count').innerText = cart.length;
        document.getElementById('dash-status').innerText = ringStatus === 'normal' ? '×¨×’×™×œ' : (ringStatus==='stress'?'×¡×˜×¨×¡ ğŸ¤¯':'×—×•×œ×™ ğŸ¤’');
        
        // Cart Score Calculation
        let score = 100;
        if(cart.length > 0) {
            let total = 0;
            cart.forEach(i => {
                if(i.g === 'A+') total+=100;
                else if(i.g === 'A') total+=90;
                else if(i.g === 'B+') total+=85;
                else if(i.g === 'B') total+=75;
                else if(i.g === 'C') total+=60;
                else if(i.g === 'D') total+=40;
                else total+=20;
            });
            score = Math.round(total / cart.length);
        }
        document.getElementById('dash-score').innerText = score + '%';
        const bar = document.getElementById('score-bar');
        bar.style.width = score + '%';
        if(score >= 85) bar.style.background = 'var(--grade-a-plus)';
        else if(score >= 70) bar.style.background = 'var(--grade-b)';
        else if(score >= 50) bar.style.background = 'var(--grade-c)';
        else bar.style.background = 'var(--grade-e)';
        
        renderCart();
    }

    function renderCart() {
        const con = document.getElementById('cart-list');
        con.innerHTML = cart.map((i, idx) => `
            <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid rgba(255,255,255,0.05);">
                <div><span style="color:${G_COLORS[i.g]}; font-weight:bold;">${i.g}</span> ${i.n}</div>
                <div style="cursor:pointer; color:#ef4444;" onclick="remCart(${idx})">âœ•</div>
            </div>
        `).join('');
    }

    // --- 6. HISTORY ANALYTICS LOGIC (THE REQUESTED FEATURE) ---
    function initHistoryFilters() {
        const con = document.getElementById('hist-grade-filters');
        let html = '';
        GRADES.forEach(g => {
            html += `<div class="grade-toggle" onclick="toggleGradeFilter(this, '${g}')">${g}</div>`;
        });
        con.innerHTML = html;
        // Set Default dates (Last 6 months)
        const end = new Date();
        const start = new Date();
        start.setMonth(start.getMonth() - 6);
        document.getElementById('hist-end').valueAsDate = end;
        document.getElementById('hist-start').valueAsDate = start;
    }

    function toggleGradeFilter(el, g) {
        el.classList.toggle('active');
        if(selectedGrades.includes(g)) selectedGrades = selectedGrades.filter(x => x!==g);
        else selectedGrades.push(g);
        filterHistory();
    }

    function toggleAggregation() {
        isAggregated = !isAggregated;
        document.getElementById('agg-status').innerText = isAggregated ? 'ON' : 'OFF';
        document.getElementById('agg-status').style.color = isAggregated ? 'var(--cyan)' : '#666';
        filterHistory();
    }

    function filterHistory() {
        const search = document.getElementById('hist-search').value.toLowerCase();
        const start = new Date(document.getElementById('hist-start').value).getTime();
        const end = new Date(document.getElementById('hist-end').value).getTime() + 86400000; // End of day

        let filtered = history.filter(item => {
            const t = new Date(item.t).getTime();
            const matchDate = t >= start && t <= end;
            const matchSearch = item.n.includes(search) || item.b.includes(search);
            const matchGrade = selectedGrades.length === 0 || selectedGrades.includes(item.g);
            return matchDate && matchSearch && matchGrade;
        });

        const list = document.getElementById('hist-list');
        
        if (isAggregated) {
            // AGGREGATION LOGIC
            const agg = {};
            filtered.forEach(item => {
                const key = item.n + '|' + item.b + '|' + item.g;
                if(!agg[key]) agg[key] = { ...item, count: 0 };
                agg[key].count++;
            });
            
            list.innerHTML = Object.values(agg).map(i => `
                <div class="hist-item">
                    <div>
                        <span style="font-weight:bold;">${i.n}</span>
                        <span class="hist-badge" style="background:${G_COLORS[i.g]}">${i.g}</span>
                        <div class="hist-meta">${i.b}</div>
                    </div>
                    <div class="hist-count">x${i.count}</div>
                </div>
            `).join('');
        } else {
            // STANDARD LIST
            list.innerHTML = filtered.map(i => `
                <div class="hist-item">
                    <div>
                        <span>${i.n}</span>
                        <span class="hist-badge" style="background:${G_COLORS[i.g]}">${i.g}</span>
                        <div class="hist-meta">${i.b} â€¢ ${new Date(i.t).toLocaleDateString()}</div>
                    </div>
                </div>
            `).join('');
        }
    }

    // --- 7. SCANNER & ALGORITHM ---
    function startScanner() {
        document.getElementById('m-scan').classList.add('open');
        document.getElementById('cam-ui').classList.add('active');
        
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decoded) => { handleScanResult(); }, 
            (err) => {}
        ).catch(err => { 
            console.log("Cam error, simulating..."); 
            setTimeout(handleScanResult, 1500); 
        });
    }

    function stopScanner() {
        if(scanner) { scanner.stop().then(()=>scanner.clear()).catch(e=>{}); }
        document.getElementById('m-scan').classList.remove('open');
        document.getElementById('cam-ui').classList.remove('active');
    }

    function handleScanResult() {
        stopScanner();
        // Simulate DB Fetch
        const base = BASE_ITEMS[Math.floor(Math.random() * BASE_ITEMS.length)];
        const brand = BRANDS[Math.floor(Math.random() * BRANDS.length)];
        const product = { ...base, brand: brand };
        
        gradeProduct(product);
    }

    function gradeProduct(p) {
        let g = p.g;
        let reasons = [];

        // Logic (Filters vs Tags)
        if(user.filters.includes('a-gluten') && p.tags.includes('gl')) { g='E'; reasons.push('×’×œ×•×˜×Ÿ'); }
        if(user.filters.includes('a-milk') && p.tags.includes('da')) { g='E'; reasons.push('×—×œ×‘'); }
        if(user.filters.includes('l-vegan') && (p.tags.includes('da') || p.tags.includes('meat') || p.tags.includes('eggs'))) { g='E'; reasons.push('×œ× ×˜×‘×¢×•× ×™'); }
        if(user.filters.includes('q-green') && (p.tags.includes('proc') || p.tags.includes('sug'))) { g='D'; reasons.push('××™× ×• ×ª×• ×™×¨×•×§'); }
        
        // Ring Influence
        if(g !== 'E') {
            if(ringStatus === 'stress' && p.tags.includes('sug')) { g='D'; reasons.push('×¡×•×›×¨ (×¡×˜×¨×¡)'); }
            if(ringStatus === 'sick' && p.tags.includes('da')) { g='D'; reasons.push('×—×œ×‘ (×œ×™×—×”)'); }
            if(ringStatus === 'sugar' && p.tags.includes('sug')) { 
                reasons.push('×˜×•×‘ ×œ× ×¤×™×œ×ª ×¡×•×›×¨'); 
                // Upgrade grade logic
                if(g==='C') g='B'; else if(g==='B') g='A';
            }
        }

        currentProduct = { ...p, g: g };
        
        // UI
        const elG = document.getElementById('res-grade');
        elG.innerText = g;
        elG.style.color = G_COLORS[g];
        elG.style.boxShadow = `0 0 50px ${G_COLORS[g]}`;
        document.getElementById('res-name').innerText = p.n;
        document.getElementById('res-brand').innerText = p.brand;
        document.getElementById('res-reasons').innerHTML = reasons.length ? reasons.map(r=>`<div>â€¢ ${r}</div>`).join('') : '××•×¦×¨ ×ª×•××';
        
        openModal('m-result');
    }

    function addToCart(home) {
        if(!currentProduct) return;
        const item = { ...currentProduct, u: home?'×‘×™×ª':'×× ×™', t: new Date().toISOString() };
        cart.push(item);
        history.unshift(item); // Add to history as well
        saveData();
        closeModal('m-result');
    }

    // --- 8. HELPERS ---
    function openModal(id) { document.getElementById(id).classList.add('open'); if(id==='m-history') filterHistory(); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function remCart(i) { cart.splice(i,1); saveData(); renderCart(); }
    function clearCart() { if(confirm('×œ×¨×•×§×Ÿ?')) { cart=[]; saveData(); closeModal('m-cart'); } }
    function setRing(s) { ringStatus=s; saveData(); closeModal('m-ring'); }
    function saveSettings() {
        user.name = document.getElementById('user-name-inp').value || user.name;
        user.filters = [];
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(c => user.filters.push(c.id));
        saveData(); closeModal('m-settings');
    }
    function openHistory() { openModal('m-history'); }

</script>
</body>
</html>
